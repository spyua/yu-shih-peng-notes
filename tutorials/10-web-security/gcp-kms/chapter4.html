<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ch.4 ç¨‹å¼å¯¦ä½œ â€” GCP KMS éå°ç¨±åŠ å¯†æ•™å­¸</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&family=JetBrains+Mono:wght@400;500;600&family=Crimson+Pro:ital,wght@0,400;0,700;0,900;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #F6F3EE;
  --bg-warm: #EFEADF;
  --bg-card: #FFFFFF;
  --bg-dark: #16161D;
  --bg-code: #111118;
  --text: #2A2A35;
  --text-secondary: #5E5E6E;
  --text-muted: #9494A3;
  --accent: #D35233;
  --accent-hover: #B8432A;
  --accent-soft: #FADAD2;
  --teal: #1A9E8F;
  --teal-soft: #D0F0EA;
  --blue: #2563EB;
  --blue-soft: #DBEAFE;
  --gold: #C88B2E;
  --gold-soft: #FDF3DC;
  --border: #E0DCD4;
  --border-light: #EDEAE4;
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.04);
  --shadow: 0 2px 8px rgba(0,0,0,0.05), 0 1px 2px rgba(0,0,0,0.04);
  --shadow-lg: 0 8px 30px rgba(0,0,0,0.08), 0 2px 6px rgba(0,0,0,0.04);
  --radius: 14px;
  --radius-sm: 8px;
  --content-width: 760px;
}
* { margin:0; padding:0; box-sizing:border-box; }
html { scroll-behavior: smooth; }
body { font-family:'Noto Sans TC',sans-serif; background:var(--bg); color:var(--text); line-height:1.85; font-size:16px; -webkit-font-smoothing:antialiased; }

/* NAV */
.topnav { position:sticky; top:0; z-index:100; background:rgba(246,243,238,0.85); backdrop-filter:blur(16px) saturate(1.4); border-bottom:1px solid var(--border); padding:0 24px; }
.topnav-inner { max-width:var(--content-width); margin:0 auto; display:flex; align-items:center; height:56px; gap:24px; }
.topnav-brand { font-weight:900; font-size:14px; color:var(--accent); letter-spacing:-0.02em; text-decoration:none; white-space:nowrap; }
.topnav-chapters { display:flex; gap:2px; flex:1; justify-content:center; }
.topnav-ch { padding:6px 14px; font-size:13px; font-weight:600; color:var(--text-muted); text-decoration:none; border-radius:100px; transition:all 0.15s; white-space:nowrap; }
.topnav-ch:hover { color:var(--text); background:var(--bg-warm); }
.topnav-ch.active { color:var(--accent); background:var(--accent-soft); }
.topnav-progress { display:flex; gap:6px; align-items:center; }
.topnav-dot { width:8px; height:8px; border-radius:50%; background:var(--border); }
.topnav-dot.filled { background:var(--accent); }
.topnav-dot.current { background:var(--accent); box-shadow:0 0 0 3px var(--accent-soft); }
@media (max-width:700px) { .topnav-chapters { display:none; } }

/* HERO */
.ch-hero { padding:72px 24px 56px; position:relative; overflow:hidden; }
.ch-hero::after { content:''; position:absolute; bottom:0; left:0; right:0; height:1px; background:var(--border); }
.ch-hero-inner { max-width:var(--content-width); margin:0 auto; }
.ch-number { font-family:'Crimson Pro',serif; font-size:80px; font-weight:900; color:var(--accent); line-height:1; opacity:0.12; position:absolute; top:30px; right:max(24px,calc((100% - var(--content-width))/2)); user-select:none; }
.ch-overline { font-size:12px; font-weight:700; text-transform:uppercase; letter-spacing:0.15em; color:var(--accent); margin-bottom:12px; }
.ch-title { font-family:'Crimson Pro',serif; font-size:clamp(2rem,4.5vw,2.8rem); font-weight:900; line-height:1.25; margin-bottom:14px; color:var(--bg-dark); }
.ch-desc { font-size:17px; color:var(--text-secondary); max-width:560px; }

/* MAIN */
.main { max-width:var(--content-width); margin:0 auto; padding:48px 24px 80px; }
.section { margin-bottom:72px; scroll-margin-top:72px; }
h2 { font-family:'Crimson Pro',serif; font-size:26px; font-weight:900; color:var(--bg-dark); margin-bottom:8px; line-height:1.3; }
.section-rule { width:40px; height:3px; background:var(--accent); border-radius:2px; margin-bottom:20px; }
h3 { font-size:19px; font-weight:700; margin:40px 0 12px; color:var(--bg-dark); }
h3:first-of-type { margin-top:24px; }
p { margin-bottom:16px; }
code { font-family:'JetBrains Mono',monospace; background:var(--bg-warm); padding:2px 7px; border-radius:5px; font-size:0.87em; color:var(--accent); font-weight:500; }

/* Callouts */
.callout { border-radius:var(--radius); padding:24px 24px 24px 64px; margin:28px 0; position:relative; font-size:15px; }
.callout::before { position:absolute; left:22px; top:22px; font-size:24px; }
.callout .callout-title { font-weight:700; font-size:14px; margin-bottom:6px; }
.callout p { margin-bottom:8px; }
.callout p:last-child { margin-bottom:0; }
.callout-analogy { background:var(--gold-soft); border:1px solid #ECD9A8; }
.callout-analogy::before { content:'ğŸ’¡'; }
.callout-analogy .callout-title { color:#8B6914; }
.callout-analogy p { color:#6B5420; }
.callout-warning { background:#FEF2F2; border:1px solid #FECACA; }
.callout-warning::before { content:'âš ï¸'; }
.callout-warning p { color:#991B1B; }
.callout-tip { background:var(--teal-soft); border:1px solid #A7E8D8; }
.callout-tip::before { content:'âœ…'; }
.callout-tip .callout-title { color:#065F46; }
.callout-tip p { color:#065F46; }

/* Tables */
.table-wrap { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius); overflow:hidden; margin:28px 0; box-shadow:var(--shadow-sm); }
.table-wrap table { width:100%; border-collapse:collapse; font-size:14.5px; }
.table-wrap th { background:var(--bg-dark); color:#fff; padding:13px 18px; text-align:left; font-weight:600; font-size:13px; }
.table-wrap td { padding:13px 18px; border-bottom:1px solid var(--border-light); vertical-align:top; }
.table-wrap tr:last-child td { border-bottom:none; }
.table-wrap tr:hover td { background:#FDFCFA; }
.tag { display:inline-block; padding:2px 10px; border-radius:6px; font-size:12px; font-weight:600; }
.tag-green { background:#D1FAE5; color:#065F46; }
.tag-blue { background:#DBEAFE; color:#1E40AF; }
.tag-orange { background:#FED7AA; color:#9A3412; }
.tag-red { background:#FEE2E2; color:#991B1B; }

/* Code blocks */
.code-block { background:var(--bg-code); border-radius:12px; margin:24px 0; overflow:hidden; }
.code-header { display:flex; align-items:center; justify-content:space-between; padding:10px 20px; background:rgba(255,255,255,0.04); border-bottom:1px solid rgba(255,255,255,0.06); }
.code-header .code-lang { font-size:12px; font-weight:600; color:var(--teal); font-family:'JetBrains Mono',monospace; }
.code-header .code-file { font-size:11px; color:rgba(255,255,255,0.35); font-family:'JetBrains Mono',monospace; }
.code-header .copy-btn { background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.1); color:rgba(255,255,255,0.5); padding:4px 12px; border-radius:6px; cursor:pointer; font-size:12px; font-family:'Noto Sans TC',sans-serif; transition:all 0.15s; }
.copy-btn:hover { background:rgba(255,255,255,0.14); color:#fff; }
.code-body { padding:20px; overflow-x:auto; }
.code-body pre { font-family:'JetBrains Mono',monospace; font-size:12.5px; line-height:1.7; color:#E2E8F0; white-space:pre; margin:0; }
.cm { color:#6B7280; }
.kw { color:#C084FC; }
.str { color:#34D399; }
.ann { color:#F59E0B; }
.typ { color:#60A5FA; }
.num { color:#FB923C; }

/* File tree */
.file-tree {
  background:var(--bg-card); border:1px solid var(--border);
  border-radius:var(--radius); padding:20px 24px; margin:28px 0;
  font-family:'JetBrains Mono',monospace; font-size:13px; line-height:2;
}
.file-tree .dir { color:var(--blue); font-weight:600; }
.file-tree .file { color:var(--text-secondary); }
.file-tree .hl { color:var(--accent); font-weight:600; }

/* SOP steps */
.sop-timeline { position:relative; padding-left:36px; margin:28px 0; }
.sop-timeline::before { content:''; position:absolute; left:14px; top:8px; bottom:8px; width:2px; background:var(--border); }
.sop-step { position:relative; margin-bottom:24px; }
.sop-step:last-child { margin-bottom:0; }
.sop-dot { position:absolute; left:-36px; top:4px; width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:13px; font-weight:800; color:#fff; }
.sop-dot.red { background:var(--accent); }
.sop-dot.blue { background:var(--blue); }
.sop-dot.teal { background:var(--teal); }
.sop-dot.gold { background:var(--gold); }
.sop-step h4 { font-size:15px; font-weight:700; margin-bottom:4px; }
.sop-step p { font-size:14px; color:var(--text-secondary); margin-bottom:0; }

/* Cache diagram */
.cache-flow {
  background:var(--bg-card); border:1px solid var(--border);
  border-radius:var(--radius); padding:32px; margin:28px 0;
  text-align:center; box-shadow:var(--shadow-sm);
}
.cache-flow .cf-label { font-size:12px; font-weight:700; text-transform:uppercase; letter-spacing:0.1em; color:var(--text-muted); margin-bottom:20px; }
.cf-row { display:flex; align-items:center; justify-content:center; gap:10px; flex-wrap:wrap; margin:12px 0; }
.cf-box { padding:12px 18px; border-radius:10px; font-size:13px; font-weight:600; min-width:100px; }
.cf-box.req { background:var(--blue-soft); color:#1E40AF; border:1px solid #93C5FD; }
.cf-box.cache-hit { background:#D1FAE5; color:#065F46; border:1px solid #6EE7B7; }
.cf-box.cache-miss { background:#FEF3C7; color:#92400E; border:1px solid #FCD34D; }
.cf-box.kms { background:var(--bg-dark); color:#fff; border:1px solid #374151; }
.cf-box.result { background:var(--teal-soft); color:#065F46; border:1px solid #A7E8D8; }
.cf-arrow { font-size:18px; color:var(--text-muted); flex-shrink:0; }

/* Completion */
.complete-banner {
  background:linear-gradient(135deg,var(--teal-soft),#D1FAE5);
  border:2px solid #6EE7B7; border-radius:var(--radius);
  padding:36px; text-align:center; margin:48px 0 0;
}
.complete-banner .cb-icon { font-size:40px; margin-bottom:12px; }
.complete-banner h3 { font-family:'Crimson Pro',serif; font-size:24px; font-weight:900; color:#065F46; margin:0 0 8px; }
.complete-banner p { color:#047857; margin-bottom:0; font-size:15px; }

/* Chapter nav */
.ch-nav { display:flex; justify-content:space-between; align-items:stretch; gap:16px; padding-top:48px; border-top:1px solid var(--border); margin-top:72px; }
.ch-nav-link { display:flex; flex-direction:column; gap:4px; text-decoration:none; padding:20px 24px; border:1px solid var(--border); border-radius:var(--radius); background:var(--bg-card); transition:all 0.2s; flex:1; max-width:48%; }
.ch-nav-link:hover { border-color:var(--accent); box-shadow:var(--shadow); transform:translateY(-2px); }
.ch-nav-link.next { text-align:right; margin-left:auto; }
.ch-nav-label { font-size:12px; font-weight:600; text-transform:uppercase; letter-spacing:0.1em; color:var(--accent); }
.ch-nav-title { font-weight:700; font-size:15px; color:var(--text); }

.footer { text-align:center; padding:32px 24px; font-size:12.5px; color:var(--text-muted); border-top:1px solid var(--border); max-width:var(--content-width); margin:0 auto; }

.fade-in { opacity:0; transform:translateY(24px); transition:opacity 0.5s ease, transform 0.5s ease; }
.fade-in.visible { opacity:1; transform:translateY(0); }
.fade-in.visible:nth-child(2) { transition-delay:0.06s; }
.fade-in.visible:nth-child(3) { transition-delay:0.12s; }
.fade-in.visible:nth-child(4) { transition-delay:0.18s; }
.fade-in.visible:nth-child(5) { transition-delay:0.24s; }

@media (max-width:640px) {
  .cf-row { flex-direction:column; }
  .cf-arrow { transform:rotate(90deg); }
  .ch-nav { flex-direction:column; }
  .ch-nav-link { max-width:100%; }
  .ch-number { display:none; }
}
</style>
</head>
<body>

<nav class="topnav">
  <div class="topnav-inner">
    <a class="topnav-brand" href="../../../index.html">â† è¿”å›é¦–é </a>
    <div class="topnav-chapters">
      <a class="topnav-ch" href="chapter1.html">Ch.1 åŸºç¤è§€å¿µ</a>
      <a class="topnav-ch" href="chapter2.html">Ch.2 æ¶æ§‹èˆ‡æµç¨‹</a>
      <a class="topnav-ch" href="chapter3.html">Ch.3 å‹•æ‰‹å¯¦ä½œ</a>
      <a class="topnav-ch active" href="chapter4.html">Ch.4 ç¨‹å¼å¯¦ä½œ</a>
    </div>
    <div class="topnav-progress">
      <div class="topnav-dot filled"></div>
      <div class="topnav-dot filled"></div>
      <div class="topnav-dot filled"></div>
      <div class="topnav-dot current"></div>
    </div>
  </div>
</nav>

<header class="ch-hero">
  <div class="ch-number">04</div>
  <div class="ch-hero-inner">
    <div class="ch-overline">Chapter 4 of 4</div>
    <h1 class="ch-title">ç¨‹å¼å¯¦ä½œ</h1>
    <p class="ch-desc">Spring Boot å®Œæ•´ç¨‹å¼ç¢¼ã€çµ¦å» å•†çš„åŠ å¯†ç¯„ä¾‹ã€Cache ç­–ç•¥ã€ä»¥åŠé‡‘é‘°è¼ªæ›¿ SOPã€‚çœ‹å®Œé€™ç« å°±èƒ½ä¸Šç·šäº†ã€‚</p>
  </div>
</header>

<main class="main">

  <!-- =========================================
       Section 1: Project Structure
       ========================================= -->
  <section class="section fade-in" id="structure">
    <h2 class="section-anchor">å°ˆæ¡ˆçµæ§‹ç¸½è¦½</h2>
    <div class="section-rule"></div>
    <p>å…ˆçœ‹å…¨è²Œï¼ŒçŸ¥é“æ¯å€‹æª”æ¡ˆè² è²¬ä»€éº¼ï¼Œå†é€ä¸€æ‹†è§£ï¼š</p>

    <div class="file-tree">
      <span class="dir">src/main/java/com/example/kms/</span><br>
      &nbsp;&nbsp;â”œâ”€â”€ <span class="dir">config/</span><br>
      &nbsp;&nbsp;â”‚&nbsp;&nbsp;&nbsp;â”œâ”€â”€ <span class="hl">KmsProperties.java</span>&nbsp;&nbsp;&nbsp;<span class="cm">â† KMS é€£ç·šè¨­å®š</span><br>
      &nbsp;&nbsp;â”‚&nbsp;&nbsp;&nbsp;â””â”€â”€ <span class="hl">CacheConfig.java</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="cm">â† Caffeine Cache è¨­å®š</span><br>
      &nbsp;&nbsp;â”œâ”€â”€ <span class="dir">service/</span><br>
      &nbsp;&nbsp;â”‚&nbsp;&nbsp;&nbsp;â””â”€â”€ <span class="hl">KmsService.java</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="cm">â† æ ¸å¿ƒï¼å–å…¬é‘° + è§£å¯† + Cache</span><br>
      &nbsp;&nbsp;â””â”€â”€ <span class="dir">controller/</span><br>
      &nbsp;&nbsp;â””â”€â”€ <span class="hl">KmsController.java</span>&nbsp;&nbsp;<span class="cm">â† REST API ç«¯é»</span><br>
      <br>
      <span class="dir">vendor-sample/</span><br>
      &nbsp;&nbsp;â””â”€â”€ <span class="hl">VendorEncryptionExample.java</span>&nbsp;<span class="cm">â† çµ¦å» å•†çš„åŠ å¯†ç¯„ä¾‹</span>
    </div>
  </section>

  <!-- =========================================
       Section 2: Dependencies
       ========================================= -->
  <section class="section fade-in" id="deps">
    <h2 class="section-anchor">Maven ä¾è³´</h2>
    <div class="section-rule"></div>

    <div class="code-block">
      <div class="code-header">
        <span class="code-lang">xml</span>
        <span class="code-file">pom.xml</span>
        <button class="copy-btn" onclick="copyCode(this)">è¤‡è£½</button>
      </div>
      <div class="code-body">
<pre><span class="cm">&lt;!-- Spring Boot Starter --&gt;</span>
&lt;<span class="kw">dependency</span>&gt;
    &lt;groupId&gt;<span class="str">org.springframework.boot</span>&lt;/groupId&gt;
    &lt;artifactId&gt;<span class="str">spring-boot-starter-web</span>&lt;/artifactId&gt;
&lt;/dependency&gt;

<span class="cm">&lt;!-- GCP KMS Client --&gt;</span>
&lt;<span class="kw">dependency</span>&gt;
    &lt;groupId&gt;<span class="str">com.google.cloud</span>&lt;/groupId&gt;
    &lt;artifactId&gt;<span class="str">google-cloud-kms</span>&lt;/artifactId&gt;
    &lt;version&gt;<span class="num">2.54.0</span>&lt;/version&gt;
&lt;/dependency&gt;

<span class="cm">&lt;!-- Spring Boot Cache + Caffeine --&gt;</span>
&lt;<span class="kw">dependency</span>&gt;
    &lt;groupId&gt;<span class="str">org.springframework.boot</span>&lt;/groupId&gt;
    &lt;artifactId&gt;<span class="str">spring-boot-starter-cache</span>&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;<span class="kw">dependency</span>&gt;
    &lt;groupId&gt;<span class="str">com.github.ben-manes.caffeine</span>&lt;/groupId&gt;
    &lt;artifactId&gt;<span class="str">caffeine</span>&lt;/artifactId&gt;
&lt;/dependency&gt;

<span class="cm">&lt;!-- Lombok --&gt;</span>
&lt;<span class="kw">dependency</span>&gt;
    &lt;groupId&gt;<span class="str">org.projectlombok</span>&lt;/groupId&gt;
    &lt;artifactId&gt;<span class="str">lombok</span>&lt;/artifactId&gt;
    &lt;optional&gt;<span class="kw">true</span>&lt;/optional&gt;
&lt;/dependency&gt;</pre>
      </div>
    </div>
  </section>

  <!-- =========================================
       Section 3: Config classes
       ========================================= -->
  <section class="section fade-in" id="config">
    <h2 class="section-anchor">è¨­å®šæª”</h2>
    <div class="section-rule"></div>

    <h3>application.yml</h3>
    <div class="code-block">
      <div class="code-header">
        <span class="code-lang">yaml</span>
        <span class="code-file">application.yml</span>
        <button class="copy-btn" onclick="copyCode(this)">è¤‡è£½</button>
      </div>
      <div class="code-body">
<pre><span class="cm"># ===== GCP KMS è¨­å®š =====</span>
<span class="kw">gcp</span>:
  <span class="kw">kms</span>:
    <span class="typ">project-id</span>: <span class="str">your-gcp-project-id</span>
    <span class="typ">location</span>: <span class="str">asia-east1</span>
    <span class="typ">key-ring</span>: <span class="str">my-keyring</span>
    <span class="typ">key-id</span>: <span class="str">id-encrypt-key</span>
    <span class="typ">key-version</span>: <span class="str">1</span>

<span class="cm"># ===== Cache è¨­å®š =====</span>
<span class="cm"># å…¬é‘°å¿«å– 24 å°æ™‚ï¼Œè§£å¯†çµæœå¿«å– 1 å°æ™‚</span>
<span class="kw">cache</span>:
  <span class="kw">public-key</span>:
    <span class="typ">expire-hours</span>: <span class="num">24</span>
  <span class="kw">decrypt-result</span>:
    <span class="typ">expire-minutes</span>: <span class="num">60</span>
    <span class="typ">max-size</span>: <span class="num">10000</span>

<span class="cm"># ===== Spring Cache =====</span>
<span class="kw">spring</span>:
  <span class="kw">cache</span>:
    <span class="typ">type</span>: <span class="str">caffeine</span></pre>
      </div>
    </div>

    <h3>KmsProperties.java</h3>
    <div class="code-block">
      <div class="code-header">
        <span class="code-lang">java</span>
        <span class="code-file">config/KmsProperties.java</span>
        <button class="copy-btn" onclick="copyCode(this)">è¤‡è£½</button>
      </div>
      <div class="code-body">
<pre><span class="ann">@Data</span>
<span class="ann">@Component</span>
<span class="ann">@ConfigurationProperties</span>(prefix = <span class="str">"gcp.kms"</span>)
<span class="kw">public class</span> <span class="typ">KmsProperties</span> {

    <span class="kw">private</span> String projectId;
    <span class="kw">private</span> String location;
    <span class="kw">private</span> String keyRing;
    <span class="kw">private</span> String keyId;
    <span class="kw">private</span> String keyVersion;

    <span class="cm">/**
     * çµ„å‡ºå®Œæ•´çš„ KMS key version resource name
     */</span>
    <span class="kw">public</span> String <span class="typ">getKeyVersionName</span>() {
        <span class="kw">return</span> String.format(
            <span class="str">"projects/%s/locations/%s/keyRings/%s/cryptoKeys/%s/cryptoKeyVersions/%s"</span>,
            projectId, location, keyRing, keyId, keyVersion
        );
    }
}</pre>
      </div>
    </div>

    <h3>CacheConfig.java</h3>
    <div class="code-block">
      <div class="code-header">
        <span class="code-lang">java</span>
        <span class="code-file">config/CacheConfig.java</span>
        <button class="copy-btn" onclick="copyCode(this)">è¤‡è£½</button>
      </div>
      <div class="code-body">
<pre><span class="ann">@Configuration</span>
<span class="ann">@EnableCaching</span>
<span class="kw">public class</span> <span class="typ">CacheConfig</span> {

    <span class="kw">public static final</span> String <span class="typ">PUBLIC_KEY_CACHE</span>       = <span class="str">"publicKeyCache"</span>;
    <span class="kw">public static final</span> String <span class="typ">DECRYPT_RESULT_CACHE</span>   = <span class="str">"decryptResultCache"</span>;

    <span class="ann">@Value</span>(<span class="str">"${cache.public-key.expire-hours:24}"</span>)
    <span class="kw">private int</span> publicKeyExpireHours;

    <span class="ann">@Value</span>(<span class="str">"${cache.decrypt-result.expire-minutes:60}"</span>)
    <span class="kw">private int</span> decryptResultExpireMinutes;

    <span class="ann">@Value</span>(<span class="str">"${cache.decrypt-result.max-size:10000}"</span>)
    <span class="kw">private int</span> decryptResultMaxSize;

    <span class="ann">@Bean</span>
    <span class="kw">public</span> CacheManager <span class="typ">cacheManager</span>() {
        <span class="cm">// âš ï¸ æ³¨æ„ï¼šCaffeine æ˜¯ in-process memory cacheï¼Œ</span>
        <span class="cm">//    å¤š Pod æ¶æ§‹ä¸‹å„ Pod çš„å¿«å–å½¼æ­¤ç¨ç«‹ã€ä¸å…±äº«ã€‚</span>
        <span class="cm">//    è‹¥éœ€è·¨ Pod å…±äº«å¿«å–ï¼Œæ‡‰æ”¹ç”¨ Redis ç­‰åˆ†æ•£å¼å¿«å–ã€‚</span>
        CaffeineCacheManager cm = <span class="kw">new</span> CaffeineCacheManager();

        <span class="cm">// å…¬é‘°å¿«å–ï¼šå…¬é‘°ä¸å¸¸è®Šï¼Œå¿«å–ä¹…ä¸€é»ï¼ˆ24hrï¼‰</span>
        cm.registerCustomCache(PUBLIC_KEY_CACHE,
            Caffeine.newBuilder()
                .expireAfterWrite(publicKeyExpireHours, TimeUnit.HOURS)
                .maximumSize(<span class="num">10</span>)
                .recordStats()
                .build());

        <span class="cm">// è§£å¯†çµæœå¿«å–ï¼šPII æ•æ„Ÿè³‡æ–™ï¼ŒTTL çŸ­</span>
        cm.registerCustomCache(DECRYPT_RESULT_CACHE,
            Caffeine.newBuilder()
                .expireAfterWrite(decryptResultExpireMinutes, TimeUnit.MINUTES)
                .maximumSize(decryptResultMaxSize)
                .recordStats()
                .build());

        <span class="kw">return</span> cm;
    }
}</pre>
      </div>
    </div>
  </section>

  <!-- =========================================
       Section 4: KmsService
       ========================================= -->
  <section class="section fade-in" id="service">
    <h2 class="section-anchor">æ ¸å¿ƒ Serviceï¼šKmsService.java</h2>
    <div class="section-rule"></div>
    <p>æ•´å€‹å°ˆæ¡ˆæœ€é‡è¦çš„ä¸€æ”¯ã€‚è² è²¬ä¸‰ä»¶äº‹ï¼š<strong>å–å…¬é‘°</strong>ã€<strong>è§£å¯†</strong>ã€<strong>Cache ç®¡ç†</strong>ã€‚</p>

    <div class="code-block">
      <div class="code-header">
        <span class="code-lang">java</span>
        <span class="code-file">service/KmsService.java</span>
        <button class="copy-btn" onclick="copyCode(this)">è¤‡è£½</button>
      </div>
      <div class="code-body">
<pre><span class="ann">@Slf4j</span>
<span class="ann">@Service</span>
<span class="ann">@RequiredArgsConstructor</span>
<span class="kw">public class</span> <span class="typ">KmsService</span> {

    <span class="kw">private final</span> KmsProperties kmsProperties;
    <span class="kw">private</span> KeyManagementServiceClient kmsClient;

    <span class="ann">@PostConstruct</span>
    <span class="kw">public void</span> <span class="typ">init</span>() <span class="kw">throws</span> IOException {
        <span class="kw">this</span>.kmsClient = KeyManagementServiceClient.create();
        log.info(<span class="str">"KMS client initialized for key: {}"</span>,
                 kmsProperties.getKeyVersionName());
    }

    <span class="ann">@PreDestroy</span>
    <span class="kw">public void</span> <span class="typ">destroy</span>() {
        <span class="kw">if</span> (kmsClient != <span class="kw">null</span>) kmsClient.close();
    }

    <span class="cm">// â”€â”€â”€ 1. å–å…¬é‘°ï¼ˆå¿«å– 24hrï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>

    <span class="ann">@Cacheable</span>(value = CacheConfig.PUBLIC_KEY_CACHE, key = <span class="str">"#keyVersion"</span>)
    <span class="kw">public</span> String <span class="typ">getPublicKeyPem</span>(String keyVersion) {
        log.info(<span class="str">"Cache MISS - fetching public key from KMS for version: {}"</span>,
                 keyVersion);

        CryptoKeyVersionName keyVersionName = buildKeyVersionName(keyVersion);
        PublicKey publicKey = kmsClient.getPublicKey(keyVersionName);

        String pem = publicKey.getPem();
        log.info(<span class="str">"Public key fetched successfully, algorithm: {}"</span>,
                 publicKey.getAlgorithm());
        <span class="kw">return</span> pem;
    }

    <span class="kw">public</span> String <span class="typ">getCurrentPublicKeyPem</span>() {
        <span class="kw">return</span> getPublicKeyPem(kmsProperties.getKeyVersion());
    }

    <span class="cm">// â”€â”€â”€ 2. è§£å¯†ï¼ˆå¿«å– 1hrï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>

    <span class="ann">@Cacheable</span>(value = CacheConfig.DECRYPT_RESULT_CACHE, key = <span class="str">"#ciphertextBase64"</span>)
    <span class="kw">public</span> String <span class="typ">decrypt</span>(String ciphertextBase64) {
        log.info(<span class="str">"Cache MISS - calling KMS to decrypt"</span>);

        <span class="kw">try</span> {
            <span class="kw">byte</span>[] ciphertext = Base64.getDecoder().decode(ciphertextBase64);

            CryptoKeyVersionName keyVersionName = buildKeyVersionName(
                kmsProperties.getKeyVersion()
            );

            AsymmetricDecryptResponse response = kmsClient.asymmetricDecrypt(
                keyVersionName,
                ByteString.copyFrom(ciphertext)
            );

            String plaintext = response.getPlaintext().toStringUtf8();
            log.info(<span class="str">"Decryption successful"</span>);
            <span class="kw">return</span> plaintext;

        } <span class="kw">catch</span> (Exception e) {
            log.error(<span class="str">"Decryption failed"</span>, e);
            <span class="kw">throw new</span> KmsDecryptionException(<span class="str">"Failed to decrypt data"</span>, e);
        }
    }

    <span class="cm">// â”€â”€â”€ 3. Cache ç®¡ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>

    <span class="ann">@CacheEvict</span>(value = CacheConfig.PUBLIC_KEY_CACHE, allEntries = <span class="kw">true</span>)
    <span class="kw">public void</span> <span class="typ">evictPublicKeyCache</span>() {
        log.info(<span class="str">"Public key cache evicted"</span>);
    }

    <span class="ann">@CacheEvict</span>(value = CacheConfig.DECRYPT_RESULT_CACHE, allEntries = <span class="kw">true</span>)
    <span class="kw">public void</span> <span class="typ">evictDecryptResultCache</span>() {
        log.info(<span class="str">"Decrypt result cache evicted"</span>);
    }

    <span class="cm">// â”€â”€â”€ Private helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>

    <span class="kw">private</span> CryptoKeyVersionName <span class="typ">buildKeyVersionName</span>(String version) {
        <span class="kw">return</span> CryptoKeyVersionName.of(
            kmsProperties.getProjectId(),
            kmsProperties.getLocation(),
            kmsProperties.getKeyRing(),
            kmsProperties.getKeyId(),
            version
        );
    }

    <span class="cm">// â”€â”€â”€ Custom Exception â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>

    <span class="kw">public static class</span> <span class="typ">KmsDecryptionException</span>
            <span class="kw">extends</span> RuntimeException {
        <span class="kw">public</span> KmsDecryptionException(String msg, Throwable cause) {
            <span class="kw">super</span>(msg, cause);
        }
    }
}</pre>
      </div>
    </div>

    <div class="callout callout-analogy">
      <div class="callout-title">ç¨‹å¼ç¢¼é‡é»æç¤º</div>
      <p><code>@Cacheable</code> æ˜¯ Spring Cache çš„è¨»è§£ â€” ç¬¬ä¸€æ¬¡å‘¼å«æœƒåŸ·è¡Œæ–¹æ³•ä¸¦å­˜å…¥å¿«å–ï¼Œä¹‹å¾ŒåŒæ¨£çš„åƒæ•¸ç›´æ¥å›å‚³å¿«å–çµæœï¼Œä¸å†æ‰“ KMS APIã€‚</p>
      <p><code>@CacheEvict</code> å‰‡æ˜¯æ‰‹å‹•æ¸…é™¤å¿«å–çš„æ–¹æ³•ï¼Œé‡‘é‘°è¼ªæ›¿æ™‚æœƒç”¨åˆ°ã€‚</p>
      <p><code>buildKeyVersionName()</code> ç”¨ SDK å…§å»ºçš„ <code>CryptoKeyVersionName.of()</code> çµ„å‡º resource nameï¼Œæ¯”æ‰‹å‹• format å­—ä¸²æ›´å®‰å…¨ã€‚</p>
      <p><code>KmsDecryptionException</code> æ˜¯è‡ªè¨‚ä¾‹å¤–ï¼Œæ–¹ä¾¿ä¸Šå±¤çµ±ä¸€è™•ç†è§£å¯†å¤±æ•—çš„æƒ…å¢ƒã€‚</p>
    </div>
  </section>

  <!-- =========================================
       Section 5: Controller
       ========================================= -->
  <section class="section fade-in" id="controller">
    <h2 class="section-anchor">REST Controller</h2>
    <div class="section-rule"></div>

    <div class="code-block">
      <div class="code-header">
        <span class="code-lang">java</span>
        <span class="code-file">controller/KmsController.java</span>
        <button class="copy-btn" onclick="copyCode(this)">è¤‡è£½</button>
      </div>
      <div class="code-body">
<pre><span class="ann">@Slf4j</span>
<span class="ann">@RestController</span>
<span class="ann">@RequestMapping</span>(<span class="str">"/api/v1/kms"</span>)
<span class="ann">@RequiredArgsConstructor</span>
<span class="kw">public class</span> <span class="typ">KmsController</span> {

    <span class="kw">private final</span> KmsService kmsService;

    <span class="cm">// â”€â”€â”€ å…¬é‘°ç«¯é»ï¼ˆçµ¦å» å•†å–ç”¨ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
    <span class="ann">@GetMapping</span>(value = <span class="str">"/public-key"</span>, produces = MediaType.TEXT_PLAIN_VALUE)
    <span class="kw">public</span> ResponseEntity&lt;String&gt; <span class="typ">getPublicKey</span>() {
        String pem = kmsService.getCurrentPublicKeyPem();
        <span class="kw">return</span> ResponseEntity.ok(pem);
    }

    <span class="cm">// â”€â”€â”€ è§£å¯†ç«¯é»ï¼ˆæ”¶å» å•†å¯†æ–‡ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
    <span class="ann">@PostMapping</span>(<span class="str">"/decrypt"</span>)
    <span class="kw">public</span> ResponseEntity&lt;DecryptResponse&gt; <span class="typ">decrypt</span>(
            <span class="ann">@RequestBody</span> DecryptRequest request) {
        log.info(<span class="str">"Received decrypt request"</span>);

        String plaintext = kmsService.decrypt(request.getEncryptedData());

        <span class="cm">// âš ï¸ å¯¦å‹™ä¸Šä¸è¦ç›´æ¥å›å‚³æ˜æ–‡ï¼é€™è£¡åªæ˜¯ç¤ºæ„ã€‚</span>
        <span class="cm">// æ‡‰è©²åœ¨ service å±¤ç›´æ¥è™•ç†æ¥­å‹™é‚è¼¯ï¼ˆæ¯”å°ã€å„²å­˜ç­‰ï¼‰</span>
        <span class="kw">return</span> ResponseEntity.ok(<span class="kw">new</span> DecryptResponse(plaintext));
    }

    <span class="cm">// â”€â”€â”€ Cache ç®¡ç†ï¼ˆå…§éƒ¨ä½¿ç”¨ï¼Œæ‡‰åŠ ä¸Šæ¬Šé™æ§åˆ¶ï¼‰â”€â”€</span>
    <span class="ann">@PostMapping</span>(<span class="str">"/cache/evict/public-key"</span>)
    <span class="kw">public</span> ResponseEntity&lt;String&gt; <span class="typ">evictPublicKeyCache</span>() {
        kmsService.evictPublicKeyCache();
        <span class="kw">return</span> ResponseEntity.ok(<span class="str">"Public key cache evicted"</span>);
    }

    <span class="ann">@PostMapping</span>(<span class="str">"/cache/evict/decrypt"</span>)
    <span class="kw">public</span> ResponseEntity&lt;String&gt; <span class="typ">evictDecryptCache</span>() {
        kmsService.evictDecryptResultCache();
        <span class="kw">return</span> ResponseEntity.ok(<span class="str">"Decrypt result cache evicted"</span>);
    }

    <span class="cm">// â”€â”€â”€ DTOs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>

    <span class="ann">@Data</span>
    <span class="kw">public static class</span> <span class="typ">DecryptRequest</span> {
        <span class="kw">private</span> String encryptedData;  <span class="cm">// Base64 encoded ciphertext</span>
    }

    <span class="ann">@Data</span>
    <span class="kw">public static class</span> <span class="typ">DecryptResponse</span> {
        <span class="kw">private final</span> String data;
    }
}</pre>
      </div>
    </div>

    <div class="callout callout-warning">
      <p><strong>æ³¨æ„</strong>ï¼š<code>/decrypt</code> ç«¯é»ç¯„ä¾‹ç›´æ¥å›å‚³æ˜æ–‡åªæ˜¯ç‚ºäº†ç¤ºæ„ã€‚æ­£å¼ç’°å¢ƒæ‡‰è©²åœ¨ service å±¤ç›´æ¥è™•ç†æ¥­å‹™é‚è¼¯ï¼ˆæ¯”å°ã€å„²å­˜ï¼‰ï¼Œ<strong>ä¸è¦æŠŠèº«åˆ†è­‰å­—è™Ÿæ˜æ–‡å›å‚³åˆ°å‰ç«¯æˆ–å…¶ä»–å¤–éƒ¨ç³»çµ±</strong>ã€‚</p>
      <p>å¦å¤–ï¼Œ<code>/cache/evict/*</code> ç«¯é»æ‡‰åŠ ä¸Šæ¬Šé™æ§åˆ¶ï¼ˆä¾‹å¦‚ <code>@PreAuthorize("hasRole('ADMIN')")</code>ï¼‰ï¼Œé¿å…ä»»ä½•äººéƒ½èƒ½æ¸…é™¤å¿«å–ã€‚</p>
    </div>
  </section>

  <!-- =========================================
       Section 6: Vendor Sample
       ========================================= -->
  <section class="section fade-in" id="vendor">
    <h2 class="section-anchor">çµ¦å» å•†çš„åŠ å¯†ç¯„ä¾‹ç¨‹å¼</h2>
    <div class="section-rule"></div>
    <p>æŠŠä»¥ä¸‹ç¨‹å¼ç¢¼é€£åŒå…¬é‘° PEM æª”ä¸€èµ·çµ¦å» å•†ã€‚å¼·èª¿ä¸‰å€‹é‡é»ï¼š<strong>æ¼”ç®—æ³•</strong>ã€<strong>å¡«å……æ–¹å¼</strong>ã€<strong>Base64 ç·¨ç¢¼</strong>ã€‚</p>

    <div class="code-block">
      <div class="code-header">
        <span class="code-lang">java</span>
        <span class="code-file">VendorEncryptionExample.java</span>
        <button class="copy-btn" onclick="copyCode(this)">è¤‡è£½</button>
      </div>
      <div class="code-body">
<pre><span class="cm">/**
 * ã€å» å•†ç«¯ã€‘åŠ å¯†ç¯„ä¾‹ç¨‹å¼
 *
 * å» å•†æ‹¿åˆ°æˆ‘æ–¹æä¾›çš„ PEM å…¬é‘°å¾Œï¼Œ
 * ç”¨æ­¤ç¨‹å¼å°‡èº«åˆ†è­‰å­—è™ŸåŠ å¯†ï¼Œå†ä»¥ Base64 å‚³çµ¦æˆ‘æ–¹ã€‚
 *
 * é‡é»ï¼š
 *   Algorithm: RSA/ECB/OAEPWithSHA-256AndMGF1Padding
 *   âš ï¸ å¿…é ˆæ˜ç¢ºæŒ‡å®š OAEPParameterSpecï¼Œå¦å‰‡ MGF1 é è¨­ SHA-1 â†’ KMS è§£å¯†å¤±æ•—
 */</span>
<span class="kw">public class</span> <span class="typ">VendorEncryptionExample</span> {

    <span class="kw">public static</span> String <span class="typ">encrypt</span>(String pemPublicKey, String plaintext)
            <span class="kw">throws</span> Exception {

        <span class="cm">// 1. PEM â†’ PublicKey ç‰©ä»¶</span>
        String pemContent = pemPublicKey
            .replace(<span class="str">"-----BEGIN PUBLIC KEY-----"</span>, <span class="str">""</span>)
            .replace(<span class="str">"-----END PUBLIC KEY-----"</span>, <span class="str">""</span>)
            .replaceAll(<span class="str">"\\s+"</span>, <span class="str">""</span>);

        <span class="kw">byte</span>[] keyBytes = Base64.getDecoder().decode(pemContent);
        X509EncodedKeySpec keySpec = <span class="kw">new</span> X509EncodedKeySpec(keyBytes);
        PublicKey publicKey = KeyFactory.getInstance(<span class="str">"RSA"</span>)
            .generatePublic(keySpec);

        <span class="cm">// 2. åŠ å¯† â€” å¿…é ˆç”¨ OAEPWithSHA-256AndMGF1Padding</span>
        <span class="cm">//    âš ï¸ å¦‚æœç”¨éŒ¯ paddingï¼ˆä¾‹å¦‚ PKCS1ï¼‰ï¼ŒKMS æœƒè§£å¯†å¤±æ•—</span>
        <span class="cm">//    âš ï¸ å¿…é ˆæ˜ç¢ºæŒ‡å®š OAEPParameterSpecï¼Œ</span>
        <span class="cm">//       å¦å‰‡ MGF1 é è¨­ç‚º SHA-1ï¼Œå°è‡´ KMS è§£å¯†å¤±æ•—</span>
        Cipher cipher = Cipher.getInstance(
            <span class="str">"RSA/ECB/OAEPWithSHA-256AndMGF1Padding"</span>
        );
        OAEPParameterSpec oaepParams = <span class="kw">new</span> OAEPParameterSpec(
            <span class="str">"SHA-256"</span>,                     <span class="cm">// OAEP ä¸»æ‘˜è¦</span>
            <span class="str">"MGF1"</span>,                        <span class="cm">// Mask Generation Function</span>
            MGF1ParameterSpec.SHA256,      <span class="cm">// â† MGF1 ä¹Ÿè¦ SHA-256ï¼</span>
            PSource.PSpecified.DEFAULT
        );
        cipher.init(Cipher.ENCRYPT_MODE, publicKey, oaepParams);

        <span class="kw">byte</span>[] ciphertext = cipher.doFinal(
            plaintext.getBytes(StandardCharsets.UTF_8)
        );

        <span class="cm">// 3. Base64 ç·¨ç¢¼å¾Œå›å‚³</span>
        <span class="kw">return</span> Base64.getEncoder().encodeToString(ciphertext);
    }

    <span class="kw">public static void</span> <span class="typ">main</span>(String[] args) <span class="kw">throws</span> Exception {
        <span class="cm">// æ¨¡æ“¬ï¼šå¾æˆ‘æ–¹ API å–å¾—å…¬é‘°ï¼ˆæˆ–é›¢ç·šæ‹¿åˆ°çš„ PEM æª”ï¼‰</span>
        String pemPublicKey = <span class="str">"""
                -----BEGIN PUBLIC KEY-----
                MIICIjANBgkqhkiG9w0BAQE...ï¼ˆå¯¦éš›å…¬é‘°å…§å®¹ï¼‰...
                -----END PUBLIC KEY-----
                """</span>;

        String encrypted = encrypt(pemPublicKey, <span class="str">"A123456789"</span>);
        System.out.println(<span class="str">"Encrypted (Base64): "</span> + encrypted);

        <span class="cm">// å» å•†å†æŠŠé€™å€‹ encrypted å€¼é€é API å‚³çµ¦æˆ‘æ–¹ï¼š</span>
        <span class="cm">// POST /api/v1/kms/decrypt</span>
        <span class="cm">// { "encryptedData": "&lt;encrypted&gt;" }</span>
    }
}</pre>
      </div>
    </div>

    <div class="callout callout-tip">
      <div class="callout-title">çµ¦å» å•†çš„ Checklist</div>
      <p>âœ… å…¬é‘° PEM æª” â€” å¾æˆ‘æ–¹å–å¾—<br>
         âœ… Cipher â€” <code>RSA/ECB/OAEPWithSHA-256AndMGF1Padding</code><br>
         âœ… OAEPParameterSpec â€” MGF1 å¿…é ˆæŒ‡å®š <code>MGF1ParameterSpec.SHA256</code>ï¼ˆJava é è¨­æ˜¯ SHA-1ï¼‰<br>
         âœ… å¯†æ–‡æ ¼å¼ â€” Base64 ç·¨ç¢¼å¾Œå†é€é API å‚³é€<br>
         âœ… ç·¨ç¢¼ â€” æ˜æ–‡ç”¨ UTF-8</p>
    </div>
  </section>

  <!-- =========================================
       Section 7: Cache Strategy
       ========================================= -->
  <section class="section fade-in" id="cache">
    <h2 class="section-anchor">Cache ç­–ç•¥</h2>
    <div class="section-rule"></div>

    <h3>ç‚ºä»€éº¼è¦ Cacheï¼Ÿ</h3>
    <p>æ¯æ¬¡å‘¼å« KMS API éƒ½æœƒç”¢ç”Ÿè²»ç”¨å’Œç¶²è·¯å»¶é²ï¼ˆasia-east1 ç´„ 5-15msï¼‰ã€‚åŒæ¨£çš„æ“ä½œæ²’å¿…è¦é‡è¤‡å‘¼å«ã€‚</p>

    <div class="table-wrap">
      <table>
        <thead><tr><th>Cache å°è±¡</th><th>ç‚ºä»€éº¼å¿«å–</th><th>TTL</th><th>Max Size</th><th>ç¯„åœ</th></tr></thead>
        <tbody>
          <tr>
            <td><strong>å…¬é‘° PEM</strong></td>
            <td>å…¬é‘°ä¸å¸¸è®Šï¼›KMS API æœ‰ rate limit</td>
            <td><span class="tag tag-blue">24 å°æ™‚</span></td>
            <td>10</td>
            <td><span class="tag tag-green">å–® Pod</span></td>
          </tr>
          <tr>
            <td><strong>è§£å¯†çµæœ</strong></td>
            <td>åŒä¸€å¯†æ–‡ä¸é‡è¤‡è§£å¯†ï¼Œçœ API è²»ç”¨</td>
            <td><span class="tag tag-orange">1 å°æ™‚</span></td>
            <td>10,000</td>
            <td><span class="tag tag-green">å–® Pod</span></td>
          </tr>
        </tbody>
      </table>
      <div style="padding:10px 18px 12px; font-size:12.5px; color:var(--text-muted); border-top:1px solid var(--border-light);">
        âš ï¸ ç›®å‰ä½¿ç”¨ Caffeineï¼ˆin-process memoryï¼‰ï¼Œå¿«å–ç¯„åœåƒ…é™å–®ä¸€ Podã€‚å¤š Pod æ¶æ§‹è«‹åƒè€ƒä¸‹æ–¹èªªæ˜æ”¹ç”¨ Redisã€‚
      </div>
    </div>

    <h3>è§£å¯†è«‹æ±‚çš„ Cache æµç¨‹</h3>
    <div class="cache-flow">
      <div class="cf-label">è§£å¯† API å‘¼å«æµç¨‹</div>
      <div class="cf-row">
        <div class="cf-box req">ğŸ“¨ æ”¶åˆ°å¯†æ–‡</div>
        <div class="cf-arrow">â†’</div>
        <div class="cf-box cache-hit">æŸ¥ Caffeine Cache</div>
      </div>
      <div class="cf-row">
        <div class="cf-box cache-hit" style="background:#D1FAE5">âœ“ Cache HIT</div>
        <div class="cf-arrow">â†’</div>
        <div class="cf-box result">ç›´æ¥å›å‚³æ˜æ–‡ï¼ˆ0msï¼‰</div>
      </div>
      <div class="cf-row">
        <div class="cf-box cache-miss">âœ— Cache MISS</div>
        <div class="cf-arrow">â†’</div>
        <div class="cf-box kms">å‘¼å« KMS API</div>
        <div class="cf-arrow">â†’</div>
        <div class="cf-box result">å›å‚³ + å­˜å…¥ Cache</div>
      </div>
    </div>

    <h3>å¿«å– PII çš„å®‰å…¨è€ƒé‡</h3>
    <div class="callout callout-warning">
      <p><strong>èº«åˆ†è­‰å­—è™Ÿæ˜¯å€‹äººè³‡æ–™ï¼ˆPIIï¼‰</strong>ï¼Œå¿«å–æ™‚è¦æ³¨æ„ï¼š</p>
      <p>â€¢ TTL ä¸è¦å¤ªé•· â€” 1 å°æ™‚è¶³ä»¥æ‡‰ä»˜çŸ­æœŸé‡è¤‡è«‹æ±‚</p>
      <p>â€¢ ç”¨è¨˜æ†¶é«”å…§å¿«å–ï¼ˆCaffeineï¼‰ â€” ä¸è½ç£ç¢Ÿã€ä¸å¯« log</p>
      <p>â€¢ å¦‚æœæ”¹ç”¨ Redis â€” å‹™å¿…åŠ å¯† valueã€è¨­ TLSã€é™åˆ¶å­˜å–</p>
      <p>â€¢ è¨­ maxSize ä¸Šé™ â€” é¿å…è¨˜æ†¶é«”ä¸æ–·æˆé•·</p>
      <p>â€¢ å¦‚æœå®‰å…¨æ”¿ç­–åš´æ ¼ä¸å…è¨±å¿«å– PII â†’ <strong>åªå¿«å–å…¬é‘°ï¼Œä¸å¿«å–è§£å¯†çµæœ</strong></p>
    </div>

    <h3>å¤š Pod æ¶æ§‹æ³¨æ„äº‹é …</h3>
    <div class="callout callout-warning">
      <p><strong>Caffeine æ˜¯ in-process memory cacheï¼Œæ¯å€‹ Pod å„è‡ªç¶­è­·è‡ªå·±çš„å¿«å–ï¼Œå½¼æ­¤ä¸å…±äº«ã€‚</strong></p>
      <p>å¦‚æœä½ çš„æœå‹™éƒ¨ç½²åœ¨ Kubernetes å¤š Pod æ¶æ§‹ä¸‹ï¼Œæœƒé‡åˆ°ä»¥ä¸‹å•é¡Œï¼š</p>
      <p>â€¢ <strong>å¿«å–ä¸ä¸€è‡´</strong> â€” Pod A å¿«å–äº†å…¬é‘°ï¼ŒPod B ä»è¦æ‰“ KMS APIï¼›åŒä¸€ç­†å¯†æ–‡è¢«ä¸åŒ Pod è™•ç†æœƒé‡è¤‡è§£å¯†</p>
      <p>â€¢ <strong>æ¸…é™¤å¿«å–è¦æ‰“æ‰€æœ‰ Pod</strong> â€” å‘¼å« <code>/cache/evict/*</code> åªæ¸…åˆ°è¢« Load Balancer åˆ†é…åˆ°çš„é‚£å€‹ Pod</p>
      <p>â€¢ <strong>è¨˜æ†¶é«”æµªè²»</strong> â€” æ¯å€‹ Pod å„å­˜ä¸€ä»½å¿«å–ï¼ŒN å€‹ Pod å°±æ˜¯ N å€è¨˜æ†¶é«”æ¶ˆè€—</p>
    </div>

    <div class="callout callout-tip">
      <div class="callout-title">è§£æ³•ï¼šæ”¹ç”¨ Redis ç­‰åˆ†æ•£å¼å¿«å–</div>
      <p>æŠŠ Caffeine æ›æˆ Redisï¼ˆæˆ– Memcachedï¼‰ï¼Œæ‰€æœ‰ Pod å…±ç”¨åŒä¸€ä»½å¿«å–ï¼š</p>
      <p>â€¢ ä¾è³´æ”¹ç”¨ <code>spring-boot-starter-data-redis</code></p>
      <p>â€¢ <code>CacheManager</code> æ”¹ç”¨ <code>RedisCacheManager</code></p>
      <p>â€¢ <code>@Cacheable</code> / <code>@CacheEvict</code> ä¸ç”¨æ”¹ â€” Spring Cache æŠ½è±¡å±¤æœƒè‡ªå‹•åˆ‡æ›åº•å±¤å¯¦ä½œ</p>
      <p>â€¢ åˆ¥å¿˜äº†å° PII æ•æ„Ÿè³‡æ–™åŠ å¯† valueã€è¨­ TLSã€é™åˆ¶ Redis å­˜å–æ¬Šé™</p>
    </div>
  </section>

  <!-- =========================================
       Section 8: Key Rotation SOP
       ========================================= -->
  <section class="section fade-in" id="rotation">
    <h2 class="section-anchor">é‡‘é‘°è¼ªæ›¿ SOP</h2>
    <div class="section-rule"></div>
    <p>éå°ç¨±é‡‘é‘°ä¸æ”¯æ´è‡ªå‹•è¼ªæ›¿ï¼Œéœ€è¦æ‰‹å‹•åŸ·è¡Œã€‚ä»¥ä¸‹æ˜¯å®Œæ•´æ­¥é©Ÿï¼š</p>

    <div class="sop-timeline">
      <div class="sop-step">
        <div class="sop-dot red">1</div>
        <h4>åœ¨ KMS å»ºç«‹æ–°çš„ Key Version</h4>
        <p>åœ¨åŒä¸€å€‹ Crypto Key ä¸‹æ–°å¢ versionï¼ˆä¾‹å¦‚ v2ï¼‰ã€‚KMS æœƒè‡ªå‹•ç”¢ç”Ÿæ–°çš„å…¬ç§é‘°å°ã€‚</p>
      </div>
      <div class="sop-step">
        <div class="sop-dot blue">2</div>
        <h4>åŒ¯å‡ºæ–°å…¬é‘°ä¸¦æä¾›çµ¦å» å•†</h4>
        <p>ç”¨ <code>gcloud kms keys versions get-public-key 2 ...</code> åŒ¯å‡ºæ–°å…¬é‘° PEMï¼Œäº¤çµ¦å» å•†æ›¿æ›ã€‚</p>
      </div>
      <div class="sop-step">
        <div class="sop-dot teal">3</div>
        <h4>æ›´æ–°æˆ‘æ–¹è¨­å®š + æ¸…é™¤ Cache</h4>
        <p>æŠŠ <code>application.yml</code> çš„ <code>key-version</code> æ”¹æˆ <code>2</code>ï¼Œé‡æ–°éƒ¨ç½²ï¼Œç„¶å¾Œå‘¼å« <code>POST /cache/evict/public-key</code> æ¸…é™¤å…¬é‘°å¿«å–ã€‚</p>
      </div>
      <div class="sop-step">
        <div class="sop-dot gold">4</div>
        <h4>éæ¸¡æœŸï¼šä¿ç•™èˆŠç‰ˆæœ¬</h4>
        <p>å» å•†å¯èƒ½é‚„æœ‰ç”¨èˆŠå…¬é‘°åŠ å¯†çš„å¯†æ–‡åœ¨é€”ä¸­ã€‚ä¿ç•™èˆŠ key versionï¼ˆv1ï¼‰è‡³å°‘ <strong>7-30 å¤©</strong>ï¼Œç›´åˆ°ç¢ºèªæ‰€æœ‰èˆŠå¯†æ–‡éƒ½å·²è™•ç†å®Œç•¢ã€‚</p>
      </div>
      <div class="sop-step">
        <div class="sop-dot red">5</div>
        <h4>åœç”¨èˆŠç‰ˆæœ¬</h4>
        <p>ç¢ºèªæ²’æœ‰èˆŠå¯†æ–‡å¾Œï¼Œå°‡èˆŠ version disableï¼š<code>gcloud kms keys versions disable 1 ...</code>ã€‚åœç”¨è€ŒééŠ·æ¯€ï¼Œè¬ä¸€éœ€è¦é‚„èƒ½é‡æ–°å•Ÿç”¨ã€‚</p>
      </div>
    </div>

    <div class="callout callout-analogy">
      <div class="callout-title">éæ¸¡æœŸæ€éº¼è™•ç†æ–°èˆŠå¯†æ–‡ï¼Ÿ</div>
      <p>å¦‚æœå» å•†åŒæ™‚æœ‰ v1 å…¬é‘°åŠ å¯†çš„èˆŠå¯†æ–‡å’Œ v2 å…¬é‘°åŠ å¯†çš„æ–°å¯†æ–‡ï¼Œè§£æ³•æœ‰å…©ç¨®ï¼š</p>
      <p><strong>æ–¹æ¡ˆ A</strong>ï¼šè®“å» å•†åœ¨ payload ä¸­å¸¶ä¸Š key version è³‡è¨Šï¼Œæˆ‘æ–¹æ ¹æ“š version å‘¼å«å°æ‡‰çš„ KMS key version è§£å¯†ã€‚</p>
      <p><strong>æ–¹æ¡ˆ B</strong>ï¼šå…ˆè©¦ v2 è§£å¯†ï¼Œå¤±æ•—å† fallback è©¦ v1ã€‚ç°¡å–®ä½†æ•ˆç‡è¼ƒä½ã€‚</p>
    </div>

    <h3>è¼ªæ›¿æ™‚çš„ gcloud æŒ‡ä»¤</h3>
    <div class="code-block">
      <div class="code-header">
        <span class="code-lang">bash</span>
        <button class="copy-btn" onclick="copyCode(this)">è¤‡è£½</button>
      </div>
      <div class="code-body">
<pre><span class="cm"># 1. å»ºç«‹æ–°ç‰ˆæœ¬ï¼ˆv2ï¼‰</span>
gcloud kms keys versions create \
  <span class="ann">--key</span>=<span class="str">id-encrypt-key</span> \
  <span class="ann">--keyring</span>=<span class="str">my-keyring</span> \
  <span class="ann">--location</span>=<span class="str">asia-east1</span>

<span class="cm"># 2. åŒ¯å‡ºæ–°å…¬é‘°</span>
gcloud kms keys versions get-public-key <span class="num">2</span> \
  <span class="ann">--key</span>=<span class="str">id-encrypt-key</span> \
  <span class="ann">--keyring</span>=<span class="str">my-keyring</span> \
  <span class="ann">--location</span>=<span class="str">asia-east1</span> \
  <span class="ann">--output-file</span>=<span class="str">public_key_v2.pem</span>

<span class="cm"># 3. éæ¸¡æœŸçµæŸå¾Œï¼Œåœç”¨èˆŠç‰ˆæœ¬</span>
gcloud kms keys versions disable <span class="num">1</span> \
  <span class="ann">--key</span>=<span class="str">id-encrypt-key</span> \
  <span class="ann">--keyring</span>=<span class="str">my-keyring</span> \
  <span class="ann">--location</span>=<span class="str">asia-east1</span></pre>
      </div>
    </div>
  </section>

  <!-- Completion -->
  <div class="complete-banner">
    <div class="cb-icon">ğŸ‰</div>
    <h3>å…¨éƒ¨æ•™å­¸å®Œæˆï¼</h3>
    <p>ä½ å·²ç¶“æŒæ¡ GCP KMS éå°ç¨±åŠ å¯†çš„è§€å¿µã€æ¶æ§‹ã€å»ºç½®æ–¹å¼ã€Spring Boot å¯¦ä½œã€Cache ç­–ç•¥å’Œé‡‘é‘°è¼ªæ›¿ SOPã€‚<br>å¯ä»¥ç›´æ¥é–‹å§‹ä¸²æ¥äº†ï¼</p>
  </div>

  <!-- Chapter Nav -->
  <nav class="ch-nav">
    <a class="ch-nav-link" href="chapter3.html">
      <span class="ch-nav-label">â† ä¸Šä¸€ç« </span>
      <span class="ch-nav-title">Ch.3 å‹•æ‰‹å¯¦ä½œ</span>
    </a>
    <a class="ch-nav-link next" href="chapter1.html">
      <span class="ch-nav-label">å›åˆ°é–‹é ­ â†º</span>
      <span class="ch-nav-title">Ch.1 åŸºç¤è§€å¿µ</span>
    </a>
  </nav>

</main>

<footer class="footer">GCP KMS éå°ç¨±åŠ å¯†æ•™å­¸ Â· åœ˜éšŠå…§éƒ¨å­¸ç¿’ç”¨</footer>

<script>
function copyCode(btn) {
  const code = btn.closest('.code-block').querySelector('pre').textContent;
  navigator.clipboard.writeText(code).then(() => {
    btn.textContent = 'âœ“ å·²è¤‡è£½';
    setTimeout(() => btn.textContent = 'è¤‡è£½', 1500);
  });
}

// fade-inï¼šæ²å‹•åˆ°å¯è¦–ç¯„åœæ‰è§¸ç™¼å‹•ç•«
const fadeObserver = new IntersectionObserver(
  (entries) => {
    entries.forEach((entry) => {
      if (entry.isIntersecting) {
        entry.target.classList.add('visible');
        fadeObserver.unobserve(entry.target);
      }
    });
  },
  { threshold: 0.1 }
);
document.querySelectorAll('.fade-in').forEach((el) => fadeObserver.observe(el));
</script>
</body>
</html>
