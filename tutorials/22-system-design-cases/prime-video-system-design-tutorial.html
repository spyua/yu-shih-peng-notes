<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Amazon Prime Video â€” System Design Deep Dive</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=JetBrains+Mono:wght@400;500;600&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* ========== CSS VARIABLES ========== */
:root {
  --bg-primary: #ffffff;
  --bg-secondary: #f8fafc;
  --bg-tertiary: #e2e8f0;
  --text-primary: #1e293b;
  --text-secondary: #475569;
  --text-muted: #94a3b8;
  --border-color: #e2e8f0;
  --border-light: #f1f5f9;

  /* Accent â€” Prime Video blue-teal */
  --accent: #00a8e1;
  --accent-light: #e0f4fd;
  --accent-dark: #0077a8;

  /* Component Colors */
  --client: #3b82f6;
  --lb: #8b5cf6;
  --services: #10b981;
  --queue: #ef4444;
  --cache: #f59e0b;
  --search: #06b6d4;
  --storage: #6366f1;
  --database: #ec4899;
  --cdn: #14b8a6;
  --encoder: #f97316;

  /* Info boxes */
  --concept-bg: #eff6ff;
  --concept-border: #3b82f6;
  --important-bg: #fffbeb;
  --important-border: #f59e0b;
  --tip-bg: #ecfdf5;
  --tip-border: #10b981;
  --warning-bg: #fef2f2;
  --warning-border: #ef4444;
}

/* ========== RESET & BASE ========== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html { scroll-behavior: smooth; }

body {
  font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
  color: var(--text-primary);
  background: var(--bg-primary);
  line-height: 1.7;
  -webkit-font-smoothing: antialiased;
}

/* ========== STICKY NAV ========== */
.top-nav {
  position: sticky;
  top: 0;
  z-index: 1000;
  background: rgba(255,255,255,0.85);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border-bottom: 1px solid var(--border-color);
  padding: 0 2rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  height: 56px;
}

.nav-brand {
  display: flex;
  align-items: center;
  gap: 10px;
  font-family: 'Space Grotesk', sans-serif;
  font-weight: 700;
  font-size: 1.1rem;
  color: var(--text-primary);
  text-decoration: none;
}

.nav-brand-icon {
  width: 32px;
  height: 32px;
  background: linear-gradient(135deg, var(--accent), var(--accent-dark));
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  font-size: 16px;
}

.nav-tabs {
  display: flex;
  gap: 4px;
}

.nav-tab {
  padding: 16px 20px;
  font-family: 'DM Sans', sans-serif;
  font-size: 0.9rem;
  font-weight: 500;
  color: var(--text-muted);
  background: none;
  border: none;
  cursor: pointer;
  border-bottom: 2.5px solid transparent;
  transition: color 0.2s, border-color 0.2s;
}

.nav-tab:hover { color: var(--text-secondary); }

.nav-tab.active {
  color: var(--accent-dark);
  border-bottom-color: var(--accent);
}

/* ========== HEADER ========== */
.hero {
  background: var(--bg-primary);
  border-bottom: 1px solid var(--border-color);
  padding: 3rem 2rem 2.5rem;
  text-align: center;
}

.hero-title {
  font-family: 'Space Grotesk', sans-serif;
  font-size: clamp(2rem, 4vw, 3rem);
  font-weight: 700;
  color: var(--text-primary);
  letter-spacing: -0.03em;
  margin-bottom: 0.5rem;
}

.hero-subtitle {
  font-size: 1.1rem;
  color: var(--text-secondary);
  margin-bottom: 1.5rem;
}

.hero-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  justify-content: center;
}

.hero-tag {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 5px 14px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: 100px;
  font-size: 0.8rem;
  font-weight: 500;
  color: var(--text-secondary);
  font-family: 'JetBrains Mono', monospace;
}

.hero-tag .dot {
  width: 6px; height: 6px;
  border-radius: 50%;
  display: inline-block;
}

/* ========== PAGE CONTAINERS ========== */
.page { display: none; }
.page.active { display: block; }

.page-inner {
  max-width: 1200px;
  margin: 0 auto;
  padding: 2rem;
}

.page-inner.narrow { max-width: 900px; }

/* ========== SECTIONS ========== */
.section {
  margin-bottom: 3rem;
}

.section-alt {
  background: var(--bg-secondary);
  margin-left: -2rem;
  margin-right: -2rem;
  padding: 2.5rem 2rem;
  border-top: 1px solid var(--border-light);
  border-bottom: 1px solid var(--border-light);
}

.section-title {
  font-family: 'Space Grotesk', sans-serif;
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 0.4rem;
  letter-spacing: -0.02em;
}

.section-subtitle {
  font-size: 0.95rem;
  color: var(--text-muted);
  margin-bottom: 1.5rem;
}

/* ========== LEGEND ========== */
.legend-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 2rem;
  margin-bottom: 2rem;
}

@media (max-width: 768px) {
  .legend-grid { grid-template-columns: 1fr; }
}

.legend-card {
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: 12px;
  padding: 1.5rem;
}

.legend-card h3 {
  font-family: 'Space Grotesk', sans-serif;
  font-size: 1rem;
  font-weight: 600;
  margin-bottom: 1rem;
  color: var(--text-primary);
}

.legend-items {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.legend-item {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  font-size: 0.82rem;
  color: var(--text-secondary);
}

.legend-swatch {
  width: 14px; height: 14px;
  border-radius: 3px;
  flex-shrink: 0;
}

.legend-line {
  width: 28px; height: 3px;
  border-radius: 2px;
  flex-shrink: 0;
}

.legend-line.dashed {
  background: repeating-linear-gradient(90deg, currentColor 0 6px, transparent 6px 10px);
  height: 2.5px;
}

/* ========== SVG DIAGRAM ========== */
.diagram-wrap {
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: 16px;
  padding: 1.5rem;
  overflow-x: auto;
  margin-bottom: 2rem;
}

.diagram-wrap svg {
  display: block;
  margin: 0 auto;
  max-width: 100%;
  height: auto;
}

/* ========== COMPONENT CARDS ========== */
.comp-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
  gap: 1rem;
}

.comp-card {
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: 12px;
  padding: 1.25rem 1.25rem 1.25rem 1.25rem;
  position: relative;
  overflow: hidden;
  transition: box-shadow 0.2s;
}

.comp-card:hover {
  box-shadow: 0 4px 20px rgba(0,0,0,0.06);
}

.comp-card::before {
  content: '';
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 4px;
}

.comp-card .comp-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 0.6rem;
}

.comp-icon {
  width: 36px; height: 36px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  flex-shrink: 0;
}

.comp-name {
  font-family: 'Space Grotesk', sans-serif;
  font-weight: 600;
  font-size: 0.95rem;
}

.comp-role {
  font-size: 0.78rem;
  color: var(--text-muted);
}

.comp-desc {
  font-size: 0.87rem;
  color: var(--text-secondary);
  margin-bottom: 0.7rem;
  line-height: 1.6;
}

.comp-bullets {
  list-style: none;
  padding: 0;
  margin-bottom: 0.8rem;
}

.comp-bullets li {
  font-size: 0.82rem;
  color: var(--text-secondary);
  padding-left: 16px;
  position: relative;
  margin-bottom: 4px;
  line-height: 1.5;
}

.comp-bullets li::before {
  content: 'â€º';
  position: absolute;
  left: 0;
  color: var(--text-muted);
  font-weight: 700;
}

.comp-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
}

.comp-tag {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.7rem;
  padding: 2px 8px;
  border-radius: 4px;
  background: var(--bg-secondary);
  color: var(--text-muted);
  border: 1px solid var(--border-color);
}

/* ========== FLOW TABS ========== */
.flow-tabs {
  display: flex;
  gap: 4px;
  margin-bottom: 1.5rem;
  border-bottom: 1px solid var(--border-color);
}

.flow-tab {
  padding: 10px 18px;
  font-size: 0.87rem;
  font-weight: 500;
  color: var(--text-muted);
  background: none;
  border: none;
  cursor: pointer;
  border-bottom: 2.5px solid transparent;
  transition: color 0.2s, border-color 0.2s;
}

.flow-tab:hover { color: var(--text-secondary); }
.flow-tab.active {
  color: var(--accent-dark);
  border-bottom-color: var(--accent);
}

.flow-panel { display: none; }
.flow-panel.active { display: block; }

.flow-steps { position: relative; padding-left: 2rem; }

.flow-step {
  position: relative;
  margin-bottom: 1.2rem;
  padding-bottom: 1.2rem;
  border-bottom: 1px solid var(--border-light);
}

.flow-step:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }

.flow-step::before {
  content: attr(data-step);
  position: absolute;
  left: -2rem;
  top: 2px;
  width: 22px; height: 22px;
  border-radius: 50%;
  background: var(--accent);
  color: #fff;
  font-size: 0.72rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'JetBrains Mono', monospace;
}

.flow-step-title {
  font-weight: 600;
  font-size: 0.92rem;
  margin-bottom: 4px;
}

.flow-step-desc {
  font-size: 0.85rem;
  color: var(--text-secondary);
  line-height: 1.6;
}

.flow-step-tag {
  display: inline-block;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.72rem;
  padding: 1px 7px;
  border-radius: 4px;
  background: var(--accent-light);
  color: var(--accent-dark);
  margin-right: 4px;
}

/* ========== ALGO CARDS ========== */
.algo-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 1rem;
}

.algo-card {
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: 12px;
  padding: 1.5rem;
  transition: box-shadow 0.2s;
}

.algo-card:hover { box-shadow: 0 4px 20px rgba(0,0,0,0.06); }

.algo-badge {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.68rem;
  padding: 2px 8px;
  border-radius: 4px;
  background: var(--accent-light);
  color: var(--accent-dark);
  display: inline-block;
  margin-bottom: 0.6rem;
}

.algo-card h4 {
  font-family: 'Space Grotesk', sans-serif;
  font-size: 1.05rem;
  font-weight: 600;
  margin-bottom: 0.3rem;
}

.algo-card .algo-sub {
  font-size: 0.82rem;
  color: var(--text-muted);
  margin-bottom: 0.8rem;
}

.algo-card p {
  font-size: 0.85rem;
  color: var(--text-secondary);
  margin-bottom: 1rem;
  line-height: 1.6;
}

.algo-proscons {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.algo-pros, .algo-cons {
  font-size: 0.8rem;
  line-height: 1.6;
}

.algo-pros-title, .algo-cons-title {
  font-weight: 600;
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 4px;
}

.algo-pros-title { color: var(--tip-border); }
.algo-cons-title { color: var(--warning-border); }

.algo-pros li, .algo-cons li {
  list-style: none;
  padding-left: 14px;
  position: relative;
  color: var(--text-secondary);
  margin-bottom: 2px;
}

.algo-pros li::before {
  content: '+';
  position: absolute;
  left: 0;
  color: var(--tip-border);
  font-weight: 700;
}

.algo-cons li::before {
  content: 'âˆ’';
  position: absolute;
  left: 0;
  color: var(--warning-border);
  font-weight: 700;
}

/* ========== DESIGN DECISIONS ========== */
.decision-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
  gap: 1rem;
}

.decision-card {
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: 12px;
  padding: 1.25rem;
}

.decision-card h4 {
  font-family: 'Space Grotesk', sans-serif;
  font-weight: 600;
  font-size: 0.95rem;
  margin-bottom: 0.5rem;
  display: flex;
  align-items: center;
  gap: 8px;
}

.decision-card p {
  font-size: 0.85rem;
  color: var(--text-secondary);
  line-height: 1.6;
}

/* ========== CAPACITY DASHBOARD ========== */
.cap-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.cap-card {
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: 12px;
  padding: 1.25rem;
  text-align: center;
}

.cap-value {
  font-family: 'Space Grotesk', sans-serif;
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--accent-dark);
  line-height: 1.2;
}

.cap-unit {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.75rem;
  color: var(--text-muted);
}

.cap-label {
  font-size: 0.82rem;
  color: var(--text-secondary);
  margin-top: 4px;
}

.cap-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.85rem;
}

.cap-table th {
  text-align: left;
  padding: 10px 14px;
  background: var(--bg-secondary);
  font-weight: 600;
  font-size: 0.8rem;
  color: var(--text-secondary);
  border-bottom: 1px solid var(--border-color);
}

.cap-table td {
  padding: 10px 14px;
  border-bottom: 1px solid var(--border-light);
  color: var(--text-secondary);
}

.cap-table tr:last-child td { border-bottom: none; }

.cap-table .mono {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.82rem;
  color: var(--accent-dark);
  font-weight: 500;
}

/* ========== DEEP DIVE PLACEHOLDER ========== */
.placeholder {
  text-align: center;
  padding: 6rem 2rem;
  color: var(--text-muted);
}

.placeholder-icon {
  font-size: 3rem;
  margin-bottom: 1rem;
}

.placeholder h2 {
  font-family: 'Space Grotesk', sans-serif;
  font-size: 1.3rem;
  color: var(--text-secondary);
  margin-bottom: 0.5rem;
}

.placeholder p {
  font-size: 0.95rem;
  max-width: 480px;
  margin: 0 auto;
}

/* ========== RESPONSIVE ========== */
@media (max-width: 640px) {
  .top-nav { padding: 0 1rem; }
  .page-inner { padding: 1.5rem 1rem; }
  .comp-grid { grid-template-columns: 1fr; }
  .decision-grid { grid-template-columns: 1fr; }
  .algo-grid { grid-template-columns: 1fr; }
  .cap-grid { grid-template-columns: 1fr 1fr; }
  .dd-toc-grid { grid-template-columns: 1fr !important; }
  .dd-compare-table { font-size: 0.75rem; }
}

/* ========== DEEP DIVE STYLES ========== */
.dd-toc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.dd-toc-item { display: flex; align-items: center; gap: 10px; padding: 12px 16px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 10px; text-decoration: none; color: var(--text-primary); font-size: 0.88rem; font-weight: 500; transition: border-color 0.2s, box-shadow 0.2s; }
.dd-toc-item:hover { border-color: var(--accent); box-shadow: 0 2px 12px rgba(0,168,225,0.1); }
.dd-toc-num { width: 28px; height: 28px; border-radius: 7px; background: var(--accent-light); color: var(--accent-dark); display: flex; align-items: center; justify-content: center; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; font-weight: 600; flex-shrink: 0; }

.dd-info { border-left: 4px solid; border-radius: 0 10px 10px 0; padding: 1rem 1.25rem; margin: 1.2rem 0; font-size: 0.88rem; line-height: 1.7; }
.dd-info.concept { border-color: var(--concept-border); background: var(--concept-bg); }
.dd-info.important { border-color: var(--important-border); background: var(--important-bg); }
.dd-info.tip { border-color: var(--tip-border); background: var(--tip-bg); }
.dd-info.warning { border-color: var(--warning-border); background: var(--warning-bg); }
.dd-info strong { display: block; margin-bottom: 4px; font-size: 0.82rem; text-transform: uppercase; letter-spacing: 0.04em; }
.dd-info.concept strong { color: var(--concept-border); }
.dd-info.important strong { color: var(--important-border); }
.dd-info.tip strong { color: var(--tip-border); }
.dd-info.warning strong { color: var(--warning-border); }

.dd-section { padding-top: 2.5rem; margin-bottom: 2rem; scroll-margin-top: 72px; }
.dd-section-alt { background: var(--bg-secondary); margin-left: -2rem; margin-right: -2rem; padding: 2.5rem 2rem; border-top: 1px solid var(--border-light); border-bottom: 1px solid var(--border-light); scroll-margin-top: 72px; }
.dd-h2 { font-family: 'Space Grotesk', sans-serif; font-size: 1.4rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.3rem; letter-spacing: -0.02em; }
.dd-h3 { font-family: 'Space Grotesk', sans-serif; font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin: 1.5rem 0 0.6rem; }
.dd-sub { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 1.2rem; }
.dd-text { font-size: 0.9rem; color: var(--text-secondary); line-height: 1.75; margin-bottom: 1rem; }

.dd-code-block { border: 1px solid var(--border-color); border-radius: 10px; overflow: hidden; margin: 1.2rem 0; }
.dd-code-header { display: flex; justify-content: space-between; align-items: center; padding: 8px 16px; background: #e2e8f0; font-family: 'JetBrains Mono', monospace; font-size: 0.72rem; color: var(--text-secondary); font-weight: 500; }
.dd-code-lang { background: var(--bg-primary); padding: 2px 8px; border-radius: 4px; font-size: 0.68rem; }
.dd-code-body { background: #f8fafc; padding: 1rem 1.25rem; overflow-x: auto; user-select: text; -webkit-user-select: text; }
.dd-code-body::selection, .dd-code-body *::selection { background: #bfdbfe; color: #1e293b; }
.dd-code-body pre { margin: 0; font-family: 'JetBrains Mono', monospace; font-size: 0.82rem; line-height: 1.7; color: var(--text-primary); white-space: pre; tab-size: 2; }
.kw { color: #7c3aed; font-weight: 500; } .str { color: #16a34a; } .num { color: #d97706; } .fn { color: #2563eb; } .cm { color: #94a3b8; font-style: italic; } .type { color: #0891b2; } .op { color: #64748b; } .dec { color: #be185d; }

.dd-compare-table { width: 100%; border-collapse: collapse; font-size: 0.84rem; margin: 1.2rem 0; border: 1px solid var(--border-color); border-radius: 10px; overflow: hidden; }
.dd-compare-table th { padding: 10px 14px; background: var(--bg-secondary); font-weight: 600; text-align: left; font-size: 0.8rem; color: var(--text-secondary); border-bottom: 1px solid var(--border-color); }
.dd-compare-table td { padding: 10px 14px; border-bottom: 1px solid var(--border-light); color: var(--text-secondary); vertical-align: top; }
.dd-compare-table tr:last-child td { border-bottom: none; }
.dd-compare-table .mono { font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: var(--accent-dark); }
.dd-compare-table .good { color: var(--tip-border); font-weight: 600; }
.dd-compare-table .mid { color: var(--important-border); font-weight: 600; }
.dd-compare-table .bad { color: var(--warning-border); font-weight: 600; }

.dd-kp-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 1rem; margin: 1.2rem 0; }
.dd-kp-card { background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 10px; padding: 1.1rem; }
.dd-kp-card h4 { font-family: 'Space Grotesk', sans-serif; font-size: 0.92rem; font-weight: 600; margin-bottom: 0.4rem; }
.dd-kp-card p { font-size: 0.82rem; color: var(--text-secondary); line-height: 1.6; }

.dd-accordion { border: 1px solid var(--border-color); border-radius: 10px; overflow: hidden; margin-bottom: 8px; }
.dd-accordion-header { width: 100%; padding: 14px 18px; background: var(--bg-primary); border: none; text-align: left; font-size: 0.9rem; font-weight: 600; color: var(--text-primary); cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-family: 'DM Sans', sans-serif; transition: background 0.15s; }
.dd-accordion-header:hover { background: var(--bg-secondary); }
.dd-accordion-chevron { transition: transform 0.25s; font-size: 0.8rem; color: var(--text-muted); }
.dd-accordion.open .dd-accordion-chevron { transform: rotate(180deg); }
.dd-accordion-body { display: none; padding: 0 18px 16px; font-size: 0.87rem; color: var(--text-secondary); line-height: 1.75; background: var(--bg-primary); }
.dd-accordion.open .dd-accordion-body { display: block; }
.dd-accordion-body ul { padding-left: 1.2rem; margin: 0.5rem 0; }
.dd-accordion-body li { margin-bottom: 4px; }

.dd-svg-wrap { background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.2rem; margin: 1.2rem 0; overflow-x: auto; }
.dd-svg-wrap svg { display: block; margin: 0 auto; max-width: 100%; height: auto; }

.dd-placement-step { display: flex; align-items: flex-start; gap: 14px; padding: 1rem 0; border-bottom: 1px solid var(--border-light); }
.dd-placement-step:last-child { border-bottom: none; }
.dd-placement-num { width: 32px; height: 32px; border-radius: 50%; background: var(--accent); color: #fff; display: flex; align-items: center; justify-content: center; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; font-weight: 700; flex-shrink: 0; }
.dd-placement-text h4 { font-size: 0.92rem; font-weight: 600; margin-bottom: 2px; }
.dd-placement-text p { font-size: 0.84rem; color: var(--text-secondary); line-height: 1.6; }
.back-btn { position: fixed; top: 20px; left: 20px; z-index: 9999; background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-secondary); padding: 10px 20px; font-size: 0.9rem; cursor: pointer; transition: all 0.3s; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; font-family: inherit; border-radius: 8px; }
.back-btn:hover { background: var(--text-primary); color: var(--bg-primary); border-color: var(--text-primary); }
</style>
</head>
<body>
    <a href="../../index.html" class="back-btn">â† è¿”å›é¦–é </a>

<!-- ========== STICKY NAV ========== -->
<nav class="top-nav">
  <a href="#" class="nav-brand" onclick="return false;">
    <div class="nav-brand-icon">â–¶</div>
    Video Streaming â€” System Design
  </a>
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="switchPage('overview', this)">ğŸ“Š Overview</button>
    <button class="nav-tab" onclick="switchPage('deepdive', this)">ğŸ“š Deep Dive</button>
  </div>
</nav>

<!-- ========== HERO ========== -->
<header class="hero">
  <h1 class="hero-title">Amazon Prime Video</h1>
  <p class="hero-subtitle">å¤§è¦æ¨¡å½±éŸ³ä¸²æµå¹³å°ç³»çµ±è¨­è¨ˆ â€” Video Streaming Platform Architecture</p>
  <div class="hero-tags">
    <span class="hero-tag"><span class="dot" style="background:var(--cdn)"></span>CDN</span>
    <span class="hero-tag"><span class="dot" style="background:var(--queue)"></span>Processing Queue</span>
    <span class="hero-tag"><span class="dot" style="background:var(--encoder)"></span>Video Encoding</span>
    <span class="hero-tag"><span class="dot" style="background:var(--search)"></span>Elasticsearch</span>
    <span class="hero-tag"><span class="dot" style="background:var(--cache)"></span>Cache</span>
    <span class="hero-tag"><span class="dot" style="background:var(--storage)"></span>Object Store (S3)</span>
    <span class="hero-tag"><span class="dot" style="background:var(--database)"></span>Metadata DB</span>
    <span class="hero-tag"><span class="dot" style="background:var(--lb)"></span>Load Balancer</span>
  </div>
</header>

<!-- ==================== PAGE 1: OVERVIEW ==================== -->
<div id="page-overview" class="page active">
<div class="page-inner">

<!-- ===== 1.1 LEGENDS ===== -->
<section class="section">
  <h2 class="section-title">åœ–ä¾‹èªªæ˜ Legends</h2>
  <p class="section-subtitle">å…ƒä»¶èˆ‡é€£ç·šçš„è‰²å½©å°æ‡‰ â€” Color coding for components and connections</p>

  <div class="legend-grid">
    <!-- Component Legend -->
    <div class="legend-card">
      <h3>å…ƒä»¶åœ–ä¾‹ Component Legend</h3>
      <div class="legend-items">
        <span class="legend-item"><span class="legend-swatch" style="background:var(--client)"></span>Clientï¼ˆç”¨æˆ¶ç«¯ï¼‰</span>
        <span class="legend-item"><span class="legend-swatch" style="background:var(--lb)"></span>Load Balancer</span>
        <span class="legend-item"><span class="legend-swatch" style="background:var(--services)"></span>Servicesï¼ˆæœå‹™ï¼‰</span>
        <span class="legend-item"><span class="legend-swatch" style="background:var(--queue)"></span>Queueï¼ˆè¨Šæ¯ä½‡åˆ—ï¼‰</span>
        <span class="legend-item"><span class="legend-swatch" style="background:var(--encoder)"></span>Encoderï¼ˆç·¨ç¢¼å™¨ï¼‰</span>
        <span class="legend-item"><span class="legend-swatch" style="background:var(--cache)"></span>Cacheï¼ˆå¿«å–ï¼‰</span>
        <span class="legend-item"><span class="legend-swatch" style="background:var(--search)"></span>Searchï¼ˆæœå°‹ï¼‰</span>
        <span class="legend-item"><span class="legend-swatch" style="background:var(--storage)"></span>Object Store</span>
        <span class="legend-item"><span class="legend-swatch" style="background:var(--database)"></span>Databaseï¼ˆè³‡æ–™åº«ï¼‰</span>
        <span class="legend-item"><span class="legend-swatch" style="background:var(--cdn)"></span>CDN</span>
      </div>
    </div>
    <!-- Line Legend -->
    <div class="legend-card">
      <h3>é€£ç·šèªªæ˜ Connection Legend</h3>
      <div class="legend-items" style="flex-direction:column; gap:8px;">
        <span class="legend-item"><span class="legend-line" style="background:var(--text-muted)"></span>åŒæ­¥è«‹æ±‚ Sync Requestï¼ˆç°ï¼‰</span>
        <span class="legend-item"><span class="legend-line" style="background:var(--queue)"></span>å¯«å…¥è·¯å¾‘ Write Pathï¼ˆç´…ï¼‰</span>
        <span class="legend-item"><span class="legend-line" style="background:var(--cache)"></span>å¿«å–è®€å¯« Cache R/Wï¼ˆæ©™ï¼‰</span>
        <span class="legend-item"><span class="legend-line" style="background:var(--search)"></span>æœå°‹æŸ¥è©¢ Search Queryï¼ˆé’ï¼‰</span>
        <span class="legend-item"><span class="legend-line" style="background:var(--services)"></span>DB è®€å¯« DB Read/Writeï¼ˆç¶ ï¼‰</span>
        <span class="legend-item"><span class="legend-line" style="background:var(--cdn)"></span>CDN / éœæ…‹è³‡æºï¼ˆè—ç¶ ï¼‰</span>
        <span class="legend-item"><span class="legend-line" style="background:var(--storage)"></span>Object Storeï¼ˆé›è—ï¼‰</span>
        <span class="legend-item"><span class="legend-line dashed" style="color:var(--encoder)"></span>éåŒæ­¥è™•ç† Asyncï¼ˆæ©˜è™›ç·šï¼‰</span>
      </div>
    </div>
  </div>
</section>

<!-- ===== 1.2 SVG DIAGRAM ===== -->
<section class="section">
  <h2 class="section-title">ç³»çµ±æ¶æ§‹åœ– Architecture Diagram</h2>
  <p class="section-subtitle">äº’å‹•å¼æ¶æ§‹æ¦‚è¦½ â€” Hover é€£ç·šæŸ¥çœ‹èªªæ˜</p>

  <div class="diagram-wrap">
    <svg viewBox="0 0 1120 760" xmlns="http://www.w3.org/2000/svg" font-family="'DM Sans', sans-serif">
      <defs>
        <filter id="shadow" x="-4%" y="-4%" width="108%" height="112%">
          <feDropShadow dx="0" dy="2" stdDeviation="3" flood-opacity="0.07"/>
        </filter>
        <!-- Arrow markers -->
        <marker id="arr-gray" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6Z" fill="#94a3b8"/></marker>
        <marker id="arr-red" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6Z" fill="#ef4444"/></marker>
        <marker id="arr-green" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6Z" fill="#10b981"/></marker>
        <marker id="arr-cyan" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6Z" fill="#06b6d4"/></marker>
        <marker id="arr-orange" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6Z" fill="#f59e0b"/></marker>
        <marker id="arr-indigo" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6Z" fill="#6366f1"/></marker>
        <marker id="arr-teal" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6Z" fill="#14b8a6"/></marker>
        <marker id="arr-pink" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6Z" fill="#ec4899"/></marker>
        <marker id="arr-encoder" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6Z" fill="#f97316"/></marker>
        <marker id="arr-lb" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6Z" fill="#8b5cf6"/></marker>
      </defs>

      <!-- Tier labels -->
      <text x="16" y="24" font-size="10" fill="#94a3b8" font-weight="600" letter-spacing="0.08em" font-family="'JetBrains Mono', monospace">CLIENTS</text>
      <line x1="80" y1="20" x2="1100" y2="20" stroke="#e2e8f0" stroke-width="1" stroke-dasharray="4,4"/>

      <text x="16" y="190" font-size="10" fill="#94a3b8" font-weight="600" letter-spacing="0.08em" font-family="'JetBrains Mono', monospace">GATEWAY</text>
      <line x1="90" y1="186" x2="1100" y2="186" stroke="#e2e8f0" stroke-width="1" stroke-dasharray="4,4"/>

      <text x="16" y="330" font-size="10" fill="#94a3b8" font-weight="600" letter-spacing="0.08em" font-family="'JetBrains Mono', monospace">SERVICES</text>
      <line x1="90" y1="326" x2="1100" y2="326" stroke="#e2e8f0" stroke-width="1" stroke-dasharray="4,4"/>

      <text x="16" y="510" font-size="10" fill="#94a3b8" font-weight="600" letter-spacing="0.08em" font-family="'JetBrains Mono', monospace">PROCESSING</text>
      <line x1="105" y1="506" x2="1100" y2="506" stroke="#e2e8f0" stroke-width="1" stroke-dasharray="4,4"/>

      <text x="16" y="650" font-size="10" fill="#94a3b8" font-weight="600" letter-spacing="0.08em" font-family="'JetBrains Mono', monospace">DATA LAYER</text>
      <line x1="105" y1="646" x2="1100" y2="646" stroke="#e2e8f0" stroke-width="1" stroke-dasharray="4,4"/>

      <!-- ===== NODES ===== -->
      <!-- Content Creators -->
      <g filter="url(#shadow)">
        <rect x="60" y="50" width="150" height="54" rx="8" fill="#fff" stroke="#3b82f6" stroke-width="1.5"/>
        <rect x="60" y="50" width="5" height="54" rx="3" fill="#3b82f6"/>
        <text x="135" y="72" text-anchor="middle" font-size="12" font-weight="600" fill="#1e293b">Content Creators</text>
        <text x="135" y="90" text-anchor="middle" font-size="9" fill="#94a3b8" font-family="'JetBrains Mono', monospace">ä¸Šå‚³è€… Uploaders</text>
      </g>

      <!-- Viewers -->
      <g filter="url(#shadow)">
        <rect x="60" y="120" width="150" height="54" rx="8" fill="#fff" stroke="#3b82f6" stroke-width="1.5"/>
        <rect x="60" y="120" width="5" height="54" rx="3" fill="#3b82f6"/>
        <text x="135" y="142" text-anchor="middle" font-size="12" font-weight="600" fill="#1e293b">Viewers</text>
        <text x="135" y="160" text-anchor="middle" font-size="9" fill="#94a3b8" font-family="'JetBrains Mono', monospace">è§€çœ‹è€… Watchers</text>
      </g>

      <!-- Load Balancer -->
      <g filter="url(#shadow)">
        <rect x="300" y="85" width="150" height="54" rx="8" fill="#fff" stroke="#8b5cf6" stroke-width="1.5"/>
        <rect x="300" y="85" width="5" height="54" rx="3" fill="#8b5cf6"/>
        <text x="375" y="107" text-anchor="middle" font-size="12" font-weight="600" fill="#1e293b">Load Balancer</text>
        <text x="375" y="125" text-anchor="middle" font-size="9" fill="#94a3b8" font-family="'JetBrains Mono', monospace">è² è¼‰å‡è¡¡å™¨ L7 LB</text>
      </g>

      <!-- Upload Video Service -->
      <g filter="url(#shadow)">
        <rect x="200" y="350" width="160" height="54" rx="8" fill="#fff" stroke="#10b981" stroke-width="1.5"/>
        <rect x="200" y="350" width="5" height="54" rx="3" fill="#10b981"/>
        <text x="280" y="372" text-anchor="middle" font-size="11" font-weight="600" fill="#1e293b">Upload Video Service</text>
        <text x="280" y="390" text-anchor="middle" font-size="9" fill="#94a3b8" font-family="'JetBrains Mono', monospace">å½±ç‰‡ä¸Šå‚³æœå‹™</text>
      </g>

      <!-- Video Splitter -->
      <g filter="url(#shadow)">
        <rect x="410" y="350" width="150" height="54" rx="8" fill="#fff" stroke="#10b981" stroke-width="1.5"/>
        <rect x="410" y="350" width="5" height="54" rx="3" fill="#10b981"/>
        <text x="485" y="372" text-anchor="middle" font-size="11" font-weight="600" fill="#1e293b">Video Splitter</text>
        <text x="485" y="390" text-anchor="middle" font-size="9" fill="#94a3b8" font-family="'JetBrains Mono', monospace">å½±ç‰‡åˆ‡å‰²å™¨</text>
      </g>

      <!-- Search Service -->
      <g filter="url(#shadow)">
        <rect x="610" y="350" width="150" height="54" rx="8" fill="#fff" stroke="#06b6d4" stroke-width="1.5"/>
        <rect x="610" y="350" width="5" height="54" rx="3" fill="#06b6d4"/>
        <text x="685" y="372" text-anchor="middle" font-size="11" font-weight="600" fill="#1e293b">Search Service</text>
        <text x="685" y="390" text-anchor="middle" font-size="9" fill="#94a3b8" font-family="'JetBrains Mono', monospace">æœå°‹æœå‹™</text>
      </g>

      <!-- View Video Service -->
      <g filter="url(#shadow)">
        <rect x="810" y="350" width="160" height="54" rx="8" fill="#fff" stroke="#10b981" stroke-width="1.5"/>
        <rect x="810" y="350" width="5" height="54" rx="3" fill="#10b981"/>
        <text x="890" y="372" text-anchor="middle" font-size="11" font-weight="600" fill="#1e293b">View Video Service</text>
        <text x="890" y="390" text-anchor="middle" font-size="9" fill="#94a3b8" font-family="'JetBrains Mono', monospace">å½±ç‰‡è§€çœ‹æœå‹™</text>
      </g>

      <!-- Processing Queue -->
      <g filter="url(#shadow)">
        <rect x="280" y="520" width="160" height="54" rx="8" fill="#fff" stroke="#ef4444" stroke-width="1.5"/>
        <rect x="280" y="520" width="5" height="54" rx="3" fill="#ef4444"/>
        <text x="360" y="542" text-anchor="middle" font-size="11" font-weight="600" fill="#1e293b">Processing Queue</text>
        <text x="360" y="560" text-anchor="middle" font-size="9" fill="#94a3b8" font-family="'JetBrains Mono', monospace">è™•ç†ä½‡åˆ— Kafka / SQS</text>
      </g>

      <!-- Video Encoder -->
      <g filter="url(#shadow)">
        <rect x="520" y="520" width="150" height="54" rx="8" fill="#fff" stroke="#f97316" stroke-width="1.5"/>
        <rect x="520" y="520" width="5" height="54" rx="3" fill="#f97316"/>
        <text x="595" y="542" text-anchor="middle" font-size="11" font-weight="600" fill="#1e293b">Video Encoder</text>
        <text x="595" y="560" text-anchor="middle" font-size="9" fill="#94a3b8" font-family="'JetBrains Mono', monospace">å½±ç‰‡ç·¨ç¢¼å™¨ FFmpeg</text>
      </g>

      <!-- Elasticsearch -->
      <g filter="url(#shadow)">
        <rect x="620" y="520" width="190" height="54" rx="8" fill="#fff" stroke="#06b6d4" stroke-width="1.5"/>
        <rect x="620" y="520" width="5" height="54" rx="3" fill="#06b6d4"/>
        <text x="715" y="542" text-anchor="middle" font-size="11" font-weight="600" fill="#1e293b">Elasticsearch Video API</text>
        <text x="715" y="560" text-anchor="middle" font-size="9" fill="#94a3b8" font-family="'JetBrains Mono', monospace">å…¨æ–‡æœå°‹å¼•æ“</text>
      </g>

      <!-- Cache -->
      <g filter="url(#shadow)">
        <rect x="860" y="520" width="130" height="54" rx="8" fill="#fff" stroke="#f59e0b" stroke-width="1.5"/>
        <rect x="860" y="520" width="5" height="54" rx="3" fill="#f59e0b"/>
        <text x="925" y="542" text-anchor="middle" font-size="12" font-weight="600" fill="#1e293b">Cache</text>
        <text x="925" y="560" text-anchor="middle" font-size="9" fill="#94a3b8" font-family="'JetBrains Mono', monospace">å¿«å– Redis</text>
      </g>

      <!-- Object Store (S3) -->
      <g filter="url(#shadow)">
        <rect x="150" y="670" width="160" height="54" rx="8" fill="#fff" stroke="#6366f1" stroke-width="1.5"/>
        <rect x="150" y="670" width="5" height="54" rx="3" fill="#6366f1"/>
        <text x="230" y="692" text-anchor="middle" font-size="12" font-weight="600" fill="#1e293b">Object Store (S3)</text>
        <text x="230" y="710" text-anchor="middle" font-size="9" fill="#94a3b8" font-family="'JetBrains Mono', monospace">ç‰©ä»¶å„²å­˜ AWS S3</text>
      </g>

      <!-- Metadata DB -->
      <g filter="url(#shadow)">
        <rect x="530" y="670" width="160" height="54" rx="8" fill="#fff" stroke="#ec4899" stroke-width="1.5"/>
        <rect x="530" y="670" width="5" height="54" rx="3" fill="#ec4899"/>
        <text x="610" y="692" text-anchor="middle" font-size="12" font-weight="600" fill="#1e293b">Metadata DB</text>
        <text x="610" y="710" text-anchor="middle" font-size="9" fill="#94a3b8" font-family="'JetBrains Mono', monospace">ä¸­ç¹¼è³‡æ–™åº« PostgreSQL</text>
      </g>

      <!-- CDN -->
      <g filter="url(#shadow)">
        <rect x="870" y="670" width="130" height="54" rx="8" fill="#fff" stroke="#14b8a6" stroke-width="1.5"/>
        <rect x="870" y="670" width="5" height="54" rx="3" fill="#14b8a6"/>
        <text x="935" y="692" text-anchor="middle" font-size="12" font-weight="600" fill="#1e293b">CDN</text>
        <text x="935" y="710" text-anchor="middle" font-size="9" fill="#94a3b8" font-family="'JetBrains Mono', monospace">CloudFront</text>
      </g>

      <!-- ===== CONNECTIONS ===== -->
      <!-- Content Creators â†’ Load Balancer -->
      <line x1="210" y1="77" x2="300" y2="105" stroke="#94a3b8" stroke-width="2" marker-end="url(#arr-gray)"/>
      <text x="248" y="85" font-size="8" fill="#94a3b8" font-family="'JetBrains Mono', monospace">HTTP</text>

      <!-- Viewers â†’ Load Balancer -->
      <line x1="210" y1="147" x2="300" y2="119" stroke="#94a3b8" stroke-width="2" marker-end="url(#arr-gray)"/>
      <text x="248" y="142" font-size="8" fill="#94a3b8" font-family="'JetBrains Mono', monospace">HTTP</text>

      <!-- LB â†’ Upload Video Service -->
      <path d="M 340 139 L 340 270 L 280 270 L 280 350" stroke="#8b5cf6" stroke-width="2" fill="none" marker-end="url(#arr-lb)"/>
      <text x="295" y="265" font-size="8" fill="#8b5cf6" font-family="'JetBrains Mono', monospace">route</text>

      <!-- LB â†’ Video Splitter -->
      <path d="M 375 139 L 375 270 L 485 270 L 485 350" stroke="#8b5cf6" stroke-width="2" fill="none" marker-end="url(#arr-lb)"/>
      <text x="430" y="265" font-size="8" fill="#8b5cf6" font-family="'JetBrains Mono', monospace">route</text>

      <!-- LB â†’ Search Service -->
      <path d="M 410 139 L 410 280 L 685 280 L 685 350" stroke="#8b5cf6" stroke-width="2" fill="none" marker-end="url(#arr-lb)"/>
      <text x="548" y="275" font-size="8" fill="#8b5cf6" font-family="'JetBrains Mono', monospace">route</text>

      <!-- LB â†’ View Video Service -->
      <path d="M 440 139 L 440 290 L 890 290 L 890 350" stroke="#8b5cf6" stroke-width="2" fill="none" marker-end="url(#arr-lb)"/>
      <text x="665" y="285" font-size="8" fill="#8b5cf6" font-family="'JetBrains Mono', monospace">route</text>

      <!-- Upload Video Service â†’ Object Store (S3) -->
      <path d="M 230 404 L 230 670" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arr-indigo)"/>
      <text x="236" y="545" font-size="8" fill="#6366f1" font-family="'JetBrains Mono', monospace" transform="rotate(-90, 236, 545)">raw upload</text>

      <!-- Upload Video Service â†’ Processing Queue -->
      <path d="M 310 404 L 310 460 L 360 460 L 360 520" stroke="#ef4444" stroke-width="2" fill="none" marker-end="url(#arr-red)"/>
      <text x="316" y="458" font-size="8" fill="#ef4444" font-family="'JetBrains Mono', monospace">enqueue</text>

      <!-- Video Splitter â†’ Processing Queue -->
      <path d="M 485 404 L 485 460 L 400 460 L 400 520" stroke="#ef4444" stroke-width="2" fill="none" marker-end="url(#arr-red)"/>
      <text x="440" y="453" font-size="8" fill="#ef4444" font-family="'JetBrains Mono', monospace">chunks</text>

      <!-- Processing Queue â†’ Video Encoder -->
      <line x1="440" y1="547" x2="520" y2="547" stroke="#f97316" stroke-width="2" stroke-dasharray="6,3" marker-end="url(#arr-encoder)"/>
      <text x="470" y="540" font-size="8" fill="#f97316" font-family="'JetBrains Mono', monospace">dequeue</text>

      <!-- Video Encoder â†’ Object Store (S3) -->
      <path d="M 545 574 L 545 620 L 290 620 L 290 670" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arr-indigo)"/>
      <text x="420" y="615" font-size="8" fill="#6366f1" font-family="'JetBrains Mono', monospace">encoded videos</text>

      <!-- Video Encoder â†’ Metadata DB -->
      <path d="M 620 574 L 620 670" stroke="#ec4899" stroke-width="2" fill="none" marker-end="url(#arr-pink)"/>
      <text x="626" y="630" font-size="8" fill="#ec4899" font-family="'JetBrains Mono', monospace" transform="rotate(-90, 626, 630)">write meta</text>

      <!-- Search Service â†’ Elasticsearch -->
      <line x1="685" y1="404" x2="710" y2="520" stroke="#06b6d4" stroke-width="2" marker-end="url(#arr-cyan)"/>
      <text x="690" y="465" font-size="8" fill="#06b6d4" font-family="'JetBrains Mono', monospace">query</text>

      <!-- View Video Service â†’ Cache -->
      <line x1="925" y1="404" x2="925" y2="520" stroke="#f59e0b" stroke-width="2" marker-end="url(#arr-orange)"/>
      <text x="932" y="465" font-size="8" fill="#f59e0b" font-family="'JetBrains Mono', monospace">read</text>

      <!-- Cache â†’ Metadata DB -->
      <path d="M 860" y1="555" x2="690" y2="685" stroke="none"/>
      <path d="M 860 555 L 780 555 L 780 697 L 690 697" stroke="#10b981" stroke-width="2" stroke-dasharray="6,3" fill="none" marker-end="url(#arr-green)"/>
      <text x="785" y="630" font-size="8" fill="#10b981" font-family="'JetBrains Mono', monospace" transform="rotate(-90, 785, 630)">cache miss</text>

      <!-- Viewers â† CDN -->
      <path d="M 935 670 L 935 640 L 100 640 L 100 174" stroke="#14b8a6" stroke-width="2" fill="none" marker-end="url(#arr-teal)"/>
      <text x="520" y="635" font-size="8" fill="#14b8a6" font-family="'JetBrains Mono', monospace">stream video to viewer</text>

      <!-- CDN â† Object Store (origin pull) -->
      <path d="M 310 710 L 550 710 L 550 730 L 870 730 L 870 710" stroke="#14b8a6" stroke-width="2" stroke-dasharray="6,3" fill="none" marker-end="url(#arr-teal)"/>
      <text x="590" y="743" font-size="8" fill="#14b8a6" font-family="'JetBrains Mono', monospace">origin pull</text>

      <!-- Elasticsearch â†’ Metadata DB (CDC / indexing) -->
      <path d="M 700 574 L 700 620 L 660 620 L 660 670" stroke="#06b6d4" stroke-width="2" stroke-dasharray="6,3" fill="none" marker-end="url(#arr-cyan)"/>
      <text x="660" y="610" font-size="8" fill="#06b6d4" font-family="'JetBrains Mono', monospace">CDC sync</text>

    </svg>
  </div>
</section>

<!-- ===== 1.3 COMPONENT DESCRIPTIONS ===== -->
<section class="section">
  <h2 class="section-title">å…ƒä»¶èˆ‡æœå‹™èªªæ˜ Component Descriptions</h2>
  <p class="section-subtitle">å„å…ƒä»¶çš„è·è²¬ã€äº’å‹•æ–¹å¼èˆ‡æ“´å±•ç­–ç•¥</p>

  <div class="comp-grid">

    <!-- Content Creators -->
    <div class="comp-card" style="--c:var(--client)">
      <style>.comp-card[style*="--client"]::before{background:var(--client)}</style>
      <div class="comp-header">
        <div class="comp-icon" style="background:#eff6ff;color:var(--client)">ğŸ¬</div>
        <div><div class="comp-name">Content Creators</div><div class="comp-role">ç”¨æˆ¶ç«¯ â€” å…§å®¹ä¸Šå‚³è€…</div></div>
      </div>
      <p class="comp-desc">å½±ç‰‡ä¸Šå‚³è€…é€éå®¢æˆ¶ç«¯ï¼ˆWeb / Appï¼‰å°‡åŸå§‹å½±ç‰‡æª”æ¡ˆä¸Šå‚³è‡³å¹³å°ã€‚</p>
      <ul class="comp-bullets">
        <li>ä½¿ç”¨ presigned URL ç›´æ¥ä¸Šå‚³è‡³ S3ï¼Œæ¸›å°‘ä¼ºæœå™¨è² æ“”</li>
        <li>æ”¯æ´æ–·é»çºŒå‚³ï¼ˆresumable uploadï¼‰æå‡å¯é æ€§</li>
        <li>ä¸Šå‚³å¾Œè§¸ç™¼ Processing Queue é€²è¡Œè½‰ç¢¼</li>
      </ul>
      <div class="comp-tags"><span class="comp-tag">Web</span><span class="comp-tag">Mobile App</span><span class="comp-tag">tus.io</span></div>
    </div>

    <!-- Viewers -->
    <div class="comp-card" style="--c:var(--client)">
      <style>.comp-card:nth-child(2)::before{background:var(--client)}</style>
      <div class="comp-header">
        <div class="comp-icon" style="background:#eff6ff;color:var(--client)">ğŸ‘ï¸</div>
        <div><div class="comp-name">Viewers</div><div class="comp-role">ç”¨æˆ¶ç«¯ â€” è§€çœ‹è€…</div></div>
      </div>
      <p class="comp-desc">è§€çœ‹è€…å¾ CDN é‚Šç·£ç¯€é»å–å¾—å½±ç‰‡ä¸²æµï¼Œäº«å—ä½å»¶é²æ’­æ”¾é«”é©—ã€‚</p>
      <ul class="comp-bullets">
        <li>ä½¿ç”¨ ABRï¼ˆAdaptive Bitrateï¼‰è‡ªå‹•åˆ‡æ›è§£æåº¦</li>
        <li>æœå°‹è«‹æ±‚èµ° Search Service â†’ Elasticsearch</li>
        <li>å½±ç‰‡ metadata ç”± View Video Service ç¶“ Cache å–å¾—</li>
      </ul>
      <div class="comp-tags"><span class="comp-tag">HLS / DASH</span><span class="comp-tag">Multi-device</span></div>
    </div>

    <!-- Load Balancer -->
    <div class="comp-card">
      <style>.comp-card:nth-child(3)::before{background:var(--lb)}</style>
      <div class="comp-header">
        <div class="comp-icon" style="background:#f5f3ff;color:var(--lb)">âš–ï¸</div>
        <div><div class="comp-name">Load Balancer</div><div class="comp-role">L7 è² è¼‰å‡è¡¡å™¨</div></div>
      </div>
      <p class="comp-desc">å°‡è«‹æ±‚æ ¹æ“šè·¯å¾‘è·¯ç”±åˆ°å°æ‡‰çš„å¾Œç«¯æœå‹™ï¼Œä¸¦åˆ†æ•£æµé‡è‡³å¤šå€‹æœå‹™å¯¦ä¾‹ã€‚</p>
      <ul class="comp-bullets">
        <li>/upload â†’ Upload Video Service</li>
        <li>/search â†’ Search Service</li>
        <li>/watch â†’ View Video Service</li>
        <li>æ”¯æ´å¥åº·æª¢æŸ¥èˆ‡è‡ªå‹•ç§»é™¤ä¸å¥åº·ç¯€é»</li>
      </ul>
      <div class="comp-tags"><span class="comp-tag">NGINX</span><span class="comp-tag">ALB</span><span class="comp-tag">L7 Routing</span></div>
    </div>

    <!-- Upload Video Service -->
    <div class="comp-card">
      <style>.comp-card:nth-child(4)::before{background:var(--services)}</style>
      <div class="comp-header">
        <div class="comp-icon" style="background:#ecfdf5;color:var(--services)">ğŸ“¤</div>
        <div><div class="comp-name">Upload Video Service</div><div class="comp-role">å½±ç‰‡ä¸Šå‚³æœå‹™</div></div>
      </div>
      <p class="comp-desc">æ¥æ”¶ä¸Šå‚³è«‹æ±‚ï¼Œå°‡åŸå§‹å½±ç‰‡å­˜å…¥ Object Storeï¼Œä¸¦å°‡è½‰ç¢¼ä»»å‹™æ¨å…¥ Processing Queueã€‚</p>
      <ul class="comp-bullets">
        <li>ç”¢ç”Ÿ presigned URL è®“å®¢æˆ¶ç«¯ç›´å‚³ S3</li>
        <li>é©—è­‰å½±ç‰‡æ ¼å¼ã€å¤§å°é™åˆ¶</li>
        <li>å¯«å…¥åˆå§‹ metadata è¨˜éŒ„</li>
        <li>æ°´å¹³æ“´å±•ä»¥æ‡‰å°é«˜å³°ä¸Šå‚³æµé‡</li>
      </ul>
      <div class="comp-tags"><span class="comp-tag">Go / Java</span><span class="comp-tag">S3 SDK</span><span class="comp-tag">Kafka Producer</span></div>
    </div>

    <!-- Video Splitter -->
    <div class="comp-card">
      <style>.comp-card:nth-child(5)::before{background:var(--services)}</style>
      <div class="comp-header">
        <div class="comp-icon" style="background:#ecfdf5;color:var(--services)">âœ‚ï¸</div>
        <div><div class="comp-name">Video Splitter</div><div class="comp-role">å½±ç‰‡åˆ‡å‰²å™¨</div></div>
      </div>
      <p class="comp-desc">å°‡å¤§å‹å½±ç‰‡åˆ‡å‰²ç‚ºè¼ƒå°çš„ chunkï¼Œå¹³è¡Œè™•ç†åŠ é€Ÿè½‰ç¢¼æµç¨‹ã€‚</p>
      <ul class="comp-bullets">
        <li>ä¾ GOPï¼ˆGroup of Picturesï¼‰é‚Šç•Œåˆ‡å‰²</li>
        <li>æ¯å€‹ chunk ç¨ç«‹æ¨å…¥ Processing Queue</li>
        <li>æ¸›å°‘å–®ä¸€è½‰ç¢¼ä»»å‹™çš„è™•ç†æ™‚é–“</li>
      </ul>
      <div class="comp-tags"><span class="comp-tag">FFmpeg</span><span class="comp-tag">GOP Splitting</span></div>
    </div>

    <!-- Search Service -->
    <div class="comp-card">
      <style>.comp-card:nth-child(6)::before{background:var(--search)}</style>
      <div class="comp-header">
        <div class="comp-icon" style="background:#ecfeff;color:var(--search)">ğŸ”</div>
        <div><div class="comp-name">Search Service</div><div class="comp-role">æœå°‹æœå‹™</div></div>
      </div>
      <p class="comp-desc">è™•ç†è§€çœ‹è€…çš„æœå°‹æŸ¥è©¢ï¼Œå‘¼å« Elasticsearch é€²è¡Œå…¨æ–‡æœå°‹èˆ‡ç›¸é—œæ€§æ’åºã€‚</p>
      <ul class="comp-bullets">
        <li>æ”¯æ´æ¨¡ç³Šæœå°‹ã€è‡ªå‹•è£œå…¨ã€ç¯©é¸</li>
        <li>çµæœä¾ç›¸é—œæ€§èˆ‡å—æ­¡è¿åº¦æ’åº</li>
        <li>Elasticsearch é€é CDC åŒæ­¥ Metadata DB è³‡æ–™</li>
      </ul>
      <div class="comp-tags"><span class="comp-tag">Elasticsearch</span><span class="comp-tag">CDC</span><span class="comp-tag">BM25</span></div>
    </div>

    <!-- View Video Service -->
    <div class="comp-card">
      <style>.comp-card:nth-child(7)::before{background:var(--services)}</style>
      <div class="comp-header">
        <div class="comp-icon" style="background:#ecfdf5;color:var(--services)">ğŸ“º</div>
        <div><div class="comp-name">View Video Service</div><div class="comp-role">å½±ç‰‡è§€çœ‹æœå‹™</div></div>
      </div>
      <p class="comp-desc">æä¾›å½±ç‰‡ metadataã€æ’­æ”¾ URLã€ä»¥åŠæ¨è–¦æ¸…å–®çµ¦è§€çœ‹è€…ã€‚</p>
      <ul class="comp-bullets">
        <li>å…ˆæŸ¥ Cacheï¼ˆRedisï¼‰ï¼Œcache miss å†æŸ¥ Metadata DB</li>
        <li>å›å‚³ CDN ç°½å URL ä¾›å®¢æˆ¶ç«¯ä¸²æµæ’­æ”¾</li>
        <li>è¨˜éŒ„è§€çœ‹æ­·å²èˆ‡æ’­æ”¾é€²åº¦</li>
      </ul>
      <div class="comp-tags"><span class="comp-tag">Redis</span><span class="comp-tag">CDN Signed URL</span></div>
    </div>

    <!-- Processing Queue -->
    <div class="comp-card">
      <style>.comp-card:nth-child(8)::before{background:var(--queue)}</style>
      <div class="comp-header">
        <div class="comp-icon" style="background:#fef2f2;color:var(--queue)">ğŸ“¬</div>
        <div><div class="comp-name">Processing Queue</div><div class="comp-role">è™•ç†ä½‡åˆ—</div></div>
      </div>
      <p class="comp-desc">è§£è€¦ä¸Šå‚³æœå‹™èˆ‡è½‰ç¢¼æœå‹™ï¼Œæä¾›å¯é çš„éåŒæ­¥ä»»å‹™åˆ†ç™¼ã€‚</p>
      <ul class="comp-bullets">
        <li>ä¿è­‰ at-least-once æŠ•éï¼Œç¢ºä¿å½±ç‰‡ä¸æœƒéºå¤±</li>
        <li>æ”¯æ´å„ªå…ˆç´šä½‡åˆ—ï¼ˆPremium ç”¨æˆ¶å„ªå…ˆè½‰ç¢¼ï¼‰</li>
        <li>åœ¨æµé‡é«˜å³°æ™‚ä½œç‚ºç·©è¡ï¼Œé˜²æ­¢ Encoder éè¼‰</li>
      </ul>
      <div class="comp-tags"><span class="comp-tag">Apache Kafka</span><span class="comp-tag">Amazon SQS</span></div>
    </div>

    <!-- Video Encoder -->
    <div class="comp-card">
      <style>.comp-card:nth-child(9)::before{background:var(--encoder)}</style>
      <div class="comp-header">
        <div class="comp-icon" style="background:#fff7ed;color:var(--encoder)">ğŸï¸</div>
        <div><div class="comp-name">Video Encoder</div><div class="comp-role">å½±ç‰‡ç·¨ç¢¼å™¨</div></div>
      </div>
      <p class="comp-desc">å¾ Queue æ¶ˆè²»ä»»å‹™ï¼Œå°‡åŸå§‹å½±ç‰‡è½‰ç¢¼ç‚ºå¤šç¨®è§£æåº¦èˆ‡æ ¼å¼ã€‚</p>
      <ul class="comp-bullets">
        <li>ç”¢ç”Ÿ 240p / 360p / 480p / 720p / 1080p / 4K ç‰ˆæœ¬</li>
        <li>è¼¸å‡º HLS / DASH segment ä¾› ABR ä¸²æµ</li>
        <li>ç·¨ç¢¼å®Œæˆå¾Œå¯«å…¥ Object Store ä¸¦æ›´æ–° Metadata DB</li>
        <li>GPU åŠ é€Ÿè½‰ç¢¼ï¼ŒæŒ‰éœ€è‡ªå‹•æ“´å±• worker æ•¸é‡</li>
      </ul>
      <div class="comp-tags"><span class="comp-tag">FFmpeg</span><span class="comp-tag">H.264/H.265</span><span class="comp-tag">GPU</span></div>
    </div>

    <!-- Elasticsearch -->
    <div class="comp-card">
      <style>.comp-card:nth-child(10)::before{background:var(--search)}</style>
      <div class="comp-header">
        <div class="comp-icon" style="background:#ecfeff;color:var(--search)">ğŸ“‡</div>
        <div><div class="comp-name">Elasticsearch Video API</div><div class="comp-role">å…¨æ–‡æœå°‹å¼•æ“</div></div>
      </div>
      <p class="comp-desc">å„²å­˜å½±ç‰‡ metadata çš„å€’æ’ç´¢å¼•ï¼Œæä¾›æ¯«ç§’ç´šå…¨æ–‡æœå°‹èƒ½åŠ›ã€‚</p>
      <ul class="comp-bullets">
        <li>é€é CDCï¼ˆChange Data Captureï¼‰å¾ Metadata DB åŒæ­¥</li>
        <li>æ”¯æ´è‡ªå‹•è£œå…¨ã€æ¨¡ç³Šæœå°‹ã€å¤šèªè¨€åˆ†è©</li>
        <li>å¯ä¾æ’­æ”¾æ¬¡æ•¸ã€è©•åˆ†ã€ä¸Šå‚³æ™‚é–“æ’åº</li>
      </ul>
      <div class="comp-tags"><span class="comp-tag">Elasticsearch</span><span class="comp-tag">Debezium CDC</span></div>
    </div>

    <!-- Cache -->
    <div class="comp-card">
      <style>.comp-card:nth-child(11)::before{background:var(--cache)}</style>
      <div class="comp-header">
        <div class="comp-icon" style="background:#fffbeb;color:var(--cache)">âš¡</div>
        <div><div class="comp-name">Cache</div><div class="comp-role">å¿«å–å±¤</div></div>
      </div>
      <p class="comp-desc">å¿«å–ç†±é–€å½±ç‰‡ metadataï¼Œé™ä½ Metadata DB è®€å–å£“åŠ›ã€‚</p>
      <ul class="comp-bullets">
        <li>Cache-aside patternï¼šå…ˆæŸ¥ Cacheï¼Œmiss å†æŸ¥ DB</li>
        <li>TTL è¨­å®šä¾å½±ç‰‡ç†±åº¦å‹•æ…‹èª¿æ•´</li>
        <li>ç†±é–€å½±ç‰‡ cache hit rate å¯é” 90%+</li>
      </ul>
      <div class="comp-tags"><span class="comp-tag">Redis Cluster</span><span class="comp-tag">Cache-Aside</span></div>
    </div>

    <!-- Object Store -->
    <div class="comp-card">
      <style>.comp-card:nth-child(12)::before{background:var(--storage)}</style>
      <div class="comp-header">
        <div class="comp-icon" style="background:#eef2ff;color:var(--storage)">ğŸ—„ï¸</div>
        <div><div class="comp-name">Object Store (S3)</div><div class="comp-role">ç‰©ä»¶å„²å­˜</div></div>
      </div>
      <p class="comp-desc">å„²å­˜åŸå§‹å½±ç‰‡èˆ‡æ‰€æœ‰è½‰ç¢¼å¾Œçš„å½±ç‰‡ segmentï¼Œä½œç‚º CDN çš„ originã€‚</p>
      <ul class="comp-bullets">
        <li>11-9s çš„æŒä¹…æ€§ï¼Œç¢ºä¿å½±ç‰‡ä¸éºå¤±</li>
        <li>å†·ç†±åˆ†å±¤ï¼šç†±é–€å½±ç‰‡ç”¨ S3 Standardï¼ŒèˆŠå½±ç‰‡ç”¨ S3 Glacier</li>
        <li>CDN origin pull å–å¾—å½±ç‰‡å…§å®¹åˆ†ç™¼åˆ°é‚Šç·£</li>
      </ul>
      <div class="comp-tags"><span class="comp-tag">AWS S3</span><span class="comp-tag">Lifecycle Policies</span></div>
    </div>

    <!-- Metadata DB -->
    <div class="comp-card">
      <style>.comp-card:nth-child(13)::before{background:var(--database)}</style>
      <div class="comp-header">
        <div class="comp-icon" style="background:#fdf2f8;color:var(--database)">ğŸ—ƒï¸</div>
        <div><div class="comp-name">Metadata DB</div><div class="comp-role">ä¸­ç¹¼è³‡æ–™åº«</div></div>
      </div>
      <p class="comp-desc">å„²å­˜å½±ç‰‡æ¨™é¡Œã€æè¿°ã€æ¨™ç±¤ã€ä¸Šå‚³è€…ã€æ’­æ”¾æ¬¡æ•¸ç­‰çµæ§‹åŒ–è³‡æ–™ã€‚</p>
      <ul class="comp-bullets">
        <li>è®€å¯«åˆ†é›¢ï¼šMaster å¯«å…¥ï¼ŒRead Replica è®€å–</li>
        <li>CDC åŒæ­¥è‡³ Elasticsearch ä»¥å»ºç«‹æœå°‹ç´¢å¼•</li>
        <li>å¯ä¾å½±ç‰‡ ID sharding æ©«å‘æ“´å±•</li>
      </ul>
      <div class="comp-tags"><span class="comp-tag">PostgreSQL</span><span class="comp-tag">Read Replica</span><span class="comp-tag">Sharding</span></div>
    </div>

    <!-- CDN -->
    <div class="comp-card">
      <style>.comp-card:nth-child(14)::before{background:var(--cdn)}</style>
      <div class="comp-header">
        <div class="comp-icon" style="background:#f0fdfa;color:var(--cdn)">ğŸŒ</div>
        <div><div class="comp-name">CDN</div><div class="comp-role">å…§å®¹åˆ†ç™¼ç¶²è·¯</div></div>
      </div>
      <p class="comp-desc">å°‡å½±ç‰‡å¿«å–è‡³å…¨çƒé‚Šç·£ç¯€é»ï¼Œè®“è§€çœ‹è€…å¾æœ€è¿‘çš„ä½ç½®å–å¾—ä¸²æµã€‚</p>
      <ul class="comp-bullets">
        <li>Cache hit â†’ ç›´æ¥å¾é‚Šç·£å›å‚³ï¼Œå»¶é² &lt; 50ms</li>
        <li>Cache miss â†’ Origin pull å¾ S3 å–å¾—ä¸¦å¿«å–</li>
        <li>ç›®æ¨™ cache hit rate &gt; 95%ï¼ˆç†±é–€å½±ç‰‡ï¼‰</li>
      </ul>
      <div class="comp-tags"><span class="comp-tag">CloudFront</span><span class="comp-tag">Edge Locations</span></div>
    </div>

  </div>
</section>

<!-- ===== 1.4 REQUEST FLOWS ===== -->
<section class="section section-alt">
  <h2 class="section-title">è«‹æ±‚æµç¨‹è©³ç´°èªªæ˜ Request Flows</h2>
  <p class="section-subtitle">ä¸»è¦è®€å–ã€å¯«å…¥ã€æœå°‹è·¯å¾‘çš„æ­¥é©Ÿè§£æ</p>

  <div class="flow-tabs">
    <button class="flow-tab active" onclick="switchFlow('upload', this)">ğŸ“¤ ä¸Šå‚³æµç¨‹ Upload</button>
    <button class="flow-tab" onclick="switchFlow('view', this)">ğŸ“º è§€çœ‹æµç¨‹ View</button>
    <button class="flow-tab" onclick="switchFlow('search', this)">ğŸ” æœå°‹æµç¨‹ Search</button>
  </div>

  <!-- Upload Flow -->
  <div id="flow-upload" class="flow-panel active">
    <div class="flow-steps">
      <div class="flow-step" data-step="1">
        <div class="flow-step-title">Content Creator ç™¼èµ·ä¸Šå‚³è«‹æ±‚</div>
        <div class="flow-step-desc">å®¢æˆ¶ç«¯å‘ <span class="flow-step-tag">Load Balancer</span> ç™¼é€ POST /upload è«‹æ±‚ï¼ŒåŒ…å«å½±ç‰‡ metadataï¼ˆæ¨™é¡Œã€æè¿°ã€æ¨™ç±¤ï¼‰ã€‚LB å°‡è«‹æ±‚è·¯ç”±è‡³ <span class="flow-step-tag">Upload Video Service</span>ã€‚</div>
      </div>
      <div class="flow-step" data-step="2">
        <div class="flow-step-title">ç”¢ç”Ÿ Presigned URL</div>
        <div class="flow-step-desc">Upload Video Service é©—è­‰è«‹æ±‚å¾Œï¼Œå‘ <span class="flow-step-tag">Object Store (S3)</span> è«‹æ±‚ä¸€å€‹ presigned URLï¼Œä¸¦å›å‚³çµ¦å®¢æˆ¶ç«¯ã€‚å®¢æˆ¶ç«¯ä½¿ç”¨æ­¤ URL ç›´æ¥ä¸Šå‚³å½±ç‰‡è‡³ S3ï¼Œé¿å…å½±ç‰‡æµé‡ç¶“éæ‡‰ç”¨ä¼ºæœå™¨ã€‚</div>
      </div>
      <div class="flow-step" data-step="3">
        <div class="flow-step-title">åŸå§‹å½±ç‰‡å¯«å…¥ S3</div>
        <div class="flow-step-desc">å®¢æˆ¶ç«¯ä½¿ç”¨ presigned URL å°‡åŸå§‹å½±ç‰‡ç›´æ¥ä¸Šå‚³è‡³ <span class="flow-step-tag">S3</span>ã€‚æ”¯æ´ multipart upload ä»¥è™•ç†å¤§æª”æ¡ˆï¼Œä¸¦æ”¯æ´æ–·é»çºŒå‚³ã€‚</div>
      </div>
      <div class="flow-step" data-step="4">
        <div class="flow-step-title">è§¸ç™¼è½‰ç¢¼ä»»å‹™</div>
        <div class="flow-step-desc">ä¸Šå‚³å®Œæˆå¾Œï¼ŒUpload Video Service å°‡ä»»å‹™æ¨å…¥ <span class="flow-step-tag">Processing Queue</span>ã€‚åŒæ™‚ <span class="flow-step-tag">Video Splitter</span> å¯å°‡å½±ç‰‡ä¾ GOP é‚Šç•Œåˆ‡å‰²ç‚ºå¤šå€‹ chunkï¼Œæ¯å€‹ chunk ç¨ç«‹å…¥éšŠã€‚</div>
      </div>
      <div class="flow-step" data-step="5">
        <div class="flow-step-title">Video Encoder æ¶ˆè²»ä»»å‹™ä¸¦è½‰ç¢¼</div>
        <div class="flow-step-desc"><span class="flow-step-tag">Video Encoder</span> å¾ Queue å–å‡ºä»»å‹™ï¼Œå°‡æ¯å€‹ chunk è½‰ç¢¼ç‚ºå¤šç¨®è§£æåº¦ï¼ˆ240p ~ 4Kï¼‰èˆ‡ HLS / DASH segmentã€‚GPU åŠ é€Ÿè™•ç†ã€‚</div>
      </div>
      <div class="flow-step" data-step="6">
        <div class="flow-step-title">å„²å­˜ç·¨ç¢¼å¾Œçš„å½±ç‰‡ä¸¦æ›´æ–° Metadata</div>
        <div class="flow-step-desc">ç·¨ç¢¼å®Œæˆçš„ segment å¯«å…¥ <span class="flow-step-tag">Object Store (S3)</span>ã€‚åŒæ™‚æ›´æ–° <span class="flow-step-tag">Metadata DB</span>ï¼Œæ¨™è¨˜å½±ç‰‡ç‚ºã€Œå·²å®Œæˆã€ä¸¦è¨˜éŒ„å„è§£æåº¦çš„ manifest URLã€‚</div>
      </div>
      <div class="flow-step" data-step="7">
        <div class="flow-step-title">CDC åŒæ­¥è‡³ Elasticsearch</div>
        <div class="flow-step-desc">Metadata DB çš„è®Šæ›´é€é CDCï¼ˆChange Data Captureï¼‰è‡ªå‹•åŒæ­¥è‡³ <span class="flow-step-tag">Elasticsearch</span>ï¼Œä½¿æ–°å½±ç‰‡å¯è¢«æœå°‹ã€‚æœ€çµ‚ä¸€è‡´æ€§å»¶é²ç´„æ•¸ç§’ã€‚</div>
      </div>
    </div>
  </div>

  <!-- View Flow -->
  <div id="flow-view" class="flow-panel">
    <div class="flow-steps">
      <div class="flow-step" data-step="1">
        <div class="flow-step-title">Viewer è«‹æ±‚å½±ç‰‡é é¢</div>
        <div class="flow-step-desc">è§€çœ‹è€…é»æ“Šå½±ç‰‡ï¼Œå®¢æˆ¶ç«¯å‘ <span class="flow-step-tag">Load Balancer</span> ç™¼é€ GET /watch/{videoId} è«‹æ±‚ï¼Œè·¯ç”±è‡³ <span class="flow-step-tag">View Video Service</span>ã€‚</div>
      </div>
      <div class="flow-step" data-step="2">
        <div class="flow-step-title">æŸ¥è©¢ Cacheï¼ˆRedisï¼‰</div>
        <div class="flow-step-desc">View Video Service å…ˆæŸ¥ <span class="flow-step-tag">Cache</span>ï¼ˆRedisï¼‰ã€‚ç†±é–€å½±ç‰‡çš„ cache hit rate å¯é” 90%+ï¼Œç›´æ¥å›å‚³ metadata èˆ‡ CDN ç°½å URLã€‚</div>
      </div>
      <div class="flow-step" data-step="3">
        <div class="flow-step-title">Cache Miss â†’ æŸ¥è©¢ Metadata DB</div>
        <div class="flow-step-desc">è‹¥ cache missï¼Œå‘ <span class="flow-step-tag">Metadata DB</span> Read Replica æŸ¥è©¢å½±ç‰‡è³‡è¨Šï¼Œä¸¦å°‡çµæœå¯«å› Cache ä¾›å¾ŒçºŒè«‹æ±‚ä½¿ç”¨ã€‚</div>
      </div>
      <div class="flow-step" data-step="4">
        <div class="flow-step-title">å›å‚³ CDN ç°½å URL</div>
        <div class="flow-step-desc">å°‡å½±ç‰‡ metadata èˆ‡ CDN ç°½åæ’­æ”¾ URL å›å‚³çµ¦å®¢æˆ¶ç«¯ã€‚ç°½å URL å…·æœ‰æ™‚æ•ˆæ€§ï¼Œé˜²æ­¢æœªæˆæ¬Šå­˜å–ã€‚</div>
      </div>
      <div class="flow-step" data-step="5">
        <div class="flow-step-title">å®¢æˆ¶ç«¯å¾ CDN ä¸²æµæ’­æ”¾</div>
        <div class="flow-step-desc">å®¢æˆ¶ç«¯ä½¿ç”¨ HLS / DASH å”è­°å¾ <span class="flow-step-tag">CDN</span> é‚Šç·£ç¯€é»å–å¾—å½±ç‰‡ segmentã€‚ABR ç®—æ³•æ ¹æ“šç¶²è·¯ç‹€æ³è‡ªå‹•åˆ‡æ›è§£æåº¦ã€‚CDN cache hit â†’ å»¶é² &lt; 50msã€‚</div>
      </div>
      <div class="flow-step" data-step="6">
        <div class="flow-step-title">CDN Cache Miss â†’ Origin Pull</div>
        <div class="flow-step-desc">è‹¥ CDN ç„¡æ­¤ segment å¿«å–ï¼Œå¾ <span class="flow-step-tag">Object Store (S3)</span> æ‹‰å–ï¼ˆorigin pullï¼‰ï¼Œå¿«å–å¾Œå›å‚³çµ¦è§€çœ‹è€…ã€‚</div>
      </div>
    </div>
  </div>

  <!-- Search Flow -->
  <div id="flow-search" class="flow-panel">
    <div class="flow-steps">
      <div class="flow-step" data-step="1">
        <div class="flow-step-title">Viewer è¼¸å…¥æœå°‹é—œéµå­—</div>
        <div class="flow-step-desc">è§€çœ‹è€…åœ¨æœå°‹æ¬„è¼¸å…¥é—œéµå­—ï¼Œå®¢æˆ¶ç«¯å‘ <span class="flow-step-tag">Load Balancer</span> ç™¼é€ GET /search?q=keyword è«‹æ±‚ã€‚</div>
      </div>
      <div class="flow-step" data-step="2">
        <div class="flow-step-title">è·¯ç”±è‡³ Search Service</div>
        <div class="flow-step-desc">LB å°‡è«‹æ±‚è·¯ç”±è‡³ <span class="flow-step-tag">Search Service</span>ï¼ŒService è§£ææŸ¥è©¢åƒæ•¸ã€è™•ç†åˆ†è©èˆ‡éæ¿¾æ¢ä»¶ã€‚</div>
      </div>
      <div class="flow-step" data-step="3">
        <div class="flow-step-title">æŸ¥è©¢ Elasticsearch</div>
        <div class="flow-step-desc">Search Service å‘ <span class="flow-step-tag">Elasticsearch Video API</span> ç™¼é€æœå°‹è«‹æ±‚ï¼Œåˆ©ç”¨å€’æ’ç´¢å¼•é€²è¡Œå…¨æ–‡åŒ¹é…ï¼Œçµåˆ BM25 æ’åºç®—æ³•èˆ‡è‡ªè¨‚åŠ æ¬Šã€‚</div>
      </div>
      <div class="flow-step" data-step="4">
        <div class="flow-step-title">æ’åºèˆ‡å›å‚³çµæœ</div>
        <div class="flow-step-desc">æœå°‹çµæœä¾ç›¸é—œæ€§ï¼ˆBM25ï¼‰ã€æ’­æ”¾æ¬¡æ•¸ã€æ–°é®®åº¦åŠ æ¬Šæ’åºï¼Œå›å‚³å½±ç‰‡åˆ—è¡¨ï¼ˆå«ç¸®åœ– URLã€æ¨™é¡Œã€æè¿°æ‘˜è¦ï¼‰çµ¦å®¢æˆ¶ç«¯ã€‚</div>
      </div>
    </div>
  </div>
</section>

<!-- ===== 1.5 ALGORITHM OVERVIEW ===== -->
<section class="section">
  <h2 class="section-title">æ¼”ç®—æ³•æ¦‚è¦½ Algorithm Overview</h2>
  <p class="section-subtitle">ç³»çµ±ä¸­ä½¿ç”¨çš„é—œéµæ¼”ç®—æ³•èˆ‡æ¨¡å¼ â€” è©³æƒ…è¦‹ Deep Dive é </p>

  <div class="algo-grid">

    <div class="algo-card">
      <span class="algo-badge">VIDEO ENCODING</span>
      <h4>Adaptive Bitrate Streaming (ABR)</h4>
      <div class="algo-sub">è‡ªé©æ‡‰ç¢¼ç‡ä¸²æµ</div>
      <p>æ ¹æ“šç”¨æˆ¶ç¶²è·¯ç‹€æ³å‹•æ…‹åˆ‡æ›å½±ç‰‡è§£æåº¦ï¼Œåœ¨ç•«è³ªèˆ‡æµæš¢åº¦ä¹‹é–“å–å¾—æœ€ä½³å¹³è¡¡ã€‚</p>
      <div class="algo-proscons">
        <div class="algo-pros">
          <div class="algo-pros-title">âœ“ PROS</div>
          <ul><li>è‡ªå‹•é©æ‡‰ç¶²è·¯æ³¢å‹•</li><li>æ¸›å°‘ buffering</li><li>æœ€ä½³åŒ–è§€çœ‹é«”é©—</li></ul>
        </div>
        <div class="algo-cons">
          <div class="algo-cons-title">âœ— CONS</div>
          <ul><li>éœ€ç”¢ç”Ÿå¤šç¨®è§£æåº¦</li><li>å„²å­˜æˆæœ¬å¢åŠ  3-5x</li><li>è½‰ç¢¼æ™‚é–“è¼ƒé•·</li></ul>
        </div>
      </div>
    </div>

    <div class="algo-card">
      <span class="algo-badge">CACHING</span>
      <h4>Cache-Aside Pattern</h4>
      <div class="algo-sub">æ—è·¯å¿«å–æ¨¡å¼</div>
      <p>æ‡‰ç”¨ç¨‹å¼å…ˆæŸ¥ Cacheï¼Œmiss æ™‚æŸ¥ DB ä¸¦å›å¡« Cacheï¼Œé©åˆè®€å¤šå¯«å°‘çš„å ´æ™¯ã€‚</p>
      <div class="algo-proscons">
        <div class="algo-pros">
          <div class="algo-pros-title">âœ“ PROS</div>
          <ul><li>å¯¦ä½œç°¡å–®ç›´è§€</li><li>DB èˆ‡ Cache è§£è€¦</li><li>Cache æ•…éšœæ™‚å¯é™ç´šè‡³ DB</li></ul>
        </div>
        <div class="algo-cons">
          <div class="algo-cons-title">âœ— CONS</div>
          <ul><li>é¦–æ¬¡è«‹æ±‚è¼ƒæ…¢</li><li>éœ€è™•ç† Cache ä¸€è‡´æ€§</li></ul>
        </div>
      </div>
    </div>

    <div class="algo-card">
      <span class="algo-badge">SEARCH</span>
      <h4>BM25 + Boosting</h4>
      <div class="algo-sub">å…¨æ–‡æœå°‹æ’åºç®—æ³•</div>
      <p>Elasticsearch é è¨­çš„æ–‡å­—ç›¸é—œæ€§æ’åºç®—æ³•ï¼Œçµåˆè‡ªè¨‚ boost å› å­ï¼ˆæ’­æ”¾æ¬¡æ•¸ã€æ–°é®®åº¦ï¼‰ã€‚</p>
      <div class="algo-proscons">
        <div class="algo-pros">
          <div class="algo-pros-title">âœ“ PROS</div>
          <ul><li>æ¥­ç•Œæ¨™æº–ï¼Œæˆç†Ÿç©©å®š</li><li>è™•ç†è©é »èˆ‡æ–‡æª”é•·åº¦</li><li>å¯çµåˆè‡ªè¨‚æ’åºå› å­</li></ul>
        </div>
        <div class="algo-cons">
          <div class="algo-cons-title">âœ— CONS</div>
          <ul><li>èªç¾©ç†è§£æœ‰é™</li><li>éœ€é…åˆåˆ†è©å™¨èª¿å„ª</li></ul>
        </div>
      </div>
    </div>

    <div class="algo-card">
      <span class="algo-badge">DATA SYNC</span>
      <h4>Change Data Capture (CDC)</h4>
      <div class="algo-sub">è³‡æ–™è®Šæ›´æ•ç²</div>
      <p>ç›£è½ Metadata DB çš„ WAL logï¼Œå°‡è®Šæ›´å³æ™‚åŒæ­¥è‡³ Elasticsearchï¼Œç¢ºä¿æœå°‹ç´¢å¼•æœ€çµ‚ä¸€è‡´ã€‚</p>
      <div class="algo-proscons">
        <div class="algo-pros">
          <div class="algo-pros-title">âœ“ PROS</div>
          <ul><li>ä½å»¶é²åŒæ­¥ï¼ˆç§’ç´šï¼‰</li><li>ä¸å½±éŸ¿ DB å¯«å…¥æ€§èƒ½</li><li>ä¿è­‰é †åºä¸€è‡´æ€§</li></ul>
        </div>
        <div class="algo-cons">
          <div class="algo-cons-title">âœ— CONS</div>
          <ul><li>é¡å¤–åŸºç¤è¨­æ–½æˆæœ¬</li><li>Schema è®Šæ›´éœ€ç¶­è­·</li></ul>
        </div>
      </div>
    </div>

    <div class="algo-card">
      <span class="algo-badge">SPLITTING</span>
      <h4>GOP-based Video Splitting</h4>
      <div class="algo-sub">åŸºæ–¼ GOP çš„å½±ç‰‡åˆ‡å‰²</div>
      <p>ä¾ GOPï¼ˆGroup of Picturesï¼‰é‚Šç•Œåˆ‡å‰²å½±ç‰‡ï¼Œç¢ºä¿æ¯å€‹ chunk å¯ç¨ç«‹è§£ç¢¼ï¼Œæ”¯æ´å¹³è¡Œè½‰ç¢¼ã€‚</p>
      <div class="algo-proscons">
        <div class="algo-pros">
          <div class="algo-pros-title">âœ“ PROS</div>
          <ul><li>å¹³è¡Œè½‰ç¢¼åŠ é€Ÿ 3-10x</li><li>chunk å¯ç¨ç«‹é‡è©¦</li></ul>
        </div>
        <div class="algo-cons">
          <div class="algo-cons-title">âœ— CONS</div>
          <ul><li>éœ€ç²¾ç¢ºå®šä½ GOP é‚Šç•Œ</li><li>åˆä½µæ™‚éœ€è™•ç†æ¥ç¸«</li></ul>
        </div>
      </div>
    </div>

    <div class="algo-card">
      <span class="algo-badge">LOAD BALANCING</span>
      <h4>Consistent Hashing</h4>
      <div class="algo-sub">ä¸€è‡´æ€§é›œæ¹Š</div>
      <p>ç”¨æ–¼ Cache å±¤çš„åˆ†ç‰‡ç­–ç•¥ï¼Œç•¶ç¯€é»å¢æ¸›æ™‚åªéœ€é‡æ–°åˆ†é…æœ€å°‘é‡çš„ keyã€‚</p>
      <div class="algo-proscons">
        <div class="algo-pros">
          <div class="algo-pros-title">âœ“ PROS</div>
          <ul><li>ç¯€é»è®Šå‹•å½±éŸ¿æœ€å°</li><li>è² è¼‰å‡å‹»åˆ†æ•£</li></ul>
        </div>
        <div class="algo-cons">
          <div class="algo-cons-title">âœ— CONS</div>
          <ul><li>å¯¦ä½œè¤‡é›œåº¦é«˜</li><li>ç†±é»å•é¡Œéœ€è™›æ“¬ç¯€é»</li></ul>
        </div>
      </div>
    </div>

  </div>
</section>

<!-- ===== 1.6 DESIGN DECISIONS ===== -->
<section class="section section-alt">
  <h2 class="section-title">é—œéµè¨­è¨ˆæ±ºç­– Design Decisions</h2>
  <p class="section-subtitle">ç‚ºä½•é€™æ¨£è¨­è¨ˆï¼ŸèƒŒå¾Œçš„ trade-off åˆ†æ</p>

  <div class="decision-grid">
    <div class="decision-card">
      <h4>ğŸ”€ Presigned URL ç›´å‚³</h4>
      <p>å½±ç‰‡ç›´æ¥å¾å®¢æˆ¶ç«¯ä¸Šå‚³åˆ° S3ï¼Œè€Œéç¶“éæ‡‰ç”¨ä¼ºæœå™¨ã€‚åŸå› ï¼šå½±ç‰‡æª”æ¡ˆå·¨å¤§ï¼ˆæ•¸ç™¾ MB ~ æ•¸ GBï¼‰ï¼Œç¶“ç”±ä¼ºæœå™¨ä¸­è½‰æœƒæ¶ˆè€—å¤§é‡é »å¯¬å’Œ CPUï¼Œä¸”æˆç‚ºç“¶é ¸ã€‚Presigned URL è®“ä¸Šå‚³æµé‡ç›´é€š S3ï¼Œä¼ºæœå™¨åªè™•ç†è¼•é‡çš„ metadataã€‚</p>
    </div>
    <div class="decision-card">
      <h4>ğŸ“¬ Message Queue è§£è€¦</h4>
      <p>Upload Service èˆ‡ Video Encoder ä¹‹é–“é€é Queue è§£è€¦ã€‚å¥½è™•ï¼šä¸Šå‚³å®Œæˆå¾Œç«‹å³å›å‚³æˆåŠŸï¼Œè½‰ç¢¼åœ¨èƒŒæ™¯éåŒæ­¥é€²è¡Œï¼›Queue ä½œç‚ºç·©è¡ï¼Œåœ¨é«˜å³°æ™‚æ®µä¿è­· Encoder ä¸è¢«å£“å®ï¼›å¤±æ•—ä»»å‹™å¯è‡ªå‹•é‡è©¦ã€‚</p>
    </div>
    <div class="decision-card">
      <h4>âœ‚ï¸ Video Splitting å¹³è¡Œè½‰ç¢¼</h4>
      <p>å¤§å‹å½±ç‰‡åˆ‡å‰²å¾Œå¹³è¡Œè™•ç†ï¼Œè€Œéæ•´æ®µè½‰ç¢¼ã€‚ä¸€éƒ¨ 2 å°æ™‚å½±ç‰‡é †åºè½‰ç¢¼å¯èƒ½éœ€ 20 åˆ†é˜ï¼›åˆ‡å‰²ç‚º 120 å€‹ 1 åˆ†é˜ chunk å¾Œï¼Œå¯åˆ†é…åˆ°å¤šå€‹ Encoder åŒæ™‚è™•ç†ï¼Œç¸½æ™‚é–“å¯å£“ç¸®è‡³ 2-3 åˆ†é˜ã€‚</p>
    </div>
    <div class="decision-card">
      <h4>ğŸŒ CDN é‚Šç·£å¿«å–</h4>
      <p>å½±ç‰‡ä¸²æµèµ° CDN è€Œéç›´æ¥å¾ S3ã€‚åŸå› ï¼šè§€çœ‹è€…éå¸ƒå…¨çƒï¼Œç›´æ¥å¾ S3 å–å¾—å»¶é² 100-500msï¼›CDN é‚Šç·£å¿«å–å°‡å»¶é²é™è‡³ &lt; 50msã€‚ç†±é–€å½±ç‰‡çš„ CDN hit rate &gt; 95%ï¼Œå¤§å¹…é™ä½ S3 å‡ºå£æµé‡è²»ç”¨ã€‚</p>
    </div>
    <div class="decision-card">
      <h4>âš¡ Cache-Aside + Read Replica</h4>
      <p>è®€å¤šå¯«å°‘ï¼ˆè®€å¯«æ¯”ç´„ 100:1ï¼‰ï¼Œä½¿ç”¨ Redis Cache å¸æ”¶ 90%+ è®€å–æµé‡ï¼Œå‰©é¤˜èµ° DB Read Replicaã€‚Master åƒ…è™•ç†å¯«å…¥ã€‚é€™æ¨£ DB å£“åŠ›å¤§å¹…é™ä½ï¼Œå¯ç”¨æ›´å°‘çš„ç¡¬é«”æ”¯æ’æ›´å¤§çš„æµé‡ã€‚</p>
    </div>
    <div class="decision-card">
      <h4>ğŸ” CDC åŒæ­¥è‡³ Elasticsearch</h4>
      <p>é¸æ“‡ CDC è€Œé dual-writeï¼ˆåŒæ™‚å¯« DB + ESï¼‰ã€‚åŸå› ï¼šdual-write åœ¨ä»»ä¸€æ–¹å¤±æ•—æ™‚æœƒé€ æˆè³‡æ–™ä¸ä¸€è‡´ï¼›CDC ç›£è½ DB WAL ä¿è­‰é †åºèˆ‡ä¸€è‡´æ€§ï¼Œä¸”ä¸å¢åŠ å¯«å…¥è·¯å¾‘çš„å»¶é²ã€‚ä»£åƒ¹æ˜¯æœ€çµ‚ä¸€è‡´æ€§ï¼ˆå»¶é²æ•¸ç§’ï¼‰ã€‚</p>
    </div>
  </div>
</section>

<!-- ===== 1.7 CAPACITY ESTIMATION ===== -->
<section class="section">
  <h2 class="section-title">é »å¯¬èˆ‡å®¹é‡ä¼°ç®— Capacity Estimation</h2>
  <p class="section-subtitle">åŸºæ–¼ 100M MAU çš„æµé‡èˆ‡å„²å­˜éœ€æ±‚æ¨ç®—</p>

  <div class="cap-grid">
    <div class="cap-card">
      <div class="cap-value">100M</div>
      <div class="cap-unit">MAU</div>
      <div class="cap-label">æœˆæ´»èºç”¨æˆ¶</div>
    </div>
    <div class="cap-card">
      <div class="cap-value">~5M</div>
      <div class="cap-unit">DAU</div>
      <div class="cap-label">æ—¥æ´»èºç”¨æˆ¶ï¼ˆ5% MAUï¼‰</div>
    </div>
    <div class="cap-card">
      <div class="cap-value">100:1</div>
      <div class="cap-unit">Read:Write</div>
      <div class="cap-label">è®€å¯«æ¯”</div>
    </div>
    <div class="cap-card">
      <div class="cap-value">~58K</div>
      <div class="cap-unit">QPS</div>
      <div class="cap-label">è®€å– QPSï¼ˆé«˜å³° 2xï¼‰</div>
    </div>
    <div class="cap-card">
      <div class="cap-value">~580</div>
      <div class="cap-unit">QPS</div>
      <div class="cap-label">ä¸Šå‚³ QPS</div>
    </div>
    <div class="cap-card">
      <div class="cap-value">~150 TB</div>
      <div class="cap-unit">/day</div>
      <div class="cap-label">æ¯æ—¥æ–°å¢åŸå§‹å½±ç‰‡</div>
    </div>
    <div class="cap-card">
      <div class="cap-value">~750 TB</div>
      <div class="cap-unit">/day</div>
      <div class="cap-label">å«è½‰ç¢¼å¾Œå…¨éƒ¨ç‰ˆæœ¬</div>
    </div>
    <div class="cap-card">
      <div class="cap-value">~270 PB</div>
      <div class="cap-unit">/year</div>
      <div class="cap-label">å¹´å„²å­˜é‡</div>
    </div>
  </div>

  <table class="cap-table" style="max-width:800px;">
    <thead>
      <tr><th>ä¼°ç®—é …ç›®</th><th>è¨ˆç®—</th><th>çµæœ</th></tr>
    </thead>
    <tbody>
      <tr><td>DAU</td><td>100M Ã— 5%</td><td class="mono">5,000,000</td></tr>
      <tr><td>æ¯æ—¥è§€çœ‹æ¬¡æ•¸</td><td>5M DAU Ã— 1 video/day avg</td><td class="mono">5,000,000 views/day</td></tr>
      <tr><td>è®€å– QPS</td><td>5M / 86400</td><td class="mono">~58 QPS (peak ~116)</td></tr>
      <tr><td>æ¯æ—¥ä¸Šå‚³æ•¸</td><td>5M Ã— 1% creators Ã— 10%</td><td class="mono">~50,000 uploads/day</td></tr>
      <tr><td>ä¸Šå‚³ QPS</td><td>50K / 86400</td><td class="mono">~0.58 QPS (peak ~1.2)</td></tr>
      <tr><td>å¹³å‡å½±ç‰‡å¤§å°ï¼ˆåŸå§‹ï¼‰</td><td>10 min Ã— 50 MB/min</td><td class="mono">~500 MB</td></tr>
      <tr><td>æ¯æ—¥åŸå§‹å„²å­˜</td><td>50K Ã— 500 MB</td><td class="mono">~25 TB/day</td></tr>
      <tr><td>è½‰ç¢¼å¾Œå„²å­˜ï¼ˆ5xï¼‰</td><td>25 TB Ã— 5 resolutions</td><td class="mono">~125 TB/day</td></tr>
      <tr><td>æ¯æ—¥å‡ºå£é »å¯¬ï¼ˆCDN å‰ï¼‰</td><td>5M views Ã— 500 MB avg</td><td class="mono">~2.5 PB/day</td></tr>
      <tr><td>CDN hit rate 95%</td><td>S3 å‡ºå£ = 2.5 PB Ã— 5%</td><td class="mono">~125 TB/day from S3</td></tr>
    </tbody>
  </table>
</section>

</div><!-- end page-inner -->
</div><!-- end page-overview -->

<!-- ==================== PAGE 2: DEEP DIVE ==================== -->
<div id="page-deepdive" class="page">
<div class="page-inner narrow">

<!-- ===== 2.1 TABLE OF CONTENTS ===== -->
<section class="dd-section" id="dd-toc">
  <h2 class="dd-h2">ğŸ“š Deep Dive ç›®éŒ„</h2>
  <p class="dd-sub">é»æ“Šè·³è½‰è‡³å„ç« ç¯€ â€” Click to navigate</p>
  <div class="dd-toc-grid">
    <a href="#dd-why" class="dd-toc-item"><span class="dd-toc-num">01</span>ç‚ºä½•éœ€è¦æ­¤æ¶æ§‹æ¨¡å¼</a>
    <a href="#dd-abr" class="dd-toc-item"><span class="dd-toc-num">02</span>ABR è‡ªé©æ‡‰ç¢¼ç‡ä¸²æµ</a>
    <a href="#dd-encoding" class="dd-toc-item"><span class="dd-toc-num">03</span>å½±ç‰‡ç·¨ç¢¼ Pipeline</a>
    <a href="#dd-caching" class="dd-toc-item"><span class="dd-toc-num">04</span>å¿«å–ç­–ç•¥æ·±åº¦è§£æ</a>
    <a href="#dd-search" class="dd-toc-item"><span class="dd-toc-num">05</span>æœå°‹å¼•æ“å¯¦ä½œ</a>
    <a href="#dd-distributed" class="dd-toc-item"><span class="dd-toc-num">06</span>åˆ†æ•£å¼è€ƒé‡</a>
    <a href="#dd-storage" class="dd-toc-item"><span class="dd-toc-num">07</span>å„²å­˜èˆ‡è³‡æ–™åº«å¯¦ä½œ</a>
    <a href="#dd-api" class="dd-toc-item"><span class="dd-toc-num">08</span>API è¨­è¨ˆèˆ‡å”è­°</a>
    <a href="#dd-ops" class="dd-toc-item"><span class="dd-toc-num">09</span>é‹ç‡Ÿç­–ç•¥</a>
    <a href="#dd-interview" class="dd-toc-item"><span class="dd-toc-num">10</span>é¢è©¦é¡Œåº« Q&amp;A</a>
  </div>
</section>

<!-- ===== 2.2 WHY THIS PATTERN ===== -->
<section class="dd-section" id="dd-why">
  <h2 class="dd-h2">01 â€” ç‚ºä½•éœ€è¦æ­¤æ¶æ§‹æ¨¡å¼</h2>
  <p class="dd-sub">Core Concept: Why a Video Streaming Architecture?</p>

  <div class="dd-info concept">
    <strong>ğŸ’¡ Concept</strong>
    å½±ç‰‡ä¸²æµå¹³å°çš„æ ¸å¿ƒæŒ‘æˆ°åœ¨æ–¼ï¼šå½±ç‰‡æ˜¯æ¥µå¤§çš„éçµæ§‹åŒ–è³‡æ–™ï¼ˆä¸€éƒ¨ 1080p å½±ç‰‡æ¯åˆ†é˜ç´„ 150 MBï¼‰ï¼Œå¿…é ˆå¿«é€Ÿä¸Šå‚³ã€è½‰ç¢¼ç‚ºå¤šç¨®æ ¼å¼ã€ä¸¦ä»¥ä½å»¶é²ä¸²æµåˆ°å…¨çƒç”¨æˆ¶ã€‚é€™éœ€è¦ä¸€å¥—å°ˆé–€çš„å¯«å…¥ pipelineï¼ˆä¸Šå‚³ â†’ åˆ‡å‰² â†’ è½‰ç¢¼ â†’ å„²å­˜ï¼‰èˆ‡è®€å– pipelineï¼ˆCDN â†’ Cache â†’ Metadata DBï¼‰ï¼Œå…©è€…å®Œå…¨è§£è€¦ã€‚
  </div>

  <p class="dd-text">ä¸€èˆ¬çš„ CRUD æ‡‰ç”¨ç„¡æ³•æ‰¿å—å½±ç‰‡ä¸²æµçš„æµé‡ç‰¹æ€§ã€‚è®€å–é‡é å¤§æ–¼å¯«å…¥ï¼ˆ100:1ï¼‰ï¼Œä½†å¯«å…¥çš„è³‡æ–™é‡æ¥µç‚ºé¾å¤§ï¼ˆå–®æ¬¡ä¸Šå‚³å¯é”æ•¸ GBï¼‰ã€‚æ­¤å¤–å½±ç‰‡éœ€è¦è¢«è½‰ç¢¼ç‚ºå¤šç¨®è§£æåº¦ä»¥æ”¯æ´ä¸åŒè£ç½®èˆ‡ç¶²è·¯ç’°å¢ƒã€‚é€™äº›ç‰¹æ€§é©…å‹•äº†ä»¥ä¸‹è¨­è¨ˆæ¨¡å¼çš„æ¡ç”¨ï¼š</p>

  <div class="dd-kp-grid">
    <div class="dd-kp-card">
      <h4>ğŸ”€ è®€å¯«åˆ†é›¢</h4>
      <p>ä¸Šå‚³è·¯å¾‘ï¼ˆå¯«å…¥é‡ã€è¨ˆç®—é‡ï¼‰èˆ‡è§€çœ‹è·¯å¾‘ï¼ˆè®€å–é‡ã€é »å¯¬é‡ï¼‰ä½¿ç”¨å®Œå…¨ä¸åŒçš„æœå‹™å’ŒåŸºç¤è¨­æ–½ï¼Œäº’ä¸å½±éŸ¿ã€‚</p>
    </div>
    <div class="dd-kp-card">
      <h4>ğŸ“¬ éåŒæ­¥è™•ç†</h4>
      <p>å½±ç‰‡è½‰ç¢¼æ˜¯ CPU/GPU å¯†é›†å‹ä»»å‹™ï¼Œé€é Message Queue å°‡å…¶å¾åŒæ­¥è«‹æ±‚è·¯å¾‘ä¸­ç§»é™¤ï¼Œä¸Šå‚³è€…ç„¡éœ€ç­‰å¾…è½‰ç¢¼å®Œæˆã€‚</p>
    </div>
    <div class="dd-kp-card">
      <h4>ğŸŒ é‚Šç·£åˆ†ç™¼</h4>
      <p>å½±ç‰‡è³‡æ–™é‡å¤§ï¼Œå…¨çƒç”¨æˆ¶éœ€è¦ä½å»¶é²å­˜å–ã€‚CDN é‚Šç·£å¿«å–æ˜¯å”¯ä¸€å¯è¡Œçš„æ–¹æ¡ˆï¼Œå°‡ 95%+ è®€å–è«‹æ±‚åœ¨é‚Šç·£å›æ‡‰ã€‚</p>
    </div>
    <div class="dd-kp-card">
      <h4>ğŸ“ æ°´å¹³æ“´å±•</h4>
      <p>æ¯å€‹æœå‹™ç¨ç«‹æ“´å±•ï¼šUpload Service ä¾ä¸Šå‚³é‡ã€Encoder ä¾è½‰ç¢¼éšŠåˆ—æ·±åº¦ã€View Service ä¾è®€å– QPSï¼Œå„è‡ªå‹•æ…‹ä¼¸ç¸®ã€‚</p>
    </div>
  </div>

  <div class="dd-info important">
    <strong>âš ï¸ Important</strong>
    åœ¨é¢è©¦ä¸­ï¼Œå‹™å¿…å…ˆé‡æ¸… functional vs non-functional requirementsï¼Œå†é–‹å§‹ç•«æ¶æ§‹åœ–ã€‚æœ¬ç³»çµ±çš„ä¸‰å¤§åŠŸèƒ½éœ€æ±‚ï¼ˆä¸Šå‚³ã€æœå°‹ã€è§€çœ‹ï¼‰å„è‡ªæœ‰ç¨ç«‹çš„è³‡æ–™æµè·¯å¾‘ï¼Œé€™æ˜¯æ¶æ§‹è¨­è¨ˆçš„å‡ºç™¼é»ã€‚
  </div>
</section>

<!-- ===== 2.3 ABR DEEP DIVE ===== -->
<section class="dd-section-alt" id="dd-abr">
  <h2 class="dd-h2">02 â€” Adaptive Bitrate Streaming (ABR)</h2>
  <p class="dd-sub">è‡ªé©æ‡‰ç¢¼ç‡ä¸²æµ â€” å¦‚ä½•åœ¨ç•«è³ªèˆ‡æµæš¢åº¦ä¹‹é–“å–å¾—å¹³è¡¡</p>

  <h3 class="dd-h3">å·¥ä½œåŸç†</h3>
  <p class="dd-text">ABR çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šå°‡ä¸€éƒ¨å½±ç‰‡é å…ˆç·¨ç¢¼ç‚ºå¤šç¨®ç¢¼ç‡ï¼ˆbitrateï¼‰ç‰ˆæœ¬ï¼Œæ¯å€‹ç‰ˆæœ¬å†åˆ‡å‰²ç‚ºå›ºå®šæ™‚é•·çš„å°æ®µï¼ˆsegment, é€šå¸¸ 2-10 ç§’ï¼‰ã€‚å®¢æˆ¶ç«¯æ’­æ”¾å™¨æ ¹æ“šç•¶å‰ç¶²è·¯é »å¯¬å‹•æ…‹é¸æ“‡ä¸‹ä¸€å€‹ segment çš„ç¢¼ç‡ç‰ˆæœ¬ã€‚</p>

  <!-- ABR SVG Diagram -->
  <div class="dd-svg-wrap">
    <svg viewBox="0 0 750 320" xmlns="http://www.w3.org/2000/svg" font-family="'DM Sans', sans-serif">
      <defs><filter id="s2" x="-4%" y="-4%" width="108%" height="112%"><feDropShadow dx="0" dy="1" stdDeviation="2" flood-opacity="0.06"/></filter></defs>
      <!-- Source video -->
      <g filter="url(#s2)"><rect x="20" y="120" width="120" height="60" rx="8" fill="#fff" stroke="#6366f1" stroke-width="1.5"/><rect x="20" y="120" width="4" height="60" rx="2" fill="#6366f1"/><text x="80" y="146" text-anchor="middle" font-size="11" font-weight="600" fill="#1e293b">Source</text><text x="80" y="162" text-anchor="middle" font-size="8" fill="#94a3b8">1080p master</text></g>
      <!-- Arrow -->
      <line x1="140" y1="150" x2="190" y2="150" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#arr-gray)"/>
      <text x="165" y="143" text-anchor="middle" font-size="8" fill="#94a3b8">encode</text>
      <!-- Multiple bitrates -->
      <g filter="url(#s2)"><rect x="200" y="30" width="130" height="36" rx="6" fill="#fff" stroke="#f97316" stroke-width="1.2"/><text x="265" y="52" text-anchor="middle" font-size="10" font-weight="500" fill="#1e293b">4K â€” 16 Mbps</text></g>
      <g filter="url(#s2)"><rect x="200" y="76" width="130" height="36" rx="6" fill="#fff" stroke="#f97316" stroke-width="1.2"/><text x="265" y="98" text-anchor="middle" font-size="10" font-weight="500" fill="#1e293b">1080p â€” 5 Mbps</text></g>
      <g filter="url(#s2)"><rect x="200" y="122" width="130" height="36" rx="6" fill="#fff" stroke="#f97316" stroke-width="1.2"/><text x="265" y="144" text-anchor="middle" font-size="10" font-weight="500" fill="#1e293b">720p â€” 2.5 Mbps</text></g>
      <g filter="url(#s2)"><rect x="200" y="168" width="130" height="36" rx="6" fill="#fff" stroke="#f97316" stroke-width="1.2"/><text x="265" y="190" text-anchor="middle" font-size="10" font-weight="500" fill="#1e293b">480p â€” 1 Mbps</text></g>
      <g filter="url(#s2)"><rect x="200" y="214" width="130" height="36" rx="6" fill="#fff" stroke="#f97316" stroke-width="1.2"/><text x="265" y="236" text-anchor="middle" font-size="10" font-weight="500" fill="#1e293b">240p â€” 400 Kbps</text></g>
      <!-- Arrow to segments -->
      <line x1="330" y1="140" x2="380" y2="140" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#arr-gray)"/>
      <text x="355" y="133" text-anchor="middle" font-size="8" fill="#94a3b8">segment</text>
      <!-- Segments -->
      <g filter="url(#s2)"><rect x="390" y="90" width="140" height="100" rx="8" fill="#fff" stroke="#10b981" stroke-width="1.5"/><rect x="390" y="90" width="4" height="100" rx="2" fill="#10b981"/><text x="460" y="115" text-anchor="middle" font-size="10" font-weight="600" fill="#1e293b">HLS / DASH</text><text x="460" y="132" text-anchor="middle" font-size="9" fill="#94a3b8">Segments</text><text x="460" y="150" text-anchor="middle" font-size="8" fill="#94a3b8" font-family="'JetBrains Mono', monospace">seg_001.ts (2-10s)</text><text x="460" y="164" text-anchor="middle" font-size="8" fill="#94a3b8" font-family="'JetBrains Mono', monospace">seg_002.ts (2-10s)</text><text x="460" y="178" text-anchor="middle" font-size="8" fill="#94a3b8" font-family="'JetBrains Mono', monospace">seg_003.ts ...</text></g>
      <!-- Arrow to CDN -->
      <line x1="530" y1="140" x2="580" y2="140" stroke="#14b8a6" stroke-width="1.5" marker-end="url(#arr-teal)"/>
      <!-- CDN -->
      <g filter="url(#s2)"><rect x="590" y="90" width="120" height="100" rx="8" fill="#fff" stroke="#14b8a6" stroke-width="1.5"/><rect x="590" y="90" width="4" height="100" rx="2" fill="#14b8a6"/><text x="650" y="120" text-anchor="middle" font-size="11" font-weight="600" fill="#1e293b">CDN Edge</text><text x="650" y="140" text-anchor="middle" font-size="9" fill="#94a3b8">Viewer requests</text><text x="650" y="158" text-anchor="middle" font-size="9" fill="#94a3b8">next segment</text><text x="650" y="176" text-anchor="middle" font-size="9" fill="#00a8e1" font-weight="500">ABR selects</text></g>
      <!-- Manifest note -->
      <g filter="url(#s2)"><rect x="390" y="230" width="140" height="50" rx="6" fill="#fffbeb" stroke="#f59e0b" stroke-width="1"/><text x="460" y="252" text-anchor="middle" font-size="9" font-weight="600" fill="#d97706">ğŸ“„ Manifest File</text><text x="460" y="268" text-anchor="middle" font-size="8" fill="#94a3b8">.m3u8 / .mpd</text></g>
      <line x1="460" y1="190" x2="460" y2="230" stroke="#f59e0b" stroke-width="1" stroke-dasharray="3,3"/>
    </svg>
  </div>

  <h3 class="dd-h3">HLS vs DASH å”è­°æ¯”è¼ƒ</h3>
  <table class="dd-compare-table">
    <thead><tr><th>ç‰¹æ€§</th><th>HLS (HTTP Live Streaming)</th><th>DASH (Dynamic Adaptive Streaming)</th></tr></thead>
    <tbody>
      <tr><td>é–‹ç™¼è€…</td><td>Apple</td><td>MPEG (é–‹æ”¾æ¨™æº–)</td></tr>
      <tr><td>Manifest æ ¼å¼</td><td class="mono">.m3u8</td><td class="mono">.mpd (XML)</td></tr>
      <tr><td>Segment æ ¼å¼</td><td class="mono">.ts / .fmp4</td><td class="mono">.m4s / .mp4</td></tr>
      <tr><td>Segment æ™‚é•·</td><td>6s (é è¨­)</td><td>2-10s (å¯é…ç½®)</td></tr>
      <tr><td>ç€è¦½å™¨æ”¯æ´</td><td class="good">iOS/Safari åŸç”Ÿï¼›å…¶ä»–éœ€ hls.js</td><td class="good">å¤§å¤šæ•¸ç€è¦½å™¨é€é MSE</td></tr>
      <tr><td>DRM æ”¯æ´</td><td>FairPlay</td><td>Widevine / PlayReady</td></tr>
      <tr><td>å»¶é²</td><td class="mid">è¼ƒé«˜ï¼ˆLL-HLS æ”¹å–„ä¸­ï¼‰</td><td class="good">è¼ƒä½</td></tr>
      <tr><td>æ¥­ç•Œæ¡ç”¨</td><td>Apple ç”Ÿæ…‹ç³»ç‚ºä¸»</td><td>YouTube, Netflix ä½¿ç”¨</td></tr>
    </tbody>
  </table>

  <h3 class="dd-h3">ABR ç®—æ³•å¯¦ä½œ</h3>
  <div class="dd-code-block">
    <div class="dd-code-header"><span>abr_algorithm.py</span><span class="dd-code-lang">Python</span></div>
    <div class="dd-code-body"><pre><span class="kw">class</span> <span class="type">ABRController</span>:
    <span class="cm">"""Buffer-based ABR algorithm (similar to Netflix's approach)"""</span>

    <span class="kw">def</span> <span class="fn">__init__</span>(<span class="kw">self</span>, bitrate_levels):
        <span class="kw">self</span>.bitrate_levels = <span class="fn">sorted</span>(bitrate_levels)  <span class="cm"># [400, 1000, 2500, 5000, 16000] kbps</span>
        <span class="kw">self</span>.buffer_low = <span class="num">5</span>     <span class="cm"># seconds â€” switch down below this</span>
        <span class="kw">self</span>.buffer_high = <span class="num">30</span>   <span class="cm"># seconds â€” safe to switch up</span>
        <span class="kw">self</span>.current_idx = <span class="num">0</span>

    <span class="kw">def</span> <span class="fn">select_bitrate</span>(<span class="kw">self</span>, buffer_level, measured_bandwidth):
        <span class="cm"># Step 1: Emergency â€” buffer critically low</span>
        <span class="kw">if</span> buffer_level &lt; <span class="kw">self</span>.buffer_low:
            <span class="kw">self</span>.current_idx = <span class="num">0</span>  <span class="cm"># Drop to lowest quality</span>
            <span class="kw">return</span> <span class="kw">self</span>.bitrate_levels[<span class="num">0</span>]

        <span class="cm"># Step 2: Find highest bitrate within bandwidth budget</span>
        safe_bitrate = measured_bandwidth * <span class="num">0.8</span>  <span class="cm"># 80% safety margin</span>
        max_viable = <span class="num">0</span>
        <span class="kw">for</span> i, br <span class="kw">in</span> <span class="fn">enumerate</span>(<span class="kw">self</span>.bitrate_levels):
            <span class="kw">if</span> br &lt;= safe_bitrate:
                max_viable = i

        <span class="cm"># Step 3: Gradual step-up / aggressive step-down</span>
        <span class="kw">if</span> max_viable &gt; <span class="kw">self</span>.current_idx <span class="kw">and</span> buffer_level &gt; <span class="kw">self</span>.buffer_high:
            <span class="kw">self</span>.current_idx = <span class="fn">min</span>(<span class="kw">self</span>.current_idx + <span class="num">1</span>, max_viable)
        <span class="kw">elif</span> max_viable &lt; <span class="kw">self</span>.current_idx:
            <span class="kw">self</span>.current_idx = max_viable  <span class="cm"># Drop immediately</span>

        <span class="kw">return</span> <span class="kw">self</span>.bitrate_levels[<span class="kw">self</span>.current_idx]</pre></div>
  </div>

  <div class="dd-info tip">
    <strong>ğŸ’¡ Tip</strong>
    Netflix çš„ ABR ä¸»è¦åŸºæ–¼ buffer æ°´ä½ï¼ˆbuffer-basedï¼‰ï¼Œè€Œ YouTube åå‘ throughput-basedã€‚Buffer-based å°çªç™¼æ€§é »å¯¬æ³¢å‹•æ›´ç©©å®šï¼Œthroughput-based å°ç©©å®šç¶²è·¯åæ‡‰æ›´å¿«ã€‚å¯¦å‹™ä¸Šå¸¸çµåˆå…©è€…ã€‚
  </div>
</section>

<!-- ===== 2.4 ENCODING PIPELINE ===== -->
<section class="dd-section" id="dd-encoding">
  <h2 class="dd-h2">03 â€” å½±ç‰‡ç·¨ç¢¼ Pipeline</h2>
  <p class="dd-sub">å¾åŸå§‹å½±ç‰‡åˆ°å¯ä¸²æµ segment çš„å®Œæ•´æµç¨‹</p>

  <h3 class="dd-h3">GOP-based Splitting åŸç†</h3>
  <p class="dd-text">GOP (Group of Pictures) æ˜¯å½±ç‰‡å£“ç¸®çš„åŸºæœ¬å–®ä½ã€‚ä¸€å€‹ GOP ä»¥ I-frameï¼ˆé—œéµå¹€, å®Œæ•´ç•«é¢ï¼‰é–‹é ­ï¼Œå¾ŒçºŒè·Ÿè‘— P-frameï¼ˆé æ¸¬å¹€ï¼‰å’Œ B-frameï¼ˆé›™å‘é æ¸¬å¹€ï¼‰ã€‚åˆ‡å‰²å½±ç‰‡æ™‚å¿…é ˆåœ¨ GOP é‚Šç•Œåˆ‡å‰²ï¼Œå¦å‰‡ chunk ç„¡æ³•ç¨ç«‹è§£ç¢¼ã€‚</p>

  <div class="dd-svg-wrap">
    <svg viewBox="0 0 700 180" xmlns="http://www.w3.org/2000/svg" font-family="'DM Sans', sans-serif">
      <!-- GOP 1 -->
      <rect x="20" y="40" width="200" height="70" rx="6" fill="none" stroke="#6366f1" stroke-width="1.5" stroke-dasharray="4,3"/>
      <text x="120" y="32" text-anchor="middle" font-size="9" font-weight="600" fill="#6366f1">GOP 1</text>
      <rect x="30" y="55" width="36" height="40" rx="4" fill="#ef4444" opacity="0.15" stroke="#ef4444" stroke-width="1"/><text x="48" y="79" text-anchor="middle" font-size="10" font-weight="700" fill="#ef4444">I</text>
      <rect x="72" y="55" width="28" height="40" rx="4" fill="#3b82f6" opacity="0.1" stroke="#3b82f6" stroke-width="1"/><text x="86" y="79" text-anchor="middle" font-size="10" font-weight="600" fill="#3b82f6">P</text>
      <rect x="106" y="55" width="28" height="40" rx="4" fill="#10b981" opacity="0.1" stroke="#10b981" stroke-width="1"/><text x="120" y="79" text-anchor="middle" font-size="10" font-weight="600" fill="#10b981">B</text>
      <rect x="140" y="55" width="28" height="40" rx="4" fill="#10b981" opacity="0.1" stroke="#10b981" stroke-width="1"/><text x="154" y="79" text-anchor="middle" font-size="10" font-weight="600" fill="#10b981">B</text>
      <rect x="174" y="55" width="28" height="40" rx="4" fill="#3b82f6" opacity="0.1" stroke="#3b82f6" stroke-width="1"/><text x="188" y="79" text-anchor="middle" font-size="10" font-weight="600" fill="#3b82f6">P</text>
      <!-- cut marker -->
      <line x1="228" y1="35" x2="228" y2="120" stroke="#f97316" stroke-width="2" stroke-dasharray="3,3"/><text x="228" y="138" text-anchor="middle" font-size="8" font-weight="600" fill="#f97316">âœ‚ CUT</text>
      <!-- GOP 2 -->
      <rect x="240" y="40" width="200" height="70" rx="6" fill="none" stroke="#6366f1" stroke-width="1.5" stroke-dasharray="4,3"/>
      <text x="340" y="32" text-anchor="middle" font-size="9" font-weight="600" fill="#6366f1">GOP 2</text>
      <rect x="250" y="55" width="36" height="40" rx="4" fill="#ef4444" opacity="0.15" stroke="#ef4444" stroke-width="1"/><text x="268" y="79" text-anchor="middle" font-size="10" font-weight="700" fill="#ef4444">I</text>
      <rect x="292" y="55" width="28" height="40" rx="4" fill="#3b82f6" opacity="0.1" stroke="#3b82f6" stroke-width="1"/><text x="306" y="79" text-anchor="middle" font-size="10" font-weight="600" fill="#3b82f6">P</text>
      <rect x="326" y="55" width="28" height="40" rx="4" fill="#10b981" opacity="0.1" stroke="#10b981" stroke-width="1"/><text x="340" y="79" text-anchor="middle" font-size="10" font-weight="600" fill="#10b981">B</text>
      <rect x="360" y="55" width="28" height="40" rx="4" fill="#10b981" opacity="0.1" stroke="#10b981" stroke-width="1"/><text x="374" y="79" text-anchor="middle" font-size="10" font-weight="600" fill="#10b981">B</text>
      <rect x="394" y="55" width="28" height="40" rx="4" fill="#3b82f6" opacity="0.1" stroke="#3b82f6" stroke-width="1"/><text x="408" y="79" text-anchor="middle" font-size="10" font-weight="600" fill="#3b82f6">P</text>
      <!-- Legend -->
      <rect x="490" y="45" width="16" height="16" rx="3" fill="#ef4444" opacity="0.2" stroke="#ef4444" stroke-width="1"/><text x="514" y="57" font-size="9" fill="#64748b">I-frame (keyframe)</text>
      <rect x="490" y="70" width="16" height="16" rx="3" fill="#3b82f6" opacity="0.15" stroke="#3b82f6" stroke-width="1"/><text x="514" y="82" font-size="9" fill="#64748b">P-frame (predicted)</text>
      <rect x="490" y="95" width="16" height="16" rx="3" fill="#10b981" opacity="0.15" stroke="#10b981" stroke-width="1"/><text x="514" y="107" font-size="9" fill="#64748b">B-frame (bidirectional)</text>
    </svg>
  </div>

  <h3 class="dd-h3">FFmpeg è½‰ç¢¼æŒ‡ä»¤</h3>
  <div class="dd-code-block">
    <div class="dd-code-header"><span>encode_pipeline.sh</span><span class="dd-code-lang">Bash</span></div>
    <div class="dd-code-body"><pre><span class="cm">#!/bin/bash</span>
<span class="cm"># Multi-resolution encoding pipeline for HLS</span>

<span class="kw">INPUT</span>=<span class="str">"raw_video.mp4"</span>
<span class="kw">OUTPUT_DIR</span>=<span class="str">"./output"</span>

<span class="cm"># Step 1: Split video at GOP boundaries</span>
ffmpeg -i <span class="str">"$INPUT"</span> -c copy -f segment \
  -segment_time <span class="num">10</span> \
  -reset_timestamps <span class="num">1</span> \
  <span class="str">"$OUTPUT_DIR/chunk_%03d.mp4"</span>

<span class="cm"># Step 2: Encode each chunk at multiple resolutions</span>
<span class="kw">for</span> chunk <span class="kw">in</span> <span class="str">"$OUTPUT_DIR"</span>/chunk_*.mp4; <span class="kw">do</span>
  base=$(<span class="fn">basename</span> <span class="str">"$chunk"</span> .mp4)

  <span class="cm"># 1080p @ 5 Mbps</span>
  ffmpeg -i <span class="str">"$chunk"</span> -vf <span class="str">"scale=1920:1080"</span> \
    -c:v libx264 -b:v <span class="num">5</span>M -preset fast \
    -c:a aac -b:a <span class="num">128</span>k \
    -hls_time <span class="num">6</span> -hls_list_size <span class="num">0</span> \
    <span class="str">"$OUTPUT_DIR/${base}_1080p.m3u8"</span>

  <span class="cm"># 720p @ 2.5 Mbps</span>
  ffmpeg -i <span class="str">"$chunk"</span> -vf <span class="str">"scale=1280:720"</span> \
    -c:v libx264 -b:v <span class="num">2.5</span>M -preset fast \
    -c:a aac -b:a <span class="num">96</span>k \
    -hls_time <span class="num">6</span> -hls_list_size <span class="num">0</span> \
    <span class="str">"$OUTPUT_DIR/${base}_720p.m3u8"</span>

  <span class="cm"># 480p @ 1 Mbps</span>
  ffmpeg -i <span class="str">"$chunk"</span> -vf <span class="str">"scale=854:480"</span> \
    -c:v libx264 -b:v <span class="num">1</span>M -preset fast \
    -c:a aac -b:a <span class="num">64</span>k \
    -hls_time <span class="num">6</span> -hls_list_size <span class="num">0</span> \
    <span class="str">"$OUTPUT_DIR/${base}_480p.m3u8"</span>
<span class="kw">done</span>

<span class="cm"># Step 3: Generate master playlist</span>
<span class="kw">cat</span> &gt; <span class="str">"$OUTPUT_DIR/master.m3u8"</span> &lt;&lt; <span class="str">EOF
#EXTM3U
#EXT-X-STREAM-INF:BANDWIDTH=5000000,RESOLUTION=1920x1080
stream_1080p.m3u8
#EXT-X-STREAM-INF:BANDWIDTH=2500000,RESOLUTION=1280x720
stream_720p.m3u8
#EXT-X-STREAM-INF:BANDWIDTH=1000000,RESOLUTION=854x480
stream_480p.m3u8
EOF</span></pre></div>
  </div>

  <h3 class="dd-h3">ç·¨ç¢¼è§£æåº¦èˆ‡ç¢¼ç‡å°ç…§è¡¨</h3>
  <table class="dd-compare-table">
    <thead><tr><th>è§£æåº¦</th><th>ç¢¼ç‡ (Video)</th><th>Audio</th><th>Segment å¤§å°</th><th>é©ç”¨å ´æ™¯</th></tr></thead>
    <tbody>
      <tr><td class="mono">3840Ã—2160 (4K)</td><td class="mono">16 Mbps</td><td class="mono">192 kbps</td><td class="mono">~12 MB/seg</td><td>Smart TV, é«˜é »å¯¬</td></tr>
      <tr><td class="mono">1920Ã—1080</td><td class="mono">5 Mbps</td><td class="mono">128 kbps</td><td class="mono">~3.8 MB/seg</td><td>Desktop, WiFi</td></tr>
      <tr><td class="mono">1280Ã—720</td><td class="mono">2.5 Mbps</td><td class="mono">96 kbps</td><td class="mono">~1.9 MB/seg</td><td>Tablet, 4G</td></tr>
      <tr><td class="mono">854Ã—480</td><td class="mono">1 Mbps</td><td class="mono">64 kbps</td><td class="mono">~0.8 MB/seg</td><td>Mobile, 3G</td></tr>
      <tr><td class="mono">426Ã—240</td><td class="mono">400 Kbps</td><td class="mono">48 kbps</td><td class="mono">~0.3 MB/seg</td><td>æ¥µä½é »å¯¬</td></tr>
    </tbody>
  </table>
</section>

<!-- ===== 2.5 CACHING DEEP DIVE ===== -->
<section class="dd-section" id="dd-caching">
  <h2 class="dd-h2">04 â€” å¿«å–ç­–ç•¥æ·±åº¦è§£æ</h2>
  <p class="dd-sub">Cache-Aside, Write-Through èˆ‡ CDN å¤šå±¤å¿«å–æ¶æ§‹</p>

  <div class="dd-info concept">
    <strong>ğŸ’¡ Concept</strong>
    æœ¬ç³»çµ±æœ‰å…©å±¤å¿«å–ï¼š(1) Redis å¿«å–å½±ç‰‡ metadataï¼ˆæ¨™é¡Œã€æè¿°ã€æ’­æ”¾ URLï¼‰ï¼Œ(2) CDN å¿«å–å¯¦éš›çš„å½±ç‰‡ segment æª”æ¡ˆã€‚å…©è€…çš„å¤±æ•ˆç­–ç•¥èˆ‡ä¸€è‡´æ€§éœ€æ±‚å®Œå…¨ä¸åŒã€‚
  </div>

  <h3 class="dd-h3">Cache-Aside Pattern å¯¦ä½œ</h3>
  <div class="dd-code-block">
    <div class="dd-code-header"><span>cache_aside.py</span><span class="dd-code-lang">Python</span></div>
    <div class="dd-code-body"><pre><span class="kw">import</span> redis
<span class="kw">import</span> json

<span class="kw">class</span> <span class="type">VideoMetadataService</span>:
    <span class="kw">def</span> <span class="fn">__init__</span>(<span class="kw">self</span>, redis_client, db):
        <span class="kw">self</span>.cache = redis_client
        <span class="kw">self</span>.db = db
        <span class="kw">self</span>.DEFAULT_TTL = <span class="num">3600</span>       <span class="cm"># 1 hour</span>
        <span class="kw">self</span>.HOT_VIDEO_TTL = <span class="num">86400</span>   <span class="cm"># 24 hours for popular videos</span>

    <span class="kw">def</span> <span class="fn">get_video</span>(<span class="kw">self</span>, video_id: <span class="type">str</span>) -> <span class="type">dict</span>:
        <span class="cm"># Step 1: Try cache first</span>
        cache_key = <span class="str">f"video:<span class="op">{</span>video_id<span class="op">}</span>"</span>
        cached = <span class="kw">self</span>.cache.<span class="fn">get</span>(cache_key)

        <span class="kw">if</span> cached:
            <span class="kw">return</span> json.<span class="fn">loads</span>(cached)  <span class="cm"># Cache HIT âš¡</span>

        <span class="cm"># Step 2: Cache MISS â†’ query read replica</span>
        video = <span class="kw">self</span>.db.<span class="fn">query</span>(
            <span class="str">"SELECT * FROM videos WHERE id = %s"</span>,
            [video_id],
            use_replica=<span class="kw">True</span>
        )

        <span class="kw">if</span> <span class="kw">not</span> video:
            <span class="kw">return</span> <span class="kw">None</span>

        <span class="cm"># Step 3: Populate cache with dynamic TTL</span>
        ttl = <span class="kw">self</span>.<span class="fn">_compute_ttl</span>(video)
        <span class="kw">self</span>.cache.<span class="fn">setex</span>(cache_key, ttl, json.<span class="fn">dumps</span>(video))

        <span class="kw">return</span> video

    <span class="kw">def</span> <span class="fn">_compute_ttl</span>(<span class="kw">self</span>, video) -> <span class="type">int</span>:
        <span class="cm"># Hot videos get longer TTL</span>
        <span class="kw">if</span> video[<span class="str">"view_count"</span>] > <span class="num">100_000</span>:
            <span class="kw">return</span> <span class="kw">self</span>.HOT_VIDEO_TTL
        <span class="kw">return</span> <span class="kw">self</span>.DEFAULT_TTL</pre></div>
  </div>

  <h3 class="dd-h3">å¿«å–ç­–ç•¥æ¯”è¼ƒ</h3>
  <table class="dd-compare-table">
    <thead><tr><th>ç­–ç•¥</th><th>è®€å–å»¶é²</th><th>å¯«å…¥å»¶é²</th><th>ä¸€è‡´æ€§</th><th>é©ç”¨å ´æ™¯</th></tr></thead>
    <tbody>
      <tr><td><strong>Cache-Aside</strong></td><td class="good">ä½ï¼ˆcache hitï¼‰</td><td class="good">ç„¡é¡å¤–å»¶é²</td><td class="mid">æœ€çµ‚ä¸€è‡´</td><td>Metadata è®€å– âœ…</td></tr>
      <tr><td><strong>Write-Through</strong></td><td class="good">ä½</td><td class="mid">è¼ƒé«˜ï¼ˆåŒæ­¥å¯« cacheï¼‰</td><td class="good">å¼·ä¸€è‡´</td><td>éœ€è¦å³æ™‚æ›´æ–°çš„å ´æ™¯</td></tr>
      <tr><td><strong>Write-Behind</strong></td><td class="good">ä½</td><td class="good">ä½ï¼ˆç•°æ­¥å¯« DBï¼‰</td><td class="bad">å¼±ä¸€è‡´</td><td>é«˜é »å¯«å…¥ï¼ˆview countï¼‰</td></tr>
      <tr><td><strong>Read-Through</strong></td><td class="good">ä½</td><td class="good">ç„¡é¡å¤–å»¶é²</td><td class="mid">æœ€çµ‚ä¸€è‡´</td><td>Cache æ¡†æ¶æ•´åˆ</td></tr>
    </tbody>
  </table>

  <div class="dd-info warning">
    <strong>âš ï¸ Warning â€” Cache Stampede</strong>
    ç•¶ç†±é–€å½±ç‰‡çš„ cache åŒæ™‚éæœŸæ™‚ï¼Œå¤§é‡è«‹æ±‚æœƒåŒæ™‚æ‰“åˆ° DBï¼ˆthundering herdï¼‰ã€‚è§£æ³•ï¼šä½¿ç”¨ singleflight / mutex lock ç¢ºä¿åªæœ‰ä¸€å€‹è«‹æ±‚æŸ¥ DB ä¸¦å›å¡« cacheï¼Œå…¶ä»–è«‹æ±‚ç­‰å¾…ï¼›æˆ–ä½¿ç”¨ jittered TTL è®“éæœŸæ™‚é–“åˆ†æ•£ã€‚
  </div>
</section>

<!-- ===== 2.6 SEARCH ENGINE ===== -->
<section class="dd-section-alt" id="dd-search">
  <h2 class="dd-h2">05 â€” æœå°‹å¼•æ“å¯¦ä½œ</h2>
  <p class="dd-sub">Elasticsearch + CDC çš„å…¨æ–‡æœå°‹æ¶æ§‹</p>

  <h3 class="dd-h3">CDC (Change Data Capture) åŒæ­¥æµç¨‹</h3>
  <p class="dd-text">ä½¿ç”¨ Debezium ç›£è½ PostgreSQL çš„ WAL (Write-Ahead Log)ï¼Œå°‡ videos è¡¨çš„ INSERT / UPDATE / DELETE è®Šæ›´äº‹ä»¶æ¨å…¥ Kafka topicï¼Œå†ç”± Elasticsearch Connector æ¶ˆè²»ä¸¦æ›´æ–°æœå°‹ç´¢å¼•ã€‚é€™æ¨£æœå°‹ç´¢å¼•çš„æ›´æ–°èˆ‡è³‡æ–™åº«å¯«å…¥å®Œå…¨è§£è€¦ã€‚</p>

  <div class="dd-code-block">
    <div class="dd-code-header"><span>elasticsearch_mapping.json</span><span class="dd-code-lang">JSON</span></div>
    <div class="dd-code-body"><pre>{
  <span class="str">"mappings"</span>: {
    <span class="str">"properties"</span>: {
      <span class="str">"title"</span>:       { <span class="str">"type"</span>: <span class="str">"text"</span>, <span class="str">"analyzer"</span>: <span class="str">"icu_analyzer"</span> },
      <span class="str">"description"</span>: { <span class="str">"type"</span>: <span class="str">"text"</span>, <span class="str">"analyzer"</span>: <span class="str">"icu_analyzer"</span> },
      <span class="str">"tags"</span>:        { <span class="str">"type"</span>: <span class="str">"keyword"</span> },
      <span class="str">"creator"</span>:     { <span class="str">"type"</span>: <span class="str">"keyword"</span> },
      <span class="str">"view_count"</span>:  { <span class="str">"type"</span>: <span class="str">"long"</span> },
      <span class="str">"created_at"</span>:  { <span class="str">"type"</span>: <span class="str">"date"</span> },
      <span class="str">"duration"</span>:    { <span class="str">"type"</span>: <span class="str">"integer"</span> },
      <span class="str">"suggest"</span>:     { <span class="str">"type"</span>: <span class="str">"completion"</span> }
    }
  }
}</pre></div>
  </div>

  <h3 class="dd-h3">è‡ªè¨‚æ’åºæŸ¥è©¢ï¼ˆBM25 + Boostingï¼‰</h3>
  <div class="dd-code-block">
    <div class="dd-code-header"><span>search_query.json</span><span class="dd-code-lang">Elasticsearch DSL</span></div>
    <div class="dd-code-body"><pre>{
  <span class="str">"query"</span>: {
    <span class="str">"function_score"</span>: {
      <span class="str">"query"</span>: {
        <span class="str">"multi_match"</span>: {
          <span class="str">"query"</span>: <span class="str">"funny cat videos"</span>,
          <span class="str">"fields"</span>: [<span class="str">"title^3"</span>, <span class="str">"description"</span>, <span class="str">"tags^2"</span>]
        }
      },
      <span class="str">"functions"</span>: [
        {
          <span class="str">"field_value_factor"</span>: {
            <span class="str">"field"</span>: <span class="str">"view_count"</span>,
            <span class="str">"modifier"</span>: <span class="str">"log1p"</span>,  <span class="cm">// dampened popularity boost</span>
            <span class="str">"factor"</span>: <span class="num">0.5</span>
          }
        },
        {
          <span class="str">"gauss"</span>: {
            <span class="str">"created_at"</span>: {
              <span class="str">"origin"</span>: <span class="str">"now"</span>,
              <span class="str">"scale"</span>: <span class="str">"30d"</span>,    <span class="cm">// freshness decay</span>
              <span class="str">"decay"</span>: <span class="num">0.5</span>
            }
          }
        }
      ],
      <span class="str">"boost_mode"</span>: <span class="str">"multiply"</span>
    }
  }
}</pre></div>
  </div>

  <div class="dd-info tip">
    <strong>ğŸ’¡ Tip</strong>
    ä½¿ç”¨ <code>multi_match</code> åœ¨å¤šå€‹æ¬„ä½æœå°‹ï¼Œä¸¦ç”¨ <code>^</code> è¨­å®šæ¬Šé‡ï¼ˆtitle æ¬Šé‡æœ€é«˜ï¼‰ã€‚<code>function_score</code> çµåˆ BM25 æ–‡å­—ç›¸é—œæ€§èˆ‡ view_count ç†±åº¦å’Œ created_at æ–°é®®åº¦ï¼Œå¯ç”¢å‡ºæ›´ç¬¦åˆç”¨æˆ¶é æœŸçš„æœå°‹çµæœã€‚
  </div>
</section>

<!-- ===== 2.7 DISTRIBUTED CONSIDERATIONS ===== -->
<section class="dd-section" id="dd-distributed">
  <h2 class="dd-h2">06 â€” åˆ†æ•£å¼è€ƒé‡</h2>
  <p class="dd-sub">Sharding, Replication, Consistency çš„è¨­è¨ˆæŠ‰æ“‡</p>

  <div class="dd-info concept">
    <strong>ğŸ’¡ Concept â€” CAP Theorem åœ¨æœ¬ç³»çµ±çš„æ‡‰ç”¨</strong>
    å½±ç‰‡ä¸²æµå¹³å°é¸æ“‡ APï¼ˆå¯ç”¨æ€§ + åˆ†å€å®¹å¿ï¼‰è€Œé CPã€‚åŸå› ï¼šçŸ­æš«çš„è³‡æ–™ä¸ä¸€è‡´ï¼ˆæ–°å½±ç‰‡æ™šå¹¾ç§’æ‰èƒ½è¢«æœå°‹åˆ°ï¼‰æ˜¯å¯æ¥å—çš„ï¼Œä½†æœå‹™ä¸­æ–·ï¼ˆç”¨æˆ¶ç„¡æ³•è§€çœ‹å½±ç‰‡ï¼‰æ˜¯ä¸å¯æ¥å—çš„ã€‚å› æ­¤å…¨é¢æ¡ç”¨æœ€çµ‚ä¸€è‡´æ€§æ¨¡å‹ã€‚
  </div>

  <h3 class="dd-h3">Metadata DB Sharding ç­–ç•¥</h3>
  <p class="dd-text">éš¨è‘—å½±ç‰‡æ•¸é‡å¢é•·åˆ°ä¸Šå„„ï¼Œå–®ä¸€ PostgreSQL å¯¦ä¾‹ç„¡æ³•æ”¯æ’ã€‚éœ€è¦æŒ‰ video_id é€²è¡Œæ°´å¹³åˆ†ç‰‡ï¼ˆshardingï¼‰ã€‚é¸æ“‡ video_id ä½œç‚º shard key çš„åŸå› ï¼šè®€å–å’Œå¯«å…¥å¹¾ä¹éƒ½ä»¥ video_id ä½œç‚ºä¸»éµæŸ¥è©¢ï¼Œå¯ä»¥ä¿è­‰å–®ä¸€æŸ¥è©¢åªæ‰“åˆ°ä¸€å€‹ shardã€‚</p>

  <div class="dd-code-block">
    <div class="dd-code-header"><span>shard_routing.py</span><span class="dd-code-lang">Python</span></div>
    <div class="dd-code-body"><pre><span class="kw">import</span> hashlib

<span class="kw">class</span> <span class="type">ShardRouter</span>:
    <span class="cm">"""Consistent hash-based shard routing for Metadata DB"""</span>

    <span class="kw">def</span> <span class="fn">__init__</span>(<span class="kw">self</span>, num_shards: <span class="type">int</span> = <span class="num">16</span>):
        <span class="kw">self</span>.num_shards = num_shards
        <span class="kw">self</span>.connections = {
            i: <span class="fn">create_db_connection</span>(<span class="str">f"shard-<span class="op">{</span>i<span class="op">}</span>.db.internal"</span>)
            <span class="kw">for</span> i <span class="kw">in</span> <span class="fn">range</span>(num_shards)
        }

    <span class="kw">def</span> <span class="fn">get_shard</span>(<span class="kw">self</span>, video_id: <span class="type">str</span>) -> <span class="type">int</span>:
        <span class="cm"># SHA-256 hash â†’ modulo for uniform distribution</span>
        hash_val = hashlib.<span class="fn">sha256</span>(
            video_id.<span class="fn">encode</span>()
        ).<span class="fn">hexdigest</span>()
        <span class="kw">return</span> <span class="fn">int</span>(hash_val, <span class="num">16</span>) % <span class="kw">self</span>.num_shards

    <span class="kw">def</span> <span class="fn">query</span>(<span class="kw">self</span>, video_id, sql, params):
        shard_id = <span class="kw">self</span>.<span class="fn">get_shard</span>(video_id)
        conn = <span class="kw">self</span>.connections[shard_id]
        <span class="kw">return</span> conn.<span class="fn">execute</span>(sql, params)</pre></div>
  </div>

  <h3 class="dd-h3">Replication æ‹“æ’²</h3>
  <table class="dd-compare-table">
    <thead><tr><th>æ¨¡å¼</th><th>å»¶é²</th><th>ä¸€è‡´æ€§</th><th>å¯ç”¨æ€§</th><th>æœ¬ç³»çµ±ä½¿ç”¨</th></tr></thead>
    <tbody>
      <tr><td><strong>åŒæ­¥è¤‡è£½</strong></td><td class="bad">é«˜ï¼ˆç­‰å¾… replica ACKï¼‰</td><td class="good">å¼·ä¸€è‡´</td><td class="mid">é™ä½ï¼ˆreplica æ•…éšœé˜»å¡å¯«å…¥ï¼‰</td><td>âŒ</td></tr>
      <tr><td><strong>éåŒæ­¥è¤‡è£½</strong></td><td class="good">ä½</td><td class="mid">æœ€çµ‚ä¸€è‡´</td><td class="good">é«˜</td><td>âœ… Metadata DB</td></tr>
      <tr><td><strong>åŠåŒæ­¥</strong></td><td class="mid">ä¸­ç­‰</td><td class="mid">æº–ä¸€è‡´</td><td class="mid">ä¸­ç­‰</td><td>âŒ éå¿…è¦</td></tr>
    </tbody>
  </table>

  <div class="dd-info important">
    <strong>âš ï¸ Important â€” è·¨å€åŸŸè¤‡è£½</strong>
    å°æ–¼å…¨çƒæ€§å½±ç‰‡å¹³å°ï¼Œéœ€è¦è·¨å€åŸŸè¤‡è£½ Metadata DBã€‚ä½¿ç”¨éåŒæ­¥è¤‡è£½æ­é… conflict resolutionï¼ˆlast-write-winsï¼‰ï¼Œå»¶é²é€šå¸¸åœ¨ 100-500msã€‚CDN å’Œ Object Store (S3) æœ¬èº«å°±æ”¯æ´è·¨å€åŸŸï¼Œé€é S3 Cross-Region Replication è‡ªå‹•åŒæ­¥ã€‚
  </div>
</section>

<!-- ===== 2.8 STORAGE IMPLEMENTATION ===== -->
<section class="dd-section-alt" id="dd-storage">
  <h2 class="dd-h2">07 â€” å„²å­˜èˆ‡è³‡æ–™åº«å¯¦ä½œ</h2>
  <p class="dd-sub">Redis å¿«å–ã€PostgreSQL Schemaã€S3 å„²å­˜çµæ§‹</p>

  <h3 class="dd-h3">Redis è³‡æ–™çµæ§‹é¸å‹</h3>
  <table class="dd-compare-table">
    <thead><tr><th>è³‡æ–™</th><th>Redis çµæ§‹</th><th>Key Pattern</th><th>TTL</th></tr></thead>
    <tbody>
      <tr><td>å½±ç‰‡ metadata</td><td class="mono">String (JSON)</td><td class="mono">video:{id}</td><td class="mono">1h-24h (ä¾ç†±åº¦)</td></tr>
      <tr><td>è§€çœ‹æ¬¡æ•¸</td><td class="mono">String (INCR)</td><td class="mono">views:{id}</td><td class="mono">ç„¡ (æŒä¹…åŒ–)</td></tr>
      <tr><td>ç”¨æˆ¶æ’­æ”¾é€²åº¦</td><td class="mono">Hash</td><td class="mono">progress:{user_id}</td><td class="mono">30d</td></tr>
      <tr><td>ç†±é–€å½±ç‰‡æ’è¡Œ</td><td class="mono">Sorted Set</td><td class="mono">trending:daily</td><td class="mono">24h</td></tr>
      <tr><td>æœå°‹è‡ªå‹•è£œå…¨</td><td class="mono">Sorted Set</td><td class="mono">autocomplete:{prefix}</td><td class="mono">1h</td></tr>
    </tbody>
  </table>

  <h3 class="dd-h3">Redis Lua Script â€” åŸå­æ€§è§€çœ‹æ¬¡æ•¸æ›´æ–°</h3>
  <div class="dd-code-block">
    <div class="dd-code-header"><span>view_counter.lua</span><span class="dd-code-lang">Lua (Redis)</span></div>
    <div class="dd-code-body"><pre><span class="cm">-- Atomic view count increment + trending update</span>
<span class="cm">-- KEYS[1] = "views:{video_id}"</span>
<span class="cm">-- KEYS[2] = "trending:daily"</span>
<span class="cm">-- ARGV[1] = video_id</span>

<span class="kw">local</span> new_count = redis.<span class="fn">call</span>(<span class="str">"INCR"</span>, KEYS[<span class="num">1</span>])

<span class="cm">-- Update trending sorted set with new view count</span>
redis.<span class="fn">call</span>(<span class="str">"ZADD"</span>, KEYS[<span class="num">2</span>], new_count, ARGV[<span class="num">1</span>])

<span class="cm">-- Set TTL for daily trending (reset daily)</span>
redis.<span class="fn">call</span>(<span class="str">"EXPIRE"</span>, KEYS[<span class="num">2</span>], <span class="num">86400</span>)

<span class="kw">return</span> new_count</pre></div>
  </div>

  <h3 class="dd-h3">PostgreSQL Schema</h3>
  <div class="dd-code-block">
    <div class="dd-code-header"><span>schema.sql</span><span class="dd-code-lang">SQL</span></div>
    <div class="dd-code-body"><pre><span class="kw">CREATE TABLE</span> <span class="type">videos</span> (
    id            <span class="type">UUID</span> <span class="kw">PRIMARY KEY DEFAULT</span> <span class="fn">gen_random_uuid</span>(),
    title         <span class="type">VARCHAR</span>(<span class="num">500</span>) <span class="kw">NOT NULL</span>,
    description   <span class="type">TEXT</span>,
    creator_id    <span class="type">UUID</span> <span class="kw">NOT NULL REFERENCES</span> users(id),
    duration_sec  <span class="type">INTEGER</span>,
    status        <span class="type">VARCHAR</span>(<span class="num">20</span>) <span class="kw">DEFAULT</span> <span class="str">'processing'</span>,
    <span class="cm">-- 'processing' | 'ready' | 'failed'</span>
    s3_raw_key    <span class="type">VARCHAR</span>(<span class="num">1024</span>),
    manifest_url  <span class="type">VARCHAR</span>(<span class="num">1024</span>),   <span class="cm">-- HLS master.m3u8 URL</span>
    thumbnail_url <span class="type">VARCHAR</span>(<span class="num">1024</span>),
    view_count    <span class="type">BIGINT</span> <span class="kw">DEFAULT</span> <span class="num">0</span>,
    tags          <span class="type">TEXT</span>[],
    created_at    <span class="type">TIMESTAMPTZ</span> <span class="kw">DEFAULT</span> <span class="fn">NOW</span>(),
    updated_at    <span class="type">TIMESTAMPTZ</span> <span class="kw">DEFAULT</span> <span class="fn">NOW</span>()
);

<span class="kw">CREATE INDEX</span> idx_videos_creator <span class="kw">ON</span> videos(creator_id);
<span class="kw">CREATE INDEX</span> idx_videos_status  <span class="kw">ON</span> videos(status);
<span class="kw">CREATE INDEX</span> idx_videos_created <span class="kw">ON</span> videos(created_at <span class="kw">DESC</span>);

<span class="cm">-- Encoding jobs tracking table</span>
<span class="kw">CREATE TABLE</span> <span class="type">encoding_jobs</span> (
    id          <span class="type">UUID</span> <span class="kw">PRIMARY KEY</span>,
    video_id    <span class="type">UUID</span> <span class="kw">REFERENCES</span> videos(id),
    resolution  <span class="type">VARCHAR</span>(<span class="num">10</span>),  <span class="cm">-- '1080p', '720p', etc.</span>
    status      <span class="type">VARCHAR</span>(<span class="num">20</span>),  <span class="cm">-- 'pending' | 'running' | 'done' | 'failed'</span>
    s3_output   <span class="type">VARCHAR</span>(<span class="num">1024</span>),
    started_at  <span class="type">TIMESTAMPTZ</span>,
    finished_at <span class="type">TIMESTAMPTZ</span>
);</pre></div>
  </div>

  <h3 class="dd-h3">S3 å„²å­˜çµæ§‹</h3>
  <div class="dd-code-block">
    <div class="dd-code-header"><span>s3_structure.txt</span><span class="dd-code-lang">S3 Key Layout</span></div>
    <div class="dd-code-body"><pre>s3://prime-video-bucket/
â”œâ”€â”€ raw/                          <span class="cm"># åŸå§‹ä¸Šå‚³å½±ç‰‡</span>
â”‚   â””â”€â”€ {video_id}/
â”‚       â””â”€â”€ original.mp4
â”œâ”€â”€ encoded/                      <span class="cm"># è½‰ç¢¼å¾Œçš„ HLS segments</span>
â”‚   â””â”€â”€ {video_id}/
â”‚       â”œâ”€â”€ master.m3u8           <span class="cm"># Master playlist</span>
â”‚       â”œâ”€â”€ 1080p/
â”‚       â”‚   â”œâ”€â”€ stream.m3u8
â”‚       â”‚   â”œâ”€â”€ seg_000.ts
â”‚       â”‚   â”œâ”€â”€ seg_001.ts
â”‚       â”‚   â””â”€â”€ ...
â”‚       â”œâ”€â”€ 720p/
â”‚       â”‚   â”œâ”€â”€ stream.m3u8
â”‚       â”‚   â””â”€â”€ ...
â”‚       â”œâ”€â”€ 480p/
â”‚       â””â”€â”€ 240p/
â””â”€â”€ thumbnails/                   <span class="cm"># ç¸®åœ–</span>
    â””â”€â”€ {video_id}/
        â”œâ”€â”€ default.jpg
        â””â”€â”€ sprite.jpg            <span class="cm"># Timeline hover é è¦½</span></pre></div>
  </div>
</section>

<!-- ===== 2.9 API DESIGN ===== -->
<section class="dd-section" id="dd-api">
  <h2 class="dd-h2">08 â€” API è¨­è¨ˆèˆ‡å”è­°</h2>
  <p class="dd-sub">RESTful API ç«¯é»ã€Presigned URL æµç¨‹ã€CDN ç°½å</p>

  <h3 class="dd-h3">æ ¸å¿ƒ API ç«¯é»</h3>
  <div class="dd-code-block">
    <div class="dd-code-header"><span>api_endpoints.yaml</span><span class="dd-code-lang">REST API</span></div>
    <div class="dd-code-body"><pre><span class="cm"># ===== Upload Flow =====</span>
<span class="kw">POST</span>   /api/v1/videos/upload-url
  <span class="cm"># Request: { title, description, tags, file_size, content_type }</span>
  <span class="cm"># Response: { video_id, presigned_url, expires_in: 3600 }</span>

<span class="kw">POST</span>   /api/v1/videos/{id}/complete
  <span class="cm"># Called after client finishes uploading to S3</span>
  <span class="cm"># Triggers encoding pipeline</span>

<span class="cm"># ===== View Flow =====</span>
<span class="kw">GET</span>    /api/v1/videos/{id}
  <span class="cm"># Response: { id, title, manifest_url, thumbnail, creator, ... }</span>
  <span class="cm"># manifest_url is a CDN signed URL</span>

<span class="kw">GET</span>    /api/v1/videos/{id}/stream
  <span class="cm"># Redirect 302 â†’ CDN signed manifest URL</span>

<span class="cm"># ===== Search Flow =====</span>
<span class="kw">GET</span>    /api/v1/search?q={query}&page={n}&size={n}
  <span class="cm"># Response: { results: [...], total, page, has_next }</span>

<span class="kw">GET</span>    /api/v1/search/suggest?q={prefix}
  <span class="cm"># Response: { suggestions: ["funny cats", "funny dogs", ...] }</span></pre></div>
  </div>

  <h3 class="dd-h3">Presigned URL ä¸Šå‚³æµç¨‹</h3>
  <div class="dd-code-block">
    <div class="dd-code-header"><span>presigned_url.py</span><span class="dd-code-lang">Python (boto3)</span></div>
    <div class="dd-code-body"><pre><span class="kw">import</span> boto3
<span class="kw">from</span> datetime <span class="kw">import</span> timedelta

<span class="kw">def</span> <span class="fn">generate_upload_url</span>(video_id: <span class="type">str</span>, content_type: <span class="type">str</span>) -> <span class="type">str</span>:
    s3 = boto3.<span class="fn">client</span>(<span class="str">"s3"</span>)

    presigned_url = s3.<span class="fn">generate_presigned_url</span>(
        <span class="str">"put_object"</span>,
        Params={
            <span class="str">"Bucket"</span>: <span class="str">"prime-video-bucket"</span>,
            <span class="str">"Key"</span>: <span class="str">f"raw/<span class="op">{</span>video_id<span class="op">}</span>/original.mp4"</span>,
            <span class="str">"ContentType"</span>: content_type,
            <span class="str">"Metadata"</span>: {
                <span class="str">"video-id"</span>: video_id
            }
        },
        ExpiresIn=<span class="num">3600</span>  <span class="cm"># URL valid for 1 hour</span>
    )

    <span class="kw">return</span> presigned_url


<span class="kw">def</span> <span class="fn">generate_playback_url</span>(video_id: <span class="type">str</span>) -> <span class="type">str</span>:
    <span class="cm">"""Generate CDN signed URL for playback"""</span>
    cloudfront = boto3.<span class="fn">client</span>(<span class="str">"cloudfront"</span>)

    <span class="kw">return</span> cloudfront.<span class="fn">generate_presigned_url</span>(
        <span class="str">f"https://cdn.primevideo.com/encoded/<span class="op">{</span>video_id<span class="op">}</span>/master.m3u8"</span>,
        date_less_than=datetime.<span class="fn">utcnow</span>() + timedelta(hours=<span class="num">4</span>),
        key_pair_id=<span class="str">"CLOUDFRONT_KEY_PAIR_ID"</span>,
        private_key_string=PRIVATE_KEY
    )</pre></div>
  </div>

  <h3 class="dd-h3">HTTP Response Codes</h3>
  <table class="dd-compare-table">
    <thead><tr><th>Code</th><th>å ´æ™¯</th><th>èªªæ˜</th></tr></thead>
    <tbody>
      <tr><td class="mono">200 OK</td><td>GET /videos/{id}</td><td>æˆåŠŸå–å¾—å½±ç‰‡ metadata</td></tr>
      <tr><td class="mono">201 Created</td><td>POST /videos/upload-url</td><td>æˆåŠŸç”¢ç”Ÿ presigned URL</td></tr>
      <tr><td class="mono">202 Accepted</td><td>POST /videos/{id}/complete</td><td>è½‰ç¢¼ä»»å‹™å·²æ’å…¥ä½‡åˆ—</td></tr>
      <tr><td class="mono">302 Found</td><td>GET /videos/{id}/stream</td><td>é‡å°å‘è‡³ CDN ç°½å URL</td></tr>
      <tr><td class="mono">404 Not Found</td><td>å½±ç‰‡ ID ä¸å­˜åœ¨</td><td>å½±ç‰‡ä¸å­˜åœ¨æˆ–ä»åœ¨è½‰ç¢¼ä¸­</td></tr>
      <tr><td class="mono">429 Too Many Requests</td><td>Rate limiting</td><td>å« Retry-After header</td></tr>
    </tbody>
  </table>
</section>

<!-- ===== 2.10 OPERATIONAL STRATEGIES ===== -->
<section class="dd-section-alt" id="dd-ops">
  <h2 class="dd-h2">09 â€” é‹ç‡Ÿç­–ç•¥</h2>
  <p class="dd-sub">ç›£æ§ã€é™ç´šã€æ•…éšœè™•ç†èˆ‡æˆæœ¬å„ªåŒ–</p>

  <h3 class="dd-h3">åˆ†ç´šæœå‹™é…ç½®</h3>
  <div class="dd-code-block">
    <div class="dd-code-header"><span>service_tiers.yaml</span><span class="dd-code-lang">YAML</span></div>
    <div class="dd-code-body"><pre><span class="cm"># Video encoding priority tiers</span>
encoding_tiers:
  premium:              <span class="cm"># Prime subscribers</span>
    max_resolution: <span class="str">"4K"</span>
    priority: <span class="num">1</span>         <span class="cm"># Highest priority in queue</span>
    max_wait_time: <span class="str">"5m"</span>
    concurrent_jobs: <span class="num">4</span>

  standard:             <span class="cm"># Free tier users</span>
    max_resolution: <span class="str">"1080p"</span>
    priority: <span class="num">3</span>
    max_wait_time: <span class="str">"30m"</span>
    concurrent_jobs: <span class="num">1</span>

<span class="cm"># CDN cache rules</span>
cdn_cache_policy:
  video_segments:
    ttl: <span class="str">"7d"</span>           <span class="cm"># Segments are immutable</span>
    stale_while_revalidate: <span class="str">"1h"</span>

  manifests:
    ttl: <span class="str">"10s"</span>          <span class="cm"># Short TTL for live content</span>

  thumbnails:
    ttl: <span class="str">"30d"</span>

<span class="cm"># Auto-scaling rules</span>
autoscaling:
  encoder_workers:
    min: <span class="num">10</span>
    max: <span class="num">500</span>
    scale_up_threshold: <span class="str">"queue_depth > 1000"</span>
    scale_down_threshold: <span class="str">"queue_depth < 100"</span>
    cooldown: <span class="str">"5m"</span></pre></div>
  </div>

  <h3 class="dd-h3">é™ç´šç­–ç•¥ï¼ˆGraceful Degradationï¼‰</h3>
  <div class="dd-kp-grid">
    <div class="dd-kp-card">
      <h4>ğŸ”´ Cache æ•…éšœ</h4>
      <p><strong>Fail-open</strong>ï¼šRedis ä¸å¯ç”¨æ™‚ç›´æ¥æŸ¥ DB Read Replicaã€‚å»¶é²å¢åŠ ä½†æœå‹™ä¸ä¸­æ–·ã€‚éœ€è¨­å®š circuit breaker é¿å… DB éè¼‰ã€‚</p>
    </div>
    <div class="dd-kp-card">
      <h4>ğŸŸ¡ Encoder éè¼‰</h4>
      <p>Queue æ·±åº¦è¶…éé–¾å€¼æ™‚ï¼šé™ä½å…è²»ç”¨æˆ¶çš„æœ€å¤§è§£æåº¦ã€å»¶å¾Œéç†±é–€åœ°å€çš„è½‰ç¢¼ä»»å‹™ã€åªå…ˆç”¢ç”Ÿ 720p ç‰ˆæœ¬ã€‚</p>
    </div>
    <div class="dd-kp-card">
      <h4>ğŸŸ  Search ä¸å¯ç”¨</h4>
      <p>Elasticsearch æ•…éšœæ™‚ fallback åˆ° DB LIKE æŸ¥è©¢ï¼ˆæ€§èƒ½è¼ƒå·®ä½†å¯ç”¨ï¼‰ã€‚æˆ–å›å‚³å¿«å–çš„ç†±é–€æœå°‹çµæœã€‚</p>
    </div>
    <div class="dd-kp-card">
      <h4>ğŸŸ¢ CDN å±€éƒ¨æ•…éšœ</h4>
      <p>æŸå€åŸŸ CDN edge æ•…éšœæ™‚è‡ªå‹• failover åˆ°ä¸‹ä¸€å€‹æœ€è¿‘çš„ edgeã€‚æ¥µç«¯æƒ…æ³ç›´æ¥å¾ S3 origin å›æ‡‰ï¼ˆå»¶é²å¢åŠ ï¼‰ã€‚</p>
    </div>
  </div>

  <div class="dd-info tip">
    <strong>ğŸ’¡ Tip â€” æˆæœ¬å„ªåŒ–</strong>
    S3 Intelligent-Tiering è‡ªå‹•å°‡ 30 å¤©æœªå­˜å–çš„å½±ç‰‡ç§»è‡³ä½æˆæœ¬å±¤ã€‚CDN çš„ hit rate ç›´æ¥å½±éŸ¿ S3 å‡ºå£è²»ç”¨â€”â€”hit rate å¾ 90% æå‡åˆ° 95% å¯ç¯€çœ 50% çš„ origin æµé‡ã€‚è½‰ç¢¼å®Œæˆå¾Œåˆªé™¤åŸå§‹å½±ç‰‡çš„ã€ŒåŸå§‹è§£æåº¦ã€ç‰ˆæœ¬ä¹Ÿèƒ½ç¯€çœç´„ 20% å„²å­˜ã€‚
  </div>
</section>

<!-- ===== 2.11 INTERVIEW Q&A ===== -->
<section class="dd-section" id="dd-interview">
  <h2 class="dd-h2">10 â€” é¢è©¦é¡Œåº« Interview Q&A</h2>
  <p class="dd-sub">å¸¸è¦‹å½±ç‰‡ä¸²æµç³»çµ±è¨­è¨ˆé¢è©¦å•é¡Œèˆ‡è©³ç´°è§£ç­”</p>

  <!-- Q1 -->
  <div class="dd-accordion" onclick="this.classList.toggle('open')">
    <button class="dd-accordion-header">
      <span>Q1ï¼šç‚ºä»€éº¼é¸æ“‡ Presigned URL è€Œä¸æ˜¯è®“å½±ç‰‡ç¶“éæ‡‰ç”¨ä¼ºæœå™¨ï¼Ÿ</span>
      <span class="dd-accordion-chevron">â–¼</span>
    </button>
    <div class="dd-accordion-body">
      <p>æ ¸å¿ƒè€ƒé‡æ˜¯<strong>é »å¯¬èˆ‡ CPU æ•ˆç‡</strong>ï¼š</p>
      <ul>
        <li>å½±ç‰‡æª”æ¡ˆé€šå¸¸æ•¸ç™¾ MB åˆ°æ•¸ GBï¼Œç¶“ç”±æ‡‰ç”¨ä¼ºæœå™¨ä¸­è½‰æœƒæ¶ˆè€—å¤§é‡é »å¯¬å’Œè¨˜æ†¶é«”</li>
        <li>Presigned URL è®“å®¢æˆ¶ç«¯ç›´æ¥ä¸Šå‚³åˆ° S3ï¼Œä¼ºæœå™¨åªè™•ç†è¼•é‡çš„ metadataï¼ˆå¹¾ KBï¼‰</li>
        <li>S3 åŸç”Ÿæ”¯æ´ multipart upload å’Œæ–·é»çºŒå‚³ï¼Œæ¯”è‡ªå»ºä¸Šå‚³æœå‹™æ›´å¯é </li>
        <li>æ¸›å°‘ä¼ºæœå™¨æˆæœ¬ï¼šä¸éœ€è¦ç‚ºå½±ç‰‡æµé‡è³¼è²·å¤§é‡é »å¯¬</li>
      </ul>
      <div class="dd-info important">
        <strong>âš ï¸ Trade-off</strong>
        Presigned URL çš„ç¼ºé»æ˜¯å®¢æˆ¶ç«¯å¯ä»¥åœ¨ URL æœ‰æ•ˆæœŸå…§å¤šæ¬¡ä¸Šå‚³æˆ–ä¸Šå‚³éé æœŸå…§å®¹ã€‚éœ€è¦æ­é… S3 äº‹ä»¶é€šçŸ¥ + Lambda é€²è¡Œä¸Šå‚³å¾Œé©—è­‰ã€‚
      </div>
    </div>
  </div>

  <!-- Q2 -->
  <div class="dd-accordion" onclick="this.classList.toggle('open')">
    <button class="dd-accordion-header">
      <span>Q2ï¼šå¦‚ä½•è™•ç†å½±ç‰‡ä¸Šå‚³å¤±æ•—å’Œé‡è©¦ï¼Ÿ</span>
      <span class="dd-accordion-chevron">â–¼</span>
    </button>
    <div class="dd-accordion-body">
      <p>éœ€è¦å¤šå±¤å¯é æ€§ä¿éšœï¼š</p>
      <ul>
        <li><strong>å®¢æˆ¶ç«¯</strong>ï¼šä½¿ç”¨ S3 multipart uploadï¼Œæ¯å€‹ part 5-100 MBï¼›å¤±æ•—åªéœ€é‡å‚³å¤±æ•—çš„ partï¼Œä¸éœ€å¾é ­é–‹å§‹</li>
        <li><strong>ä¸Šå‚³å”è­°</strong>ï¼šå¯ä½¿ç”¨ tus.io æ–·é»çºŒå‚³å”è­°ï¼Œå®¢æˆ¶ç«¯è¨˜éŒ„ä¸Šå‚³åç§»é‡ï¼Œæ–·ç·šå¾Œå¾ä¸Šæ¬¡ä½ç½®ç¹¼çºŒ</li>
        <li><strong>è½‰ç¢¼å¤±æ•—</strong>ï¼šProcessing Queue æä¾› at-least-once æŠ•éä¿è­‰ï¼Œå¤±æ•—ä»»å‹™è‡ªå‹•é‡è©¦ 3 æ¬¡å¾Œé€²å…¥ DLQ</li>
        <li><strong>å†ªç­‰æ€§</strong>ï¼šæ¯å€‹è½‰ç¢¼ä»»å‹™æœ‰å”¯ä¸€ job_idï¼ŒEncoder æ”¶åˆ°é‡è¤‡ä»»å‹™æ™‚æª¢æŸ¥ S3 æ˜¯å¦å·²æœ‰è¼¸å‡º</li>
      </ul>
    </div>
  </div>

  <!-- Q3 -->
  <div class="dd-accordion" onclick="this.classList.toggle('open')">
    <button class="dd-accordion-header">
      <span>Q3ï¼šå¦‚ä½•ç¢ºä¿å½±ç‰‡åœ¨è½‰ç¢¼å®Œæˆå‰ä¸è¢«ç”¨æˆ¶çœ‹åˆ°ï¼Ÿ</span>
      <span class="dd-accordion-chevron">â–¼</span>
    </button>
    <div class="dd-accordion-body">
      <p>ä½¿ç”¨<strong>ç‹€æ…‹æ©Ÿæ¨¡å‹</strong>ç®¡ç†å½±ç‰‡ç”Ÿå‘½é€±æœŸï¼š</p>
      <ul>
        <li>å½±ç‰‡å»ºç«‹æ™‚ status = <code>processing</code>ï¼Œå‰ç«¯ä¸é¡¯ç¤ºæ­¤ç‹€æ…‹çš„å½±ç‰‡</li>
        <li>æ‰€æœ‰è§£æåº¦è½‰ç¢¼å®Œæˆå¾Œï¼ŒEncoder æ›´æ–° status = <code>ready</code>ï¼ŒåŒæ™‚è¨­å®š manifest_url</li>
        <li>Search Service çš„ Elasticsearch æŸ¥è©¢éæ¿¾ <code>status: ready</code>ï¼Œç¢ºä¿æœå°‹çµæœåªå«å¯æ’­æ”¾å½±ç‰‡</li>
        <li>View Video Service åœ¨å›å‚³å‰æª¢æŸ¥ statusï¼Œè‹¥é ready å‰‡å›å‚³ 404 æˆ– "processing" ç‹€æ…‹é </li>
      </ul>
      <div class="dd-info tip">
        <strong>ğŸ’¡ é€²éš</strong>
        å¯ä»¥åšã€Œæ¼¸é€²å¼ç™¼å¸ƒã€ï¼š720p å…ˆå¥½å°±å…ˆè®“éƒ¨åˆ†ç”¨æˆ¶è§€çœ‹ï¼Œå¾ŒçºŒè§£æåº¦é™¸çºŒåŠ å…¥ã€‚manifest å‹•æ…‹æ›´æ–°å¯ç”¨è§£æåº¦åˆ—è¡¨ã€‚
      </div>
    </div>
  </div>

  <!-- Q4 -->
  <div class="dd-accordion" onclick="this.classList.toggle('open')">
    <button class="dd-accordion-header">
      <span>Q4ï¼šCDN cache hit rate ä½æ€éº¼è¾¦ï¼Ÿå¦‚ä½•å„ªåŒ–ï¼Ÿ</span>
      <span class="dd-accordion-chevron">â–¼</span>
    </button>
    <div class="dd-accordion-body">
      <p>CDN hit rate ä½æ„å‘³è‘—å¤§é‡è«‹æ±‚å›æº S3ï¼Œå»¶é²å¢åŠ ä¸”è²»ç”¨æš´å¢ã€‚å„ªåŒ–ç­–ç•¥ï¼š</p>
      <ul>
        <li><strong>é•·å°¾åˆ†æ</strong>ï¼š80% æµé‡é›†ä¸­åœ¨ 20% ç†±é–€å½±ç‰‡ï¼Œç¢ºä¿é€™äº›å½±ç‰‡å¸¸é§ CDN cache</li>
        <li><strong>é ç†±ï¼ˆPre-warmingï¼‰</strong>ï¼šæ–°ç™¼å¸ƒçš„å¤§å‹å½±ç‰‡æå‰æ¨é€åˆ°å„åœ° CDN edge</li>
        <li><strong>Multi-tier CDN</strong>ï¼šåœ¨ edge ä¹‹å¤–è¨­ç½® mid-tier cacheï¼ˆRegional Cacheï¼‰ï¼Œæ¸›å°‘å›æº</li>
        <li><strong>ä¸€è‡´çš„ URL çµæ§‹</strong>ï¼šé¿å… URL ä¸­åŒ…å«æ™‚é–“æˆ³æˆ–éš¨æ©Ÿ tokenï¼Œå¦å‰‡æ¯æ¬¡ URL ä¸åŒæœƒé€ æˆ cache miss</li>
        <li><strong>Segment ç²’åº¦</strong>ï¼šè¼ƒé•·çš„ segmentï¼ˆ10s vs 2sï¼‰æ„å‘³è‘—æ›´å°‘çš„ cache keyï¼Œhit rate æå‡</li>
      </ul>
    </div>
  </div>

  <!-- Q5 -->
  <div class="dd-accordion" onclick="this.classList.toggle('open')">
    <button class="dd-accordion-header">
      <span>Q5ï¼šå¦‚ä½•è™•ç†è§€çœ‹æ¬¡æ•¸çš„é«˜é »æ›´æ–°ï¼Ÿæ¯æ¬¡è§€çœ‹éƒ½å¯« DB å—ï¼Ÿ</span>
      <span class="dd-accordion-chevron">â–¼</span>
    </button>
    <div class="dd-accordion-body">
      <p>è§€çœ‹æ¬¡æ•¸æ˜¯<strong>å¯«å…¥æœ€é »ç¹</strong>çš„æ¬„ä½ï¼Œç›´æ¥å¯« DB æœƒæˆç‚ºç“¶é ¸ã€‚åˆ†å±¤æ–¹æ¡ˆï¼š</p>
      <ul>
        <li><strong>Redis INCR</strong>ï¼šæ¯æ¬¡è§€çœ‹å…ˆåœ¨ Redis åšåŸå­æ€§ incrementï¼ˆO(1), å¾®ç§’ç´šï¼‰</li>
        <li><strong>æ‰¹æ¬¡å¯«å› DB</strong>ï¼šèƒŒæ™¯ä»»å‹™æ¯ 5 åˆ†é˜å°‡ Redis ä¸­çš„ç´¯è¨ˆå€¼ batch update å› PostgreSQL</li>
        <li><strong>è¿‘ä¼¼è¨ˆæ•¸</strong>ï¼šå°å‰ç«¯é¡¯ç¤ºçš„è¨ˆæ•¸å¯ä½¿ç”¨è¿‘ä¼¼å€¼ï¼ˆå¦‚ "1.2M views"ï¼‰ï¼Œç„¡éœ€ç²¾ç¢ºåˆ°å€‹ä½</li>
        <li><strong>åˆ†æç®¡é“</strong>ï¼šè©³ç´°çš„è§€çœ‹äº‹ä»¶ï¼ˆå«ç”¨æˆ¶ IDã€è£ç½®ã€æ™‚é•·ï¼‰å¯«å…¥ Kafka â†’ è³‡æ–™å€‰å„²ï¼ˆRedshift / BigQueryï¼‰ï¼Œä¸ç¶“éä¸» DB</li>
      </ul>
      <div class="dd-info warning">
        <strong>âš ï¸ Warning</strong>
        Redis è‹¥æ•…éšœï¼Œæœƒéºå¤±æœªå¯«å› DB çš„è¨ˆæ•¸ã€‚è§£æ³•ï¼šRedis é–‹å•Ÿ AOF æŒä¹…åŒ–ï¼Œæˆ–åœ¨ Redis èˆ‡ DB ä¹‹é–“åŠ  Kafka ä½œç‚º WALã€‚å°æ–¼è§€çœ‹æ¬¡æ•¸é€™ç¨®éç²¾ç¢ºæ•¸æ“šï¼Œå°‘é‡éºå¤±é€šå¸¸å¯æ¥å—ã€‚
      </div>
    </div>
  </div>

  <!-- Q6 -->
  <div class="dd-accordion" onclick="this.classList.toggle('open')">
    <button class="dd-accordion-header">
      <span>Q6ï¼šå¦‚æœè¦æ”¯æ´å³æ™‚ç›´æ’­ä¸²æµï¼ˆLive Streamingï¼‰ï¼Œæ¶æ§‹éœ€è¦ä»€éº¼æ”¹å‹•ï¼Ÿ</span>
      <span class="dd-accordion-chevron">â–¼</span>
    </button>
    <div class="dd-accordion-body">
      <p>ç›´æ’­èˆ‡ VOD çš„æ ¸å¿ƒå·®ç•°æ˜¯<strong>å»¶é²è¦æ±‚</strong>ï¼ˆç§’ç´š vs åˆ†é˜ç´šï¼‰å’Œ<strong>è³‡æ–™æµæ–¹å‘</strong>ï¼ˆé‚Šç”¢ç”Ÿé‚Šæ’­æ”¾ï¼‰ï¼š</p>
      <ul>
        <li><strong>å³æ™‚è½‰ç¢¼</strong>ï¼šå–ä»£éåŒæ­¥ Queueï¼Œä½¿ç”¨ä¸²æµå¼è½‰ç¢¼å™¨ï¼ˆå¦‚ AWS MediaLiveï¼‰å³æ™‚å°‡ RTMP è¼¸å…¥è½‰ç‚º HLS/DASH</li>
        <li><strong>Ultra-low latency</strong>ï¼šä½¿ç”¨ LL-HLS æˆ– WebRTC å°‡å»¶é²é™åˆ° 2-5 ç§’ï¼ˆvs æ¨™æº– HLS çš„ 15-30 ç§’ï¼‰</li>
        <li><strong>CDN é…ç½®</strong>ï¼šmanifest TTL é™ä½åˆ° 1-2 ç§’ï¼Œsegment ç”¢ç”Ÿå¾Œç«‹å³æ¨åˆ° CDN edge</li>
        <li><strong>ç„¡ Video Splitter</strong>ï¼šç›´æ’­å…§å®¹ç›´æ¥å¾å³æ™‚è½‰ç¢¼å™¨ç”¢å‡º segmentï¼Œä¸éœ€å…ˆå„²å­˜å†åˆ‡å‰²</li>
        <li><strong>DVR åŠŸèƒ½</strong>ï¼šå°‡ç›´æ’­ segment å³æ™‚å¯«å…¥ S3ï¼Œè§€çœ¾å¯å›çœ‹éå»çš„ç‰‡æ®µ</li>
      </ul>
    </div>
  </div>

  <!-- Q7 -->
  <div class="dd-accordion" onclick="this.classList.toggle('open')">
    <button class="dd-accordion-header">
      <span>Q7ï¼šå¦‚ä½•é˜²æ­¢æœªæˆæ¬Šçš„å½±ç‰‡ä¸‹è¼‰èˆ‡ç›œç‰ˆï¼Ÿ</span>
      <span class="dd-accordion-chevron">â–¼</span>
    </button>
    <div class="dd-accordion-body">
      <p>å¤šå±¤é˜²è­·ç­–ç•¥ï¼š</p>
      <ul>
        <li><strong>CDN Signed URL</strong>ï¼šæ¯å€‹æ’­æ”¾ URL å¸¶æœ‰æ™‚æ•ˆæ€§ç°½åï¼ˆ4 å°æ™‚éæœŸï¼‰ï¼ŒéæœŸå¾Œç„¡æ³•å­˜å–</li>
        <li><strong>DRMï¼ˆDigital Rights Managementï¼‰</strong>ï¼šä½¿ç”¨ Widevineï¼ˆAndroid/Chromeï¼‰+ FairPlayï¼ˆAppleï¼‰+ PlayReadyï¼ˆWindowsï¼‰ä¸‰é‡ DRM åŠ å¯†å½±ç‰‡ segment</li>
        <li><strong>Token ç¶å®š</strong>ï¼šSigned URL ç¶å®šç”¨æˆ¶ IP æˆ– sessionï¼Œé˜²æ­¢ URL åˆ†äº«</li>
        <li><strong>æµ®æ°´å°</strong>ï¼šæ¯å€‹ç”¨æˆ¶è§€çœ‹çš„ç‰ˆæœ¬åµŒå…¥ä¸å¯è¦‹çš„æ•¸ä½æµ®æ°´å°ï¼Œæ´©æ¼æ™‚å¯è¿½æº¯ä¾†æº</li>
        <li><strong>é€Ÿç‡é™åˆ¶</strong>ï¼šç›£æ§ç•°å¸¸ä¸‹è¼‰è¡Œç‚ºï¼ˆå¦‚çŸ­æ™‚é–“å¤§é‡ segment è«‹æ±‚ï¼‰ï¼Œè‡ªå‹•å°é–</li>
      </ul>
    </div>
  </div>

  <!-- Q8 -->
  <div class="dd-accordion" onclick="this.classList.toggle('open')">
    <button class="dd-accordion-header">
      <span>Q8ï¼šç³»çµ±ä¸­çš„å–®é»æ•…éšœï¼ˆSPOFï¼‰æœ‰å“ªäº›ï¼Ÿå¦‚ä½•æ¶ˆé™¤ï¼Ÿ</span>
      <span class="dd-accordion-chevron">â–¼</span>
    </button>
    <div class="dd-accordion-body">
      <p>é€ä¸€æª¢è¦–æ¯å€‹å…ƒä»¶çš„ HA ç­–ç•¥ï¼š</p>
      <ul>
        <li><strong>Load Balancer</strong>ï¼šä½¿ç”¨ AWS ALB/NLBï¼ˆå¤š AZ éƒ¨ç½²ï¼‰ï¼Œæˆ– DNS-based failover é…åˆå¤šå€‹ LB å¯¦ä¾‹</li>
        <li><strong>Services</strong>ï¼šæ‰€æœ‰æœå‹™è‡³å°‘ 2+ å¯¦ä¾‹ï¼Œè·¨ AZ éƒ¨ç½²ï¼Œç”± K8s / ECS è‡ªå‹•é‡å•Ÿå¤±æ•—å®¹å™¨</li>
        <li><strong>Processing Queue</strong>ï¼šKafka å¤š broker + 3x replication factorï¼›SQS æœ¬èº«ç‚ºå…¨è¨—ç®¡é«˜å¯ç”¨</li>
        <li><strong>Redis Cache</strong>ï¼šRedis Clusterï¼ˆ6 ç¯€é» = 3 master + 3 replicaï¼‰ï¼Œè‡ªå‹•æ•…éšœè½‰ç§»</li>
        <li><strong>Metadata DB</strong>ï¼šPostgreSQL Master + Sync Standbyï¼ˆåŒä¸€ AZ å…§åŒæ­¥è¤‡è£½ï¼‰+ Async Replicaï¼ˆè·¨ AZï¼‰</li>
        <li><strong>S3 / CDN</strong>ï¼šAWS åŸç”Ÿé«˜å¯ç”¨ï¼Œ11-9 æŒä¹…æ€§ï¼Œç„¡éœ€é¡å¤–é…ç½®</li>
      </ul>
    </div>
  </div>

</section>

</div><!-- end page-inner -->
</div><!-- end page-deepdive -->

<!-- ========== SCRIPTS ========== -->
<script>
function switchPage(page, btn) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  btn.classList.add('active');
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function switchFlow(flow, btn) {
  document.querySelectorAll('.flow-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.flow-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('flow-' + flow).classList.add('active');
  btn.classList.add('active');
}
</script>
</body>
</html>
